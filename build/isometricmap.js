(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["scene","spriteentity","entity","tilemanager"],function(e,n,r,i){var s;return s=function(e){function n(e){var t,r,s,o,u,a,f=this;this.tilew=e.tilew,this.tileh=e.tileh,this.nrows=e.rows,this.ncols=e.cols,this.tm=new i(this),this.tilew2prop=2/this.tilew,this.tileh2prop=2/this.tileh,this.tilew2=this.tilew/2,this.tileh2=this.tileh/2,this.map=[],this.translate_x=0,this.max_rows=this.nrows-1,this.max_cols=this.ncols-1,this.selected_tile=null,this.selected_tile_x=0,this.selected_tile_y=0,this.selected_tile_sprite=null,this.old_camx=0,this.on_exit_frame=null,this.supported_modes={"mode-default":function(){f.processMouseClick()},"mode-erase":function(){f.processMouseClick();if(f.clicked_layer==null||f.clicked_layer.animating)return;return f.clicked_layer.tween({attr:"h",from:0,to:100,duration:500}).tween({attr:"opacity",from:1,to:0,duration:700}).done(function(){return this.destroy()}),f.clicked_layer=null},"mode-place":function(){var e;e=f.tm.addTileLayerToHolder(f.tile_under_mouse,f.tm.newTileLayer(f.selected_tile),f.selected_tile.layer,f.selected_tile_x,f.selected_tile_y)}},this.camera_moved=!1,this.current_mode="mode-default",this.current_mode_clb=this.supported_modes[this.current_mode],e.cam_bounds=[this.tilew2,this.tileh2,this.ncols*this.tilew2,(this.nrows-.5)*this.tileh],Hal.log.debug("camera bounds: "+e.cam_bounds),n.__super__.constructor.call(this,e),this.iso_shape=[[-this.tilew2,0],[0,this.tileh2],[this.tilew2,0],[0,-this.tileh2]],this.display={startr:0,endr:0,startc:0,endc:0},this.info={row:"row: ",col:"col: ",tilename:"tile: ",start_row:"starting row: ",start_col:"starting col: ",end_row:"end row: ",end_col:"end_col: ",tile_x:"tile_x: ",tile_y:"tile_y: ",cam_mouse:"camera_mouse: "},this.mask=Hal.asm.getSprite("test/tilemask_128x64"),t=Hal.dom.createCanvas(this.tilew,this.tileh).getContext("2d"),t.drawImage(this.mask.img,0,0),this.mask_data=t.getImageData(0,0,this.tilew,this.tileh).data,a=this.mask_data;for(s=o=0,u=a.length;o<u;s=++o)r=a[s],this.mask_data[s]=r<120;this.over={green:Hal.asm.getSprite("test/grid_unit_over_green_128x64"),red:Hal.asm.getSprite("test/grid_unit_over_red_128x64")},this.last_clicked_layer=null,this.tile_under_mouse=null}return t(n,e),n.prototype.showRegion=function(e,t,n){var r,i,s,o,u,a,f,l;s=this.getTileAt(this.worldToLocal(e));if(s==null)return;u=s.row,o=s.col,o%2===0&&(t-=1),f=this.getTile(Hal.math.clamp(u-t,u,this.nrows-1),Hal.math.clamp(o-n,o,this.ncols-1)),i=this.getTile(Hal.math.clamp(u+t,u,this.nrows-1),Hal.math.clamp(o+n,o,this.ncols-1)),l=this.getTile(Hal.math.clamp(u-t,u,this.nrows-1),Hal.math.clamp(o+n,o,this.ncols-1)),r=this.getTile(Hal.math.clamp(u+t,u,this.nrows-1),Hal.math.clamp(o-n,o,this.ncols-1));if(f==null||l==null||r==null||i==null)return;return a=[f.x-(l.x-f.x),f.y-(i.y-f.y),(l.x-f.x)*2,(i.y-f.y)*2],this.g.strokeRect(a,"cyan")},n.prototype.drawStat=function(){return n.__super__.drawStat.call(this),this.tile_under_mouse!=null&&(Hal.glass.ctx.fillText(this.info.row+this.tile_under_mouse.row,0,195),Hal.glass.ctx.fillText(this.info.col+this.tile_under_mouse.col,0,210),Hal.glass.ctx.fillText(this.info.tile_x+this.tile_under_mouse.x,0,225),Hal.glass.ctx.fillText(this.info.tile_y+this.tile_under_mouse.y,0,240)),Hal.glass.ctx.fillText(this.info.start_row+this.display.startr,0,115),Hal.glass.ctx.fillText(this.info.start_col+this.display.startc,0,130),Hal.glass.ctx.fillText(this.info.end_row+this.display.endr,0,145),Hal.glass.ctx.fillText(this.info.end_col+this.display.endc,0,160),Hal.glass.ctx.fillText(this.info.cam_mouse+(""+(-this.camera.x+this.mpos[0]).toFixed(2)+", "+(-this.camera.y+this.mpos[1]).toFixed(2)),0,255)},n.prototype.init=function(){var e=this;return n.__super__.init.call(this),this.camera.on("CHANGE",function(){return e.calcDrawingArea()}),Hal.on("LEFT_CLICK",function(){return e.current_mode_clb()}),Hal.on("EDITOR_MODE_CHANGED",function(t){return e.current_mode=t,e.supported_modes[e.current_mode]?e.current_mode_clb=e.supported_modes[e.current_mode]:Hal.log.warn("Mode "+mode+" not supported"),Hal.log.debug(e.current_mode)}),Hal.on("TILE_LAYER_SELECTED",function(t){return Hal.log.debug("Tile layer selected from editor"),Hal.log.debug(t),e.selected_tile=t,e.selected_tile_sprite=Hal.asm.getSprite(e.selected_tile.sprite),e.selected_tile_x=e.selected_tile_sprite.w2-e.tilew2,e.selected_tile_y=e.selected_tile_sprite.h2-e.tileh2}),Hal.on("RIGHT_CLICK",function(t){if(e.paused)return;return e.camera.lerpTo(e.localToWorld(e.world_pos))}),Hal.on("MOUSE_MOVE",function(t){var n;n=e.getTileAt(e.worldToLocal(t));if(n!==e.tile_under_mouse){e.tile_under_mouse&&(e.tile_under_mouse.attr("line_width",1),e.tile_under_mouse.attr("glow",!1),e.tile_under_mouse.attr("draw_shape",!1)),e.tile_under_mouse=n;if(n!=null)return n.attr("glow",!0),n.attr("draw_shape",!0),n.attr("stroke_color","white"),Hal.tween(n,"line_width",400,1,3.5,1)}}),this.initMap()},n.prototype.calcDrawingArea=function(){var e,t,n;return this.old_camx=this.camera.x,this.camera.x%this.tilew2===0&&(Hal.log.debug("oh jea"),this.camera_moved=!0),n=this.getTileAt(this.worldToLocal([0,0])),n==null?(e=0,t=0):(e=n.col,t=n.row),this.display={startc:e,endr:this.maxRows(),startr:t,endc:this.maxCols()}},n.prototype.maxRows=function(){return Math.min(this.nrows-1,Math.round(this.bounds[3]/(this.tileh*this.camera.zoom)+4))},n.prototype.maxCols=function(){return Math.min(this.ncols-1,Math.round(this.bounds[2]/(this.tilew2*this.camera.zoom)+4))},n.prototype.toOrtho=function(e){var t,n,r,i,s;return t=(e[0]+this.tilew2)*this.tilew2prop,i=(e[1]+this.tileh2)*this.tileh2prop,n=~~(e[0]+this.tilew2-~~(t*.5)*this.tilew),r=~~(e[1]+this.tileh2-~~(i*.5)*this.tileh),s=this.mask_data[(n+this.tilew*r)*4+3],[t-(s^!(t&1)),(i-(s^!(i&1)))/2]},n.prototype.getTile=function(e,t,n){return n==null&&(n=[0,0]),this.map[t+n[1]+(e+n[0])*this.ncols]},n.prototype.getTileAt=function(e){var t;return t=this.toOrtho(e),t[0]<0||t[1]<0||t[1]>=this.nrows||t[0]>=this.ncols?null:this.map[Math.floor(t[0])+Math.floor(t[1])*this.ncols]},n.prototype.initMap=function(){var e,t,n,r,i,s,o,u,a,f,l,c;this.clicked_layer=null,Hal.log.debug("max rows: "+this.maxRows()),Hal.log.debug("max cols: "+this.maxCols()),Hal.log.debug("total at this resolution: "+this.maxRows()*this.maxCols()),this.max_rows=this.maxRows(),this.max_cols=this.maxCols(),this.map=new Array(this.nrows*this.ncols),n=0,i=performance.now();for(e=a=0,l=this.nrows-1;0<=l?a<=l:a>=l;e=0<=l?++a:--a)for(t=f=0,c=this.ncols-1;0<=c?f<=c:f>=c;t=0<=c?++f:--f)o=t/2*this.tilew,u=(e+t%2/2)*this.tileh,r=this.tm.newTileHolder({shape:this.iso_shape,draw_shape:!1,x:o,y:u,row:e,col:t,visible_sprite:!0,sprite:"test/grid_unit_128x64"}),this.map[n]=this.addEntityToQuadspace(r),n++;return s=performance.now()-i,Hal.log.debug("it took: "+i),this.calcDrawingArea(),this.camera.trigger("CHANGE")},n.prototype.processMouseClick=function(){var e,t,n,r;this.clicked_layer!=null&&(this.clicked_layer.trigger("DESELECTED"),this.clicked_layer=null),r=this.quadspace.searchInRange(this.world_pos,this.search_range,this);for(t=0,n=r.length;t<n;t++){e=r[t];if(!e.inShapeBounds(this.world_pos))continue;Hal.log.debug(e),this.clicked_layer==null?this.clicked_layer=e:e.parent.col===this.clicked_layer.parent.col&&e.parent.row===this.clicked_layer.parent.row?e.layer>this.clicked_layer.layer&&(this.clicked_layer=e):e.parent.row===this.clicked_layer.parent.row?e.h+e.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=e):e.parent.col===this.clicked_layer.parent.col?e.h+e.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=e):e.parent.col!==this.clicked_layer.parent.col&&e.parent.row!==this.clicked_layer.parent.row&&e.h+e.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=e)}if(this.clicked_layer!=null)return Hal.log.debug("clicked layer"),Hal.log.debug(this.clicked_layer),this.trigger("LAYER_SELECTED",this.clicked_layer),this.clicked_layer.trigger("LEFT_CLICK")},n.prototype.splitMap=function(){var e;return e={nw:null,ns:null,s:null,w:null,e:null,n:null,sw:null,se:null,c:null}},n.prototype.loadRandomMap=function(e,t){var n,r,i,s,o,u;u=[];for(e=s=0,o=this.ncols-1;0<=o?s<=o:s>=o;e=0<=o?++s:--s)u.push(function(){var t,s,o;o=[];for(n=t=0,s=this.nrows-1;0<=s?t<=s:t>=s;n=0<=s?++t:--t)i=this.getTile(e,n),r=5,o.push(function(){var e;e=[];while(r>0&&!i.isFull())this.addRandomLayer(i),e.push(--r);return e}.call(this));return o}.call(this));return u},n.prototype.addRandomLayer=function(e){var t,n,r,i,s,o,u;return u=Object.keys(this.tmngr.Tiles),r=~~(Math.random()*u.length),t=u[r],s=amj.tmngr.Tiles[t],o=Object.keys(s),n=~~(Math.random()*o.length),t=o[n],i=s[t]},n.prototype.genRandomMap=function(){},n}(e),s})}).call(this);