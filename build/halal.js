(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["loglevel","eventdispatcher","scene","dommanager","renderer","mathutil","vec2","deferred","deferredcounter","domeventmanager","assetmanager","imgutils","entity","spriteentity","isometricmap","ajax"],function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g,y,b,w,E,S,x,T,N,C,k,L,A;return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1)}}(),window.performance==null&&(window.performance=Date),b=performance.now(),w=0,T=1,y=0,x=0,C=0,L=0,S=30,N=1/S,E=null,k=!0,A=function(){var e,t,n,r;L=b,b=performance.now(),w=(b-L)*.001,y+=w,w=Math.min(w,N),Hal.trigger("ENTER_FRAME",w),r=Hal.scenes;for(t=0,n=r.length;t<n;t++)e=r[t],e.update_(w),e.draw_(w);return y>=T&&(Hal.fps=x,y=0,x=0,Hal.trigger("FPS_UPDATE",Hal.fps)),Hal.trigger("EXIT_FRAME",w),C=requestAnimFrame(A),x++},g=function(e){function n(){n.__super__.constructor.call(this),this.dom=new i(this),this.id=0,this.debug_mode=!1,this.pressed_keys=[],this.scenes=[],this.fps=0,this.log.debug("Engine constructed")}return t(n,e),n}(n),g.prototype.addScene=function(e){return e instanceof r?e.bounds?(e.name||(this.log.warn("Name for scene wasn't provided"),e.name="#scene_"+e.id),e.init(),Hal.trigger("SCENE_ADDED_"+e.name.toUpperCase(),e),this.scenes.unshift(e),this.log.debug("Added scene: "+e.name),e):(this.log.error("Bounds not set on scene "+e.name),null):(this.log.error("Not a Scene instance"),null)},g.prototype.pause=function(){return cancelAnimationFrame(C),k=!0,this.trigger("ENGINE_PAUSED")},g.prototype.resume=function(){return k=!1,A(),this.trigger("ENGINE_RESUMED")},g.prototype.viewportBounds=function(){return[0,0,this.dom.area.width,this.dom.area.height]},g.prototype.supports=function(e){return this.trigger("SUPPORTS_"+e)},g.prototype.init=function(){return this.evm=new l,this.glass=new s(this.viewportBounds(),null,11),this.on("MOUSE_MOVE",function(e){var t,n,r,i,s;i=this.scenes,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.mpos=e,s.push(t.world_pos=t.worldToLocal(e));return s}),this.on("DESTROY_SCENE",function(e){var t;return t=this.scenes.indexOf(e),t===-1&&log.error("No such scene: "+e.name),this.scenes[t]=null,this.scenes.splice(t,1)}),this.log.debug("Engine initialized")},g.prototype.start=function(){return this.init(),k=!1,this.trigger("ENGINE_STARTED"),Hal.log.debug("Engine started"),A()},g.prototype.isPaused=function(){return k},g.prototype.debug=function(e){return this.debug_mode=e,Hal.trigger("DEBUG_MODE",this.debug_mode)},g.prototype.ID=function(){return++this.id},g.prototype.drawInfo=function(){return this.glass.ctx.setTransform(1,0,0,1,0,0),this.glass.ctx.fillStyle="black",this.glass.ctx.fillText("FPS: "+this.fps,0,10)},g.prototype.tween=function(e,t,n,r,i,s){var o,u,f,l,c;return s==null&&(s=1),f=new a,n*=.001,u=0,l=(i-r)/n,c=r,Hal.on("ENTER_FRAME",o=function(a){u+=a,c+=l*a,e.attr(t,c),e.requestUpdate(),u=Math.min(u,n);if(n===u){s--,e.attr(t,i),e.requestUpdate();if(s!==0)return u=0,c=r;f.resolve(e),Hal.remove("ENTER_FRAME",o)}}),f.promise()},g.prototype.tweenF=function(e,t,n,r,i){var s,o,u,a;i==null&&(i=1),e*=.001,o=0,u=(r-n)/e,a=n,Hal.on("ENTER_FRAME",s=function(f){o+=f,a+=u*f,t(a,f),o=Math.min(o,e);if(e===o){i--,t(r,f);if(i!==0)return o=0,a=n;Hal.remove("ENTER_FRAME",s)}})},g.prototype.fadeInViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},0,1)},g.prototype.fadeOutViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},1,0)},g.prototype.IsometricMap=function(e){return new v(e)},g.prototype.Keys={SHIFT:16,G:71,D:68,W:87,C:67,I:73,ONE:49,TWO:50,THREE:51,FOUR:52,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,F:70},g.prototype.math=o,g.prototype.asm=new c,g.prototype.im=new h,g.prototype.log=e,g.prototype.Scene=r,g.prototype.Entity=p,g.prototype.SpriteEntity=d,g.prototype.Ajax=m,window.Hal=new g})}).call(this);