(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["loglevel","eventdispatcher","scene","dommanager","renderer","mathutil","vec2","deferred","deferredcounter","domeventmanager","assetmanager","imgutils","entity","spriteentity","isometricmap"],function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m,g,y,b,w,E,S,x,T,N,C,k,L;return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1)}}(),window.performance==null&&(window.performance=Date),y=performance.now(),b=0,x=1,g=0,S=0,N=0,k=0,E=30,T=1/E,w=null,C=!0,L=function(){var e,t,n,r;k=y,y=performance.now(),b=(y-k)*.001,g+=b,b=Math.min(b,T),Hal.trigger("ENTER_FRAME",b),r=Hal.scenes;for(t=0,n=r.length;t<n;t++)e=r[t],e.update(b),e.draw(b);return g>=x&&(Hal.fps=S,g=0,S=0,Hal.trigger("FPS_UPDATE",Hal.fps)),Hal.trigger("EXIT_FRAME",b),N=requestAnimFrame(L),S++},m=function(n){function r(){r.__super__.constructor.call(this),this.dom=new i(this),this.math=o,this.id=0,this.debug_mode=!1,this.pressed_keys=[],this.scenes=[],this.fps=0,e.debug("Engine constructed")}return t(r,n),r}(n),m.prototype.addScene=function(t){return t instanceof r?t.bounds?(t.name||(e.warn("Name for scene wasn't provided"),t.name="#scene_"+t.id),t.init(),Hal.trigger("SCENE_ADDED_"+t.name.toUpperCase(),t),this.scenes.unshift(t),e.debug("Added scene: "+t.name),t):(e.error("Bounds not set on scene "+t.name),null):(e.error("Not a Scene instance"),null)},m.prototype.pause=function(){return cancelAnimationFrame(N),C=!0,this.trigger("ENGINE_PAUSED")},m.prototype.resume=function(){return C=!1,L(),this.trigger("ENGINE_RESUMED")},m.prototype.viewportBounds=function(){return[0,0,this.dom.area.width,this.dom.area.height]},m.prototype.supports=function(e){return this.trigger("SUPPORTS_"+e)},m.prototype.init=function(){return this.evm=new l,this.on("MOUSE_MOVE",function(e){var t,n,r,i,s;i=this.scenes,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.mpos=e,s.push(t.world_pos=t.worldToLocal(e));return s}),this.on("DESTROY_SCENE",function(t){var n;return n=this.scenes.indexOf(t),n===-1&&e.error("No such scene: "+t.name),this.scenes[n]=null,this.scenes.splice(n,1)}),e.debug("Engine initialized")},m.prototype.start=function(){return this.init(),C=!1,this.trigger("ENGINE_STARTED"),e.debug("Engine started"),L()},m.prototype.isPaused=function(){return C},m.prototype.debug=function(e){this.debug_mode=e},m.prototype.ID=function(){return++this.id},m.prototype.drawInfo=function(){return this.glass.ctx.setTransform(1,0,0,1,0,0),this.glass.ctx.fillStyle="black",this.glass.ctx.fillText("FPS: "+this.fps,0,10)},m.prototype.tween=function(e,t,n,r,i,s){var o,u,f,l,c;return s==null&&(s=1),f=new a,n*=.001,u=0,l=(i-r)/n,c=r,Hal.on("ENTER_FRAME",o=function(a){u+=a,c+=l*a,e.attr(t,c),u=Math.min(u,n);if(n===u){s--,e.attr(t,i);if(s!==0)return u=0,c=r;f.resolve(e),Hal.remove("ENTER_FRAME",o)}}),f.promise()},m.prototype.tweenF=function(e,t,n,r,i){var s,o,u,a;i==null&&(i=1),e*=.001,o=0,u=(r-n)/e,a=n,Hal.on("ENTER_FRAME",s=function(f){o+=f,a+=u*f,t(a,f),o=Math.min(o,e);if(e===o){i--,t(r,f);if(i!==0)return o=0,a=n;Hal.remove("ENTER_FRAME",s)}})},m.prototype.fadeInViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},0,1)},m.prototype.fadeOutViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},1,0)},m.prototype.IsometricMap=function(e){return new v(e)},m.prototype.Keys={SHIFT:16,G:71,D:68,W:87,C:67,I:73,ONE:49,TWO:50,THREE:51,FOUR:52,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,F:70},window.Hal=new m,window.Hal.glass=new s(Hal.viewportBounds(),null,11),window.Hal.asm=new c,window.Hal.im=new h,window.log=e,window.Hal})}).call(this);