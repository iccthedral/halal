(function(){define("logger",[],function(){var e;return e={report:{info:[],error:[],debug:[],warning:[]},levels:{DEBUG:function(){return window.llogi=function(e){return console.info.call(console,e)},window.lloge=function(e){return console.error.call(console,e)},window.llogd=function(e){return console.debug.call(console,e)},window.llogw=function(e){return console.warn.call(console,e)}},SILENT:function(){return window.llogi=function(t){return e.log_report("info",t)},window.lloge=function(t){return e.log_report("error",t)},window.llogd=function(t){return e.log_report("debug",t)},window.llogw=function(t){return e.log_report("warning",t)}}},log_report:function(t,n){return e.report[t].push("Time: "+(new Date).toTimeString()+", Line: "+(new Error).lineNumber+", MSG: "+n)},setLevel:function(t){var n;return n=t,e.levels[t].call()}},e.setLevel("DEBUG"),window.llog=e})}).call(this),function(){define("eventdispatcher",[],function(){var e;return e=function(){function e(){this.listeners={}}return e}(),e.prototype.on=function(e,t){var n,r,i,s;if(e instanceof Array)for(i=0,s=e.length;i<s;i++)r=e[i],this.listeners[r]==null&&(this.listeners[r]=[]),this.listeners[r].push(t);else this.listeners[e]==null&&(this.listeners[e]=[]),this.listeners[e].push(t),n=this.listeners[e].indexOf(t);return t},e.prototype.removeTrigger=function(e,t){var n;if(this.listeners[e]!=null)return n=this.listeners[e].indexOf(t),n!==-1&&n!==-1&&this.listeners[e].splice(n,1),t=null},e.prototype.removeAllTriggers=function(e){var t,n,r,i,s,o;if(e)return delete this.listeners[e];n=Object.keys(this.listeners),o=[];for(i=0,s=n.length;i<s;i++)t=n[i],o.push(function(){var e,n,i,s;i=this.listeners[t],s=[];for(e=0,n=i.length;e<n;e++)r=i[e],s.push(this.removeTrigger(t,r));return s}.call(this));return o},e.prototype.trigger=function(e,t,n,r){var i,s,o,u,a;if(!this.listeners[e])return;u=this.listeners[e],a=[];for(s=0,o=u.length;s<o;s++)i=u[s],i!=null?a.push(i.call(this,t,n,r)):a.push(void 0);return a},e})}.call(this),function(){var e=[].slice;define("deferred",[],function(){var t,n;return n=function(){function e(){this.successChain=[],this.failChain=[]}return e.prototype.then=function(e){return this.successChain.push(e),this},e.prototype.fail=function(e){return this.failChain.push(e),this},e}(),t=function(){function t(e){this.prom=new n}return t.prototype.resolve=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.traverse_chain("successChain",n,t)},t.prototype.reject=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.traverse_chain("failChain",n,t)},t.prototype.promise=function(){return this.prom},t.prototype.traverse_chain=function(e,t,n){var r,i,s,o,u;t==null&&(t=this),o=this.prom[e],u=[];for(i=0,s=o.length;i<s;i++)r=o[i],u.push(r.apply(t,n));return u},t}(),t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;define("halalentity",["eventdispatcher","deferred"],function(e,r){var i,s,o,u,a;return s=function(){function e(e){this.obj=e,this.num_tweens=0,this.to_wait=0,this.tween_chain=[],this.animating=!1,this.clb_ids=[],this.done_clb=null,this.paused=!1}return e.prototype.tween=function(e){var t,n,r,i,s,o=this;return r=e.attr.match(/(.*)\[(\d)\]/),this.num_tweens++,this.to_wait<=0?(r!=null&&r.length===3&&(n=r[2],e.attr=r[1]),this.animating=!0,s=Hal.tween(this.obj,e.attr,e.duration,e.from,e.to,e.repeat,n),i=s[0],t=s[1],this.clb_ids.push(t),i.then(function(e){var t;t=o.clb_ids.indexOf(e),o.clb_ids.splice(t,1),o.num_tweens--,o.to_wait>0&&o.num_tweens!==0&&!o.paused&&(o.to_wait--,o.tween(o.tween_chain.pop()),o.num_tweens--),o.num_tweens<=0&&o.done_clb!=null&&!o.paused&&o.done_clb.call(o.obj);if(o.num_tweens<=0&&o.to_wait===0)return o.animating=!1}),this):(this.tween_chain.push(e),this)},e.prototype.isAnimating=function(){return this.animating},e.prototype.wait=function(e,t){return this.to_wait++,this},e.prototype.pause=function(){var e,t,n,r;this.paused=!0,r=this.clb_ids;for(t=0,n=r.length;t<n;t++)e=r[t],Hal.removeTrigger("ENTER_FRAME",e);return this},e.prototype.resume=function(){var e,t,n,r;this.paused=!1,r=this.clb_ids;for(t=0,n=r.length;t<n;t++)e=r[t],Hal.on("ENTER_FRAME",e);return this},e.prototype.stop=function(){var e,t,n,r;r=this.clb_ids;for(t=0,n=r.length;t<n;t++)e=r[t],Hal.removeTrigger("ENTER_FRAME",e);return this.clb_ids=[],this.num_tweens=0,this.to_wait=0,this.animating=!1,this.wait_clb=null,this.done_clb=null,this.tween_chain=[],this},e.prototype.done=function(e){return this.done_clb=e,this},e}(),u={},o={},i=function(e){function r(){return a=r.__super__.constructor.apply(this,arguments),a}return t(r,e),r.include=function(){var e,t,r,i,s,a;r=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.prototype.__classex__=this.name,r.prototype.constructor!=null&&(u[this.name]==null&&(u[this.name]=[]),u[this.name].push(r.prototype.constructor),r.prototype.destructor!=null&&(o[this.name]==null&&(o[this.name]=[]),o[this.name][r.prototype.constructor.name]=r.prototype.destructor));if(!r.prototype)throw"include(obj) requires obj";s=r.prototype,a=[];for(t in s){i=s[t];if(t==="constructor"||t==="destructor")continue;a.push(this.prototype[t]=i)}return a},r}(e),i.prototype.destructor=function(){var e,t,n;n=this.destructors;for(t in n)e=n[t],e.call(this)},i.prototype.constructor=function(){var e,t,n,r,s,a,f;this.destructors={},this.tweener=null,i.__super__.constructor.call(this);if(u[this.__classex__]){a=u[this.__classex__];for(r=0,s=a.length;r<s;r++)t=a[r],t.call(this)}if(o[this.__classex__]){f=o[this.__classex__];for(n in f)e=f[n],this.destructors[n]=e}return this},i.prototype.init=function(){return this.tweener=new s(this),this.id=Hal.ID(),this.initListeners(),this},i.prototype.attr=function(e,t,n){if(arguments.length===1){if(typeof e=="string")return this[e];this.extend(e)}else n!=null?this[e][n]=t:this[e]=t;return this.trigger("CHANGE",e,t),this},i.prototype.extend=function(e,t){var n,r;if(e==null)return this;for(n in e){r=e[n];if(this===r)continue;typeof r=="function"&&t?this.prototype[n]=r:this[n]=r}return this},i.prototype.destroy=function(){return this.tweener.stop(),this.destroyListeners(),this.destructor()},i.prototype.initListeners=function(){},i.prototype.destroyListeners=function(){this.removeAllTriggers()},i.prototype.tween=function(e){return this.tweener.stop(),this.tweener.tween(e),this.tweener},i})}.call(this),function(){define("renderer",[],function(){var e;return e=function(){function e(e,t,n,r){this.bounds=e,this.top_z=n,r==null&&(r=!1),this.canvases={},this.contexts=[],this.canvases[this.top_z]=Hal.dom.createCanvasLayer(this.bounds[2],this.bounds[3],this.top_z,r),Hal.dom.addCanvas(this.canvases[this.top_z],this.bounds[0],this.bounds[1]),this.ctx=this.canvases[this.top_z].getContext("2d")}return e}(),e.prototype.resize=function(e,t){var n,r,i,s;i=this.canvases,s=[];for(r in i)n=i[r],n.width=e,n.height=t,this.prev_bnds=this.bounds.slice(),this.bounds[2]=e,s.push(this.bounds[3]=t);return s},e.prototype.getLayerContext=function(e){var t;t=this.canvases[this.top_z+e];if(t!=null)return t.getContext("2d")},e.prototype.createLayers=function(e){var t,n,r,i;for(r=0,i=e.length;r<i;r++)n=e[r],t=this.top_z+n,console.log("layer: "+t),this.canvases[t]=Hal.dom.createCanvasLayer(this.bounds[2],this.bounds[3],t,!0),Hal.dom.addCanvas(this.canvases[t],this.bounds[0],this.bounds[1]),this.contexts.push(this.getLayerContext(t));return console.debug(this.sortLayers()),this.contexts},e.prototype.sortLayers=function(){var e,t,n,r;return this.contexts=this.contexts.sort(function(e,t){var n;return n=+e.canvas.style["z-index"]- +t.canvas.style["z-index"],console.debug("diff: "+n)})},e.prototype.removeLayer=function(e){return Hal.dom.removeCanvasLayer(e)},e.prototype.destroy=function(){var e,t,n,r;llogi("Destroying all canvases under renderer at "+this.top_z+": "),n=this.canvases,r=[];for(t in n)e=n[t],r.push(this.removeLayer(t));return r},e})}.call(this),function(){define("mathutil",[],function(){var e;return e={ARRAY_TYPE:typeof Float32Array!="undefined"?Float32Array:Array,TAU:Math.PI*2,EPSILON:1e-6,DEGREE:Math.PI/180,RADIAN:180/Math.PI},e.clamp=function(e,t,n){return e<t?e=t:e>n&&(e=n),e},e})}.call(this),function(){define("matrix3",["mathutil"],function(e){var t;return t={},t.create=function(){var t;return t=new e.ARRAY_TYPE(9),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},t.inverse=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;return n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p,d?(d=1/d,e[0]=c*d,e[1]=(-l*r+i*f)*d,e[2]=(u*r-i*o)*d,e[3]=h*d,e[4]=(l*n-i*a)*d,e[5]=(-u*n+i*s)*d,e[6]=p*d,e[7]=(-f*n+r*a)*d,e[8]=(o*n-r*s)*d,e):null},t.translate=function(t,n){var r;return r=new e.ARRAY_TYPE(9),r[0]=1,r[1]=0,r[2]=t,r[3]=0,r[4]=1,r[5]=n,r[6]=0,r[7]=0,r[8]=1,r},t.scale=function(e,t,n){return t==null&&(t=1),n==null&&(n=1),e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=n,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.rotate=function(t){var n;return n=new e.ARRAY_TYPE(9),n[0]=Math.cos(t),n[1]=-Math.sin(t),n[2]=0,n[3]=Math.sin(t),n[4]=Math.cos(t),n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},t.transpose=function(e,t){var n,r,i;return e===t?(n=t[1],r=t[2],i=t[5],e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=i):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e},t.clone=function(t){var n;return n=new e.ARRAY_TYPE(9),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n},t.copy=function(e){return out[0]=e[0],out[1]=e[1],out[2]=e[2],out[3]=e[3],out[4]=e[4],out[5]=e[5],out[6]=e[6],out[7]=e[7],out[8]=e[8],out},t.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.mul=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;return e=[],r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=n[0],p=n[1],d=n[2],v=n[3],m=n[4],g=n[5],y=n[6],b=n[7],w=n[8],e[0]=h*r+p*o+d*f,e[1]=h*i+p*u+d*l,e[2]=h*s+p*a+d*c,e[3]=v*r+m*o+g*f,e[4]=v*i+m*u+g*l,e[5]=v*s+m*a+g*c,e[6]=y*r+b*o+w*f,e[7]=y*i+b*u+w*l,e[8]=y*s+b*a+w*c,e},t})}.call(this),function(){define("vec2",["mathutil"],function(e){var t,n,r,i;n={},t=[],n.free=5e4,n.max=5e4,r=0;while(r<n.max)i=new e.ARRAY_TYPE(2),i[0]=0,i[1]=0,t.push(i),r++;return n.release=function(e){if(n.free>n.max){lloge("you released a vector which you didn't acquired");return}return n.free++,n.set(e,0,0),t.push(e)},n.acquire=function(){if(n.free<=0){lloge("no more vectors in pool");return}return n.free--,t.pop()},n.create=function(){return n.acquire()},n.newFrom=function(e){return i=n.acquire(),i[0]=e[0],i[1]=e[1],i},n.clone=function(e){return i=n.acquire(),i[0]=e[0],i[1]=e[1],i},n.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},n.from=function(e,t){return i=n.acquire(),i[0]=e,i[1]=t,i},n.set=function(e,t,n){return e[0]=t,e[1]=n,e},n.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},n.sub=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e},n.mul=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},n.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},n.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},n.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},n.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},n.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},n.addAndScale=function(e,t,n,r){return e[0]=(t[0]+n[0])*r,e[1]=(t[1]+n[1])*r,e},n.distance=function(e,t){var n,r;return n=t[0]-e[0],r=t[1]-e[1],Math.sqrt(n*n+r*r)},n.sqDistance=function(e,t){var n,r;return n=t[0]-e[0],r=t[1]-e[1],n*n+r*r},n.length=function(e){var t,n;return t=e[0],n=e[1],Math.sqrt(t*t+n*n)},n.sqLength=function(e){var t,n;return t=e[0],n=e[1],t*t+n*n},n.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},n.normalize=function(e,t){var n,r,i;return r=t[0],i=t[1],n=r*r+i*i,n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n),e},n.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},n.lerp=function(e,t,n,r){var i,s;return i=t[0],s=t[1],e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e},n.random=function(e,t){var n;return t==null&&(t=1),n=Math.random()*2*Math.PI,e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},n.transformMat3=function(e,t,n){return e[0]=n[0]*t[0]+n[1]*t[1]+n[2],e[1]=n[3]*t[0]+n[4]*t[1]+n[5],e},n.perpendicular=function(e,t){return e[0]=t[1],e[1]=-t[0],e},n.str=function(e){return"vec2("+e[0].toFixed(2)+", "+e[1].toFixed(2)+")"},n})}.call(this),function(){define("geometry",["vec2","matrix3","mathutil"],function(e,t,n){var r;return r=new Object,r.toDegrees=function(e){return e*n.RADIAN},r.toRadians=function(e){return e*n.DEGREE},r.angleOfPoint=function(e){var t;return t=Math.atan2(-e[1],e[0]),t<0&&(t+=Math.PI*2),t},r.angleOfLines=function(t,n){var r,i;return r=e.acquire(),i=e.acquire(),e.normalize(r,t),e.normalize(i,n),Math.acos(e.dot(r,i))},r.createRegularPolygon=function(t,r){var i,s,o,u,a,f,l;o=[],s=n.TAU/t,i=0;for(u=l=0;0<=t?l<t:l>t;u=0<=t?++l:--l)a=r*Math.cos(i),f=r*Math.sin(i),o.push(e.from(a,f)),i+=s;return o},r.createStarPolygon=function(t,n,r){var i,s,o,u,a,f,l;i=this.createRegularPolygon(n,t),o=i.length,f=e.acquire(),l=e.acquire(),u=e.acquire(),s=0;while(s<o)e.copy(f,i[s]),e.copy(l,i[(s+1)%o]),e.addAndScale(u,f,l,.5),a=e.acquire(),e.sub(a,l,f),e.perpendicular(f,a),e.normalize(l,f),e.scale(a,l,r),a[0]+=u[0],a[1]+=u[1],i.push(a),++s;return e.release(f),e.release(l),e.release(u),this.polygonSortVertices(i)},r.createPolygonFromRectangle=function(t,n){return[e.from(-t,-n),e.from(t,-n),e.from(t,n),e.from(-t,n)]},r.isPointInRectangle=function(e,t){return e[0]>=t[0]&&e[0]<=t[0]+t[2]&&e[1]>=t[1]&&e[1]<=t[1]+t[3]},r.isPointInCircle=function(e,t,n){var r,i,s;return i=e[0]-t[0]||0,s=e[1]-t[1]||0,r=Math.sqrt(i*i+s*s),r<n},r.isPointInPolygonDeprecated=function(t,r){var i,s,o,u,a,f;i=e.acquire(),e.set(i,-1e7,t[1]-n.EPSILON),s=t,o=0,a=r.length;for(u=f=0;0<=a?f<a:f>a;u=0<=a?++f:--f)this.lineIntersectsLine(i,s,r[u],r[(u+1)%a])&&o++;return e.release(i),o%2!==0},r.isPointInPolygon=function(e,t){var n,r,i,s,o,u,a;o=u=i=0,n=s=!1,r=t.length,o=r-1;for(u=a=0;0<=r?a<r:a>r;u=0<=r?++a:--a)i=this.isPointLeftOrRightOfLine(e,t[o],t[u]),i>0&&(s=!0),i<0&&(n=!0),o=u;return!n||!s},r.isPolygonConvex=function(e){var t,n,r,i,s,o,u,a;s=o=r,t=i=!1,n=e.length;if(n<=3)return!0;s=n-2,o=n-1;for(u=a=0;0<=n?a<n:a>n;u=0<=n?++a:--a)r=this.isPointLeftOrRightOfLine(e[u],e[s],e[o]),r>0&&(i=!0),r<0&&(t=!0),s=o,o=u;return!t||!i},r.isPointLeftOrRightOfLine=function(e,t,n){var r;return r=(n[1]-t[1])*e[0]-(n[0]-t[0])*e[1]+t[1]*n[0]-t[0]*n[1],r},r.rectangleContainsRectangle=function(e,t){return e[0]>=t[0]&&e[1]>=t[1]&&e[0]+e[2]<=t[0]+t[2]&&e[1]+e[3]<=t[1]+t[3]},r.rectangleContainsCircle=function(e,t,n){return!1},r.rectangleIntersectsRectangle=function(e,t){return e[0]<=t[0]+t[2]&&e[0]+e[2]>=t[0]&&e[1]<=t[1]+t[3]&&e[3]+e[1]>=t[1]},r.rectangleIntersectsOrContainsRectangle=function(e,t){return this.rectangleIntersectsRectangle(e,t)||this.rectangleContainsRectangle(e,t)||this.rectangleContainsRectangle(t,e)},r.rectangleIntersectsOrContainsCircle=function(e,t,n){return this.rectangleIntersectsCircle(e,t,n)||this.isPointInRectangle(t,e)},r.rectangleIntersectsCircle=function(e,t,n){return this.lineIntersectsCircle([[e[0],e[1]],[e[0]+e[2],e[1]]],t,n)||this.lineIntersectsCircle([[e[0]+e[2],e[1]],[e[0]+e[2],e[1]+e[3]]],t,n)||this.lineIntersectsCircle([[e[0]+e[2],e[1]+e[3]],[e[0],e[1]+e[3]]],t,n)||this.lineIntersectsCircle([[e[0],e[1]+e[3]],[e[0],e[1]]],t,n)},r.lineIntersectsLine=function(e,t,n,r){var i,s,o,u,a,f;return u=(e[1]-n[1])*(r[0]-n[0])-(e[0]-n[0])*(r[1]-n[1]),f=(e[1]-n[1])*(t[0]-e[0])-(e[0]-n[0])*(t[1]-e[1]),i=(t[0]-e[0])*(r[1]-n[1])-(t[1]-e[1])*(r[0]-n[0]),i===0?!1:(s=1/i,o=u*s,a=f*s,o>0&&o<1&&a>0&&a<1)},r.lineIntersectsPolygon=function(e,t,n){var r,i,s;i=n.length;for(r=s=0;0<=i?s<i:s>i;r=0<=i?++s:--s)if(this.lineIntersectsLine(e,t,n[r],n[(r+1)%i]))return!0;return!1},r.lineIntersectsCircle=function(e,t,n){var r;return r=this.perpendicularDistanceToLine(t,e[0],e[1]),r<n},r.polygonPointInHull=function(e){var t,n,r,i;n=e[0],t=e.length;for(r=i=1;1<=t?i<t:i>t;r=1<=t?++i:--i)if(r[0]>n[0]||r[0]===n[0]&&r[1]>n[1])n[0]=r[0],n[1]=r[1];return n},r.polygonSortVertices=function(t){var n,r,i,s,o,u,a,f,l,c,h,p;n=new Array,a=this.polygonMeanPoint(t),o=t.length;for(r=l=0;0<=o?l<o:l>o;r=0<=o?++l:--l)n[r]=this.angleOfPoint([t[r][0]-a[0],t[r][1]-a[1]]);s=new Array;for(r=c=0;0<=o?c<o:c>o;r=0<=o?++c:--c){f=n[r],u=r;while(u>0&&f>n[u-1])n[u]=n[u-1],s[u]=s[u-1],u--;n[u]=f,s[u]=r}for(r=h=0,p=s.length;h<p;r=++h)i=s[r],n[r]=t[i];return e.release(a),n},r.polygonConvexHull=function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;l=t.length;if(l<=3)return t;m=this.polygonMeanPoint(t),n=new Array;for(o=g=0;0<=l?g<l:g>l;o=0<=l?++g:--g)n[o]=this.angleOfPoint([t[o][0]-m[0],t[o][1]-m[1]]);a=0,p=t[0];for(o=y=1;1<=l?y<l:y>l;o=1<=l?++y:--y){d=t[o];if(d[0]>p[0]||d[0]===p[0]&&d[1]>p[1])p=d,a=o}v=new Array,h=new Array,s=f=u=0;for(o=b=1;1<=l?b<l:b>l;o=1<=l?++b:--b)if(n[o]<=n[s])h[o]=s,v[s]=o,s=o;else if(n[o]>=n[f])v[o]=f,h[f]=o,f=o;else{u=s;while(n[u]<n[o])u=h[u];h[o]=u,v[o]=v[u],h[v[u]]=o,v[u]=o}v[s]=f,h[f]=s,c=l,i=!1,o=a;for(;;){this.isPointLeftOrRightOfLine(t[h[h[o]]],t[o],t[h[o]])>=0?(c--,u=h[h[o]],h[o]=u,v[u]=o,o=v[o]):o=h[o],h[h[o]]===a&&(i=!0);if(!!i&&h[o]===a)break}r=[];for(o=w=0;0<=c?w<c:w>c;o=0<=c?++w:--w)r[o]=t[a],a=h[a];return e.release(m),r},r.polygonMeanPoint=function(t){var n,r,i,s,o;r=e.from(0,0),n=t.length;for(s=0,o=t.length;s<o;s++)i=t[s],r[0]+=i[0],r[1]+=i[1];return r[0]/=n,r[1]/=n,r},r.polygonArea=function(e){var t,n,r,i,s,o;r=e.length,t=0;for(n=o=0;0<=r?o<r:o>r;n=0<=r?++o:--o)i=e[n],s=e[(n+1)%r],t+=i[0]*s[1]-s[0]*i[1];return t*.5},r.transformPolygon=function(t,n){var r,i;i=t.length,r=0;while(r<i)e.release(t[r]),t[r]=this.transformPoint(t[r][0],t[r][1],n),++r;return t},r.transformPoint=function(t,n,r){var i,s;return i=e.acquire(),s=e.acquire(),e.set(i,t,n),e.transformMat3(s,i,r),e.release(i),s},r.transformRectangle=function(t,n){var r,i,s,o,u,a;o=[this.transformPoint(t[0],t[1],n),this.transformPoint(t[0],t[1]+t[3],n),this.transformPoint(t[0]+t[2],t[1],n),this.transformPoint(t[0]+t[2],t[1]+t[3],n)],s=o[0][0],u=o[0][0],a=o[0][1],r=o[0][1],i=1;while(i<4)o[i][0]<s?s=o[i][0]:o[i][0]>u&&(u=o[i][0]),o[i][1]<a?a=o[i][1]:o[i][1]>r&&(r=o[i][1]),++i;return e.release(o[0]),e.release(o[1]),e.release(o[2]),e.release(o[3]),o[0]=s,o[1]=a,o[2]=u-s,o[3]=r-a,o},r.polygonCentroidPoint=function(t){var n,r,i,s,o,u,a,f;r=e.from(0,0),o=t.length,n=this.polygonArea(t)*6;for(s=f=0;0<=o?f<o:f>o;s=0<=o?++f:--f)u=t[s],a=t[(s+1)%o],i=u[0]*a[1]-a[0]*u[1],r[0]+=(u[0]+a[0])*i,r[1]+=(u[1]+a[1])*i;return r[0]=r[0]/n,r[1]=r[1]/n,r},r.polygonIntersectsOrContainsPolygon=function(t,n,r,i){var s,o,u;return s=e.acquire(),o=e.acquire(),s[0]=0,s[1]=0,u=!1,e.transformMat3(o,s,i),e.transformMat3(s,o,r),u=this.isPointInPolygonDeprecated(s,t),e.release(s),e.release(o),u||this.polygonIntersectsPolygon(t,n,r,i)},r.polygonIntersectsPolygon=function(t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;a=t.length,f=n.length,h=e.acquire(),p=e.acquire(),d=e.acquire(),v=e.acquire(),g=!1;for(o=E=0;0<=a?E<a:E>a;o=0<=a?++E:--E){if(g)break;e.transformMat3(h,t[o],i),e.transformMat3(p,h,r),e.transformMat3(d,t[(o+1)%a],i),e.transformMat3(v,d,r);for(o=S=0;0<=f?S<f:S>f;o=0<=f?++S:--S){c=n[(o+1)%f],l=n[o],y=(p[1]-l[1])*(c[0]-l[0])-(p[0]-l[0])*(c[1]-l[1]),w=(p[1]-l[1])*(v[0]-p[0])-(p[0]-l[0])*(v[1]-p[1]),s=(v[0]-p[0])*(c[1]-l[1])-(v[1]-p[1])*(c[0]-l[0]);if(s===0)continue;u=1/s,m=y*u,b=w*u;if(g=m>=0&&m<=1&&b>=0&&b<=1)break}}return e.release(h),e.release(p),e.release(d),e.release(v),g},r.polygonMinkowskiSum=function(t,n,r){var i,s,o,u,a,f,l;r==null&&(r=1),o=[];for(u=0,f=t.length;u<f;u++){i=t[u];for(a=0,l=n.length;a<l;a++)s=n[a],o.push(e.from(i[0]+r*s[0],i[1]+r*s[1]))}return o},r.polygonBottomMostPoint=function(t){var n,r,i,s;r=e.from(Number.MAX_VALUE,Number.MAX_VALUE);for(i=0,s=t.length;i<s;i++)n=t[i],n[0]<r[0]&&(r[0]=n[0]),n[1]<r[1]&&(r[1]=n[1]);return r},r.polygonTopMostPoint=function(t){var n,r,i,s;r=e.from(Number.MIN_VALUE,Number.MIN_VALUE);for(i=0,s=t.length;i<s;i++)n=t[i],n[0]>r[0]&&(r[0]=n[0]),n[1]>r[1]&&(r[1]=n[1]);return r},r.projectPointOnLine=function(t,n,r){var i,s,o,u,a;return o=e.sub([],r,n),u=e.sub([],t,n),e.normalize(o,o),e.normalize(u,u),i=e.dot(u,o),s=e.distance(n,t),a=e.scale([],o,i*s),a=e.from(n[0]+a[0],n[1]+a[1]),a},r.perpendicularDistanceToLine=function(t,n,r){var i,s;return i=this.projectPointOnLine(t,n,r),s=e.distance(t,i),e.release(i),s},r.perpendicularDistanceToLineSegment=function(t,n,r){var i,s,o;return i=this.projectPointOnLine(t,n,r),o=e.distance(n,r),e.distance(n,i)>o||e.distance(r,i)>o?Number.NaN:(s=e.distance(t,i),e.release(i),s)},r.pointComparison=function(e,t,n){var r,i,s;return e[0]>=0&&t[0]<0?!0:e[0]===0&&t[0]===0?e[1]>t[1]:(s=(e[0]-n[0])*(t[1]-n[1])-(t[0]-n[0])*(e[1]-n[1]),s<0?!0:s>0?!1:(r=(e[0]-n[0])*(e[0]-n[0])+(e[1]-n[1])*(e[1]-n[1]),i=(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1]),r>i))},r})}.call(this),function(){define("quadtree",["vec2","geometry","matrix3"],function(e,t,n){var r,i,s;return s=0,i={},r=function(){function e(e,t,n){this.bounds=e,t==null&&(t=8),this.part=n!=null?n:!0,this.entities=[],this.nw=null,this.sw=null,this.ne=null,this.se=null,this.id=Hal.ID(),this.capacity_=t}return e.prototype.total=function(){return s},e.prototype.insert=function(e){if(!t.isPointInRectangle(e.position,this.bounds))return!1;if(this.entities.length<this.capacity_&&!i[e.id]||!this.part&&!i[e.id])return this.entities.push(e),i[e.id]=this,s++,!0;if(this.part){this.nw==null&&this.divide();if(this.nw.insert(e))return!0;if(this.ne.insert(e))return!0;if(this.sw.insert(e))return!0;if(this.se.insert(e))return!0}return!1},e.prototype.remove=function(e){var t;t=this.entities.indexOf(e);if(t===-1)return;return s--,delete i[e.id],this.entities.splice(t,1)},e.prototype.removeAll=function(){var e,t,n,r,i;r=this.entities.slice(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.remove(e));return i},e.prototype.findById=function(e){var t,n;return n=null,t=function(r){if(e===r.id)return n=r;if(n==null){r.nw!=null&&n==null&&t(r.nw),r.sw!=null&&n==null&&t(r.sw),r.ne!=null&&n==null&&t(r.ne);if(r.se!=null&&n==null)return t(r.se)}},t(this),n},e.prototype.findUnder=function(){var e,t,n;return e=[],n=this,t=function(n){e=e.concat(n.entities);if(n.nw!=null)return t(n.nw),t(n.ne),t(n.se),t(n.sw)},t(n),e},e.prototype.findQuadsInRectangle=function(e,n){var r,i;return i=t.transformRectangle(this.bounds,n),r=[],t.rectangleIntersectsOrContainsRectangle(e,i)?(r=[this],this.nw==null?r:(r=r.concat(this.nw.findQuadsInRectangle(e,n)),r=r.concat(this.ne.findQuadsInRectangle(e,n)),r=r.concat(this.sw.findQuadsInRectangle(e,n)),r=r.concat(this.se.findQuadsInRectangle(e,n)),r)):r},e.prototype.findEntitiesInRectangle=function(e,r,i){var s,o,u,a,f,l;u=t.transformRectangle(this.bounds,r);if(t.rectangleIntersectsOrContainsRectangle(e,u)){this.nw!=null&&(this.nw.findEntitiesInRectangle(e,r,i),this.ne.findEntitiesInRectangle(e,r,i),this.sw.findEntitiesInRectangle(e,r,i),this.se.findEntitiesInRectangle(e,r,i)),l=this.entities;for(a=0,f=l.length;a<f;a++){s=l[a],o=t.rectangleIntersectsOrContainsRectangle(t.transformRectangle(s._bbox,n.mul([],s.transform(),r)),e);if(!o)continue;i.push(s)}}return i.sort(function(e,t){return e.position[1]+e.sprite.h-(t.position[1]+t.sprite.h)})},e.prototype.divide=function(){var t,n;return n=this.bounds[2]*.5,t=this.bounds[3]*.5,this.nw=new e([this.bounds[0],this.bounds[1],n,t]),this.ne=new e([this.bounds[0]+n,this.bounds[1],n,t]),this.sw=new e([this.bounds[0],this.bounds[1]+t,n,t]),this.se=new e([this.bounds[0]+n,this.bounds[1]+t,n,t])},e}(),r.fromCache=function(e){return i[e]},r})}.call(this),function(){define("transformable",["vec2","matrix3"],function(e,t){var n;return n=function(){function n(){this.origin=e.from(0,0),this.scale=e.from(1,1),this.position=e.from(0,0),this.angle=0,this._transform=t.create(),this._inverse=t.create(),this._update_transform=!0,this._update_inverse=!0}return n}(),n.prototype.destructor=function(){return e.release(this.origin),e.release(this.scale),e.release(this.position)},n.prototype.setOrigin=function(t,n,r){return r==null&&(r=!0),r&&this.move(t-this.origin[0],n-this.origin[1]),e.set(this.origin,t,n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.setPosition=function(t,n){return e.set(this.position,t,n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.setScale=function(t,n){return e.set(this.scale,t,n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.setRotation=function(e){return this.angle=e,this.angle<0&&(this.angle+=Math.PI*2),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.rotate=function(e){return this.angle+=e,this.angle<0&&(this.angle+=Math.PI*2),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.move=function(t,n){return e.set(this.position,this.position[0]+t,this.position[1]+n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.transform=function(){return this._update_transform&&(this._transform[3]=-Math.sin(-this.angle)*this.scale[0],this._transform[0]=Math.cos(-this.angle)*this.scale[0],this._transform[1]=Math.sin(-this.angle)*this.scale[1],this._transform[4]=Math.cos(-this.angle)*this.scale[1],this._transform[2]=-this.origin[0]*this._transform[0]-this.origin[1]*this._transform[1]+this.position[0],this._transform[5]=-this.origin[0]*this._transform[3]-this.origin[1]*this._transform[4]+this.position[1],this._update_transform=!1),this._transform},n.prototype.calcTransform=function(){return this._update_transform&&(this._transform[3]=-Math.sin(-this.angle)*this.scale[0],this._transform[0]=Math.cos(-this.angle)*this.scale[0],this._transform[1]=Math.sin(-this.angle)*this.scale[1],this._transform[4]=Math.cos(-this.angle)*this.scale[1],this._transform[2]=-this.origin[0]*this._transform[0]-this.origin[1]*this._transform[1]+this.position[0],this._transform[5]=this.origin[0]*this._transform[3]-this.origin[1]*this._transform[4]+this.position[1],this._update_transform=!1),this._transform},n.prototype.combineTransform=function(e){return this._update_transform?(this.transform(),this._transform=t.mul([],this._transform,e),this._update_transform=!1,this._transform):this.transform()},n.prototype.inverseTransform=function(){return this._update_inverse&&(t.inverse(this._inverse,this._transform),this._update_inverse=!1),this._inverse},n})}.call(this),function(){define("groupy",["eventdispatcher"],function(e){var t;return t=function(){function e(){this.ent_groups={},this.group="default",this.on("ENTITY_DESTROYED",this.group_ent_destr=function(e){var t,n;t=this.ent_groups[e.group];if(t!=null)return n=t.indexOf(e),t.splice(n,1)}),this.on("ENTITY_ADDED",function(e){return this.trigger("GROUP_CHANGE",e)}),this.on("GROUP_CHANGE",function(e){var t,n;return t=this.ent_groups[e.group],t==null&&(t=this.ent_groups[e.group]=[]),n=t.indexOf(e),n!==-1?t.splice(n,1):t.push(e)})}return e.prototype.findGroup=function(e){return this.ent_groups[e]==null?[]:this.ent_groups[e].slice()},e}(),t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("scene",["halalentity","renderer","matrix3","quadtree","vec2","geometry","transformable","groupy"],function(e,r,i,s,o,u,a,f){var l,c;return c=["angle","scale","position","origin"],l=function(e){function l(e){return e==null&&(e={}),l.__super__.constructor.call(this),this.parseMeta(e),this.bounds=Hal.viewportBounds(),this.world_bounds=Hal.viewportBounds(),this.entities=[],this.ent_cache={},this.z=0,this.renderer=new r(this.bounds,null,this.z,!0),this.ctx=this.renderer.getLayerContext(this.z),this.draw_stat=!0,this.update_ents=!0,this.cam_move_vector=o.from(0,0),this.is_camera_panning=!1,this.camera_panning_point=[0,0],this.zoom_step=.05,this.camera_speed=2,this._update_zoom=!1,this.center=o.from(this.bounds[2]*.5,this.bounds[3]*.5),this.view_matrix=i.create(),this.camera_moved=!1,this.view_matrix[2]=this.center[0],this.view_matrix[5]=this.center[1],this.combineTransform(this.view_matrix),this.prev_pos=[this.position[0],this.position[1]],this.zoom_limits=[.3,2.3],this.visible_ents=[],this}return t(l,e),l.include(a),l.include(f),l.prototype.parseMeta=function(e){return this.name=e.name!=null?e.name:""+Hal.ID(),this.bg_color=e.bg_color!=null?e.bg_color:"white",this.draw_stat=e.draw_stat!=null?e.draw_stat:!0,this.world_bounds=e.world_bounds!=null?e.world_bounds:Hal.viewportBounds(),this.zoom_limits=e.zoom_limits!=null?e.zoom_limits:void 0},l.prototype.addEntity=function(e,t){t==null&&(t=this.ctx);if(e==null){lloge("Entity is null");return}return e.attr("ctx",t),e.attr("scene",this),this.entities.push(e),this.ent_cache[e.id]=e,this.trigger("ENTITY_ADDED",e),this.update_ents=!0,e.trigger("ON_SCENE"),e},l.prototype.addEntityToQuadSpace=function(e,t){return t==null&&(t=this.ctx),this.addEntity(e,t),this.quadtree.insert(e),e.trigger("IN_QUADSPACE"),e},l.prototype.drawStat=function(){return Hal.glass.ctx.clearRect(0,0,400,300),Hal.glass.ctx.fillText("FPS: "+Hal.fps,0,10),Hal.glass.ctx.fillText("Num of entities: "+this.entities.length,0,25),Hal.glass.ctx.fillText("Camera position: "+this.position[0].toFixed(2)+", "+this.position[1].toFixed(2),0,40),Hal.glass.ctx.fillText("Camera origin: "+this.origin[0].toFixed(2)+", "+this.origin[1].toFixed(2),0,55),Hal.glass.ctx.fillText("Num of visible entities: "+this.visible_ents.length,0,70),Hal.glass.ctx.fillText("Num of free pool vectors: "+o.free,0,85),Hal.glass.ctx.fillText("View origin: "+this.view_matrix[2].toFixed(2)+", "+this.view_matrix[5].toFixed(2),0,100),Hal.glass.ctx.fillText("View scale: "+this.view_matrix[0].toFixed(2)+", "+this.view_matrix[4].toFixed(2),0,115)},l.prototype.getAllEntities=function(){return this.entities.slice()},l.prototype.update=function(e){var t,n,r,i,s;this._update_transform&&(this.combineTransform(this.view_matrix),this.update_ents=!0),this.update_ents&&(this.visible_ents=[],this.quadtree.findEntitiesInRectangle(this.search_range,this._transform,this.visible_ents)),i=this.visible_ents,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.update(e));return s},l.prototype.checkForCollisions=function(){var e,t,n,r,i,s;i=this.entities,s=[];for(n=0,r=i.length;n<r;n++)e=i[n],s.push(function(){var n,r,i,s;i=this.entities,s=[];for(n=0,r=i.length;n<r;n++){t=i[n];if(e===t)continue;u.polygonIntersectsOrContainsPolygon(e._mesh,t._mesh,t.inverseTransform(),e.transform())?s.push(e.trigger("COLLISION_HAPPENED",t)):s.push(void 0)}return s}.call(this));return s},l.prototype.draw=function(e){var t,n,r,i;this.clearRenderers(),this.draw_stat&&this.drawStat(),i=this.visible_ents;for(n=0,r=i.length;n<r;n++)t=i[n],t.draw(e);return this.update_ents=!1},l.prototype.clearRenderers=function(){var e,t,n,r;r=this.renderer.contexts;for(t=0,n=r.length;t<n;t++)e=r[t],e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.bounds[2],this.bounds[3]);return this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle=this.bg_color,this.ctx.fillRect(0,0,this.bounds[2],this.bounds[3]),this.ctx.strokeRect(this.center[0]-1,this.center[1]-1,2,2)},l.prototype.pause=function(){return this.attr("paused",!0)},l.prototype.resume=function(){return this.attr("paused",!1)},l.prototype.removeEntity=function(e){var t,n;if(!this.ent_cache[e.id]){lloge("No such entity "+e.id+" in cache");return}t=this.entities.indexOf(e);if(t===-1){lloge("No such entity "+e.id+" in entity list");return}return(n=s.fromCache(e.id))!=null&&n.remove(e),delete this.ent_cache[e.id],this.trigger("ENTITY_DESTROYED",e),this.entities.splice(t,1),this.update_ents=!0},l.prototype.removeAllEntities=function(e){var t,n,r,i;e==null&&(e=!1),i=this.getAllEntities();for(n=0,r=i.length;n<r;n++)t=i[n],this.removeEntity(t)},l.prototype.removeEntityByID=function(e){var t;return t=this.ent_cache[e],t!=null?t.removeEntity(t):llogw("No such entity "+e+" in entity cache")},l.prototype.init=function(){return l.__super__.init.call(this),this.pause(),this.search_range=this.bounds.slice(),this.camera_panning_started=null,this.camera_panning_started=null,this.camera_panning_ended=null,this.camera_zoom_listener=null,this.camera_lerp_listener=null,this.camera_frame_listener=null,this.resize_listener=null,this.resetQuadTree(this.world_bounds),this.resume()},l.prototype.screenToWorld=function(e){return u.transformPoint(e[0],e[1],this.inverseTransform())},l.prototype.worldToScreen=function(e){return u.transformPoint(e[0],e[1],this.transform())},l.prototype.resetQuadTree=function(e){return this.quadtree!=null&&this.quadtree.removeAll(),this.quadtree=new s(e),this.quadtree.divide()},l.prototype.setWorldBounds=function(e){this.world_bounds=e,this.resetQuadTree(this.world_bounds)},l.prototype.setBounds=function(e){this.bounds=e},l.prototype.drawQuadTree=function(e){if(this.paused)return;this.ctx.textAlign="center",this.ctx.fillStyle="white",e.nw!=null&&(this.drawQuadTree(e.nw),this.ctx.strokeRect(e.nw.bounds[0],e.nw.bounds[1],e.nw.bounds[2],e.nw.bounds[3]),this.ctx.fillText(""+e.nw.id,e.nw.bounds[0]+e.nw.bounds[2]*.5,e.nw.bounds[1]+e.nw.bounds[3]*.5)),e.ne!=null&&(this.drawQuadTree(e.ne),this.ctx.strokeRect(e.ne.bounds[0],e.ne.bounds[1],e.ne.bounds[2],e.ne.bounds[3]),this.ctx.fillText(""+e.ne.id,e.ne.bounds[0]+e.ne.bounds[2]*.5,e.ne.bounds[1]+e.ne.bounds[3]*.5)),e.sw!=null&&(this.drawQuadTree(e.sw),this.ctx.strokeRect(e.sw.bounds[0],e.sw.bounds[1],e.sw.bounds[2],e.sw.bounds[3]),this.ctx.fillText(""+e.sw.id,e.sw.bounds[0]+e.sw.bounds[2]*.5,e.sw.bounds[1]+e.sw.bounds[3]*.5));if(e.se!=null)return this.drawQuadTree(e.se),this.ctx.strokeRect(e.se.bounds[0],e.se.bounds[1],e.se.bounds[2],e.se.bounds[3]),this.ctx.fillText(""+e.se.id,e.se.bounds[0]+e.se.bounds[2]*.5,e.se.bounds[1]+e.se.bounds[3]*.5)},l.prototype.disablePanning=function(){return Hal.removeTrigger("DRAG_STARTED",this.camera_panning_started),Hal.removeTrigger("DRAG_ENDED",this.camera_panning_ended),Hal.removeTrigger("MOUSE_MOVE",this.camera_panning_listener),this.camera_panning_listener=null,this.camera_panning_ended=null,this.camera_panning_started=null},l.prototype.enablePanning=function(){var e=this;this.camera_panning_listener==null&&(this.camera_panning_started=Hal.on("DRAG_STARTED",function(t){if(e.paused)return;e.is_camera_panning=!0,e.camera_panning_point[0]=t[0],e.camera_panning_point[1]=t[1],e.prev_pos=[e.position[0],e.position[1]],e._update_transform=!0,e._update_inverse=!0;if(e.camera_frame_listener)return Hal.removeTrigger("EXIT_FRAME",e.camera_frame_listener),e.camera_frame_listener=null})),this.camera_panning_ended==null&&(this.camera_panning_ended=Hal.on("DRAG_ENDED",function(t){return e.is_camera_panning=!1,e._update_transform=!0,e._update_inverse=!0}));if(this.camera_panning_listener==null)return this.camera_panning_listener=Hal.on("MOUSE_MOVE",function(t){if(e.paused)return;if(e.is_camera_panning)return e.position[0]=e.prev_pos[0]+(t[0]-e.camera_panning_point[0]),e.position[1]=e.prev_pos[1]+(t[1]-e.camera_panning_point[1]),e._update_transform=!0,e._update_inverse=!0})},l.prototype.destroy=function(){return this.pause(),o.release(this.center),o.release(this.cam_move_vector),this.removeAllEntities(),this.renderer.destroy(),this.quadtree.removeAll(),this.quadtree=null,this.renderer=null,Hal.trigger("SCENE_REQ_DESTROY",this),l.__super__.destroy.call(this)},l.prototype.destroyListeners=function(){return l.__super__.destroyListeners.call(this),Hal.removeTrigger("SCROLL",this.camera_zoom_listener),Hal.removeTrigger("MOUSE_MOVE",this.camera_panning_listener),Hal.removeTrigger("DRAG_STARTED",this.camera_panning_started),Hal.removeTrigger("DRAG_ENDED",this.camera_panning_ended),Hal.removeTrigger("RIGHT_CLICK",this.camera_lerp_listener),Hal.removeTrigger("RESIZE",this.resize_listener),Hal.removeTrigger("EXIT_FRAME",this.camera_frame_listener)},l.prototype.initListeners=function(){var e=this;return l.__super__.initListeners.call(this),this.on("CHANGE",function(e,t){if(this.paused)return;if(n.call(c,e)>=0)return this._update_transform=!0,this._update_inverse=!0}),this.on("ENTITY_REQ_DESTROYING",function(e){return this.removeEntity(e)}),this.resize_listener=Hal.on("RESIZE",function(t){return e.renderer.resize(t.width,t.height),e.bounds[2]=t.width,e.bounds[3]=t.height,e._update_transform=!0,e._update_inverse=!0,e.search_range=e.bounds.slice()}),this.camera_lerp_listener=Hal.on("RIGHT_CLICK",function(t){if(e.paused)return;return o.set(e.cam_move_vector,e.center[0]-t[0]+e.position[0],e.center[1]-t[1]+e.position[1]),e.camera_frame_listener&&(Hal.removeTrigger("EXIT_FRAME",e.camera_frame_listener),e.camera_frame_listener=null,e._update_transform=!0,e._update_inverse=!0),e.camera_frame_listener=Hal.on("EXIT_FRAME",function(t){return o.lerp(e.position,e.position,e.cam_move_vector,t*2),~~Math.abs(e.position[0]-e.cam_move_vector[0])+~~Math.abs(-e.position[1]+e.cam_move_vector[1])<2&&(Hal.removeTrigger("EXIT_FRAME",e.camera_frame_listener),e.camera_frame_listener=null),e._update_transform=!0,e._update_inverse=!0})}),this.camera_zoom_listener=Hal.on("SCROLL",function(t){if(e.paused)return;return t.down?(e.view_matrix[0]-=e.zoom_step,e.view_matrix[4]-=e.zoom_step):(e.view_matrix[0]+=e.zoom_step,e.view_matrix[4]+=e.zoom_step),e.view_matrix[0]=Hal.math.clamp(e.view_matrix[0],e.zoom_limits[0],e.zoom_limits[1]),e.view_matrix[4]=Hal.math.clamp(e.view_matrix[4],e.zoom_limits[0],e.zoom_limits[1]),e._update_transform=!0,e._update_inverse=!0})},l}(e),l})}.call(this),function(){var e=[].slice;define("dommanager",[],function(){var t;return t=function(){function t(t){var n=this;this.renderspace=document.getElementById("renderspace"),this.hud=document.getElementById("hud"),this.viewport=document.getElementById("viewport"),this.area=renderspace.getBoundingClientRect(),this.default_zindex=1e3,this.canvases={},this.in_fullscreen=!1,this.screen_w=window.screen.availWidth,this.screen_h=window.screen.availHeight,this.fullscreen_scale=[1,1],t.on("SUPPORTS_FULLSCREEN",function(){return document.body.mozRequestFullScreen||document.body.webkitRequestFullScreen||document.body.requestFullScreen}),t.on("FULLSCREEN_CHANGE",function(e){var r,i,s,o;if(e){t.r.resize(n.screen_w/n.fullscreen_scale[0],n.screen_h/n.fullscreen_scale[1]),s=n.canvases;for(i in s)r=s[i],r.setAttribute("style",(r.getAttribute("style")||"")+" "+"-webkit-transform: scale3d("+n.fullscreen_scale[0]+","+n.fullscreen_scale[1]+", 1.0); -webkit-transform-origin: 0 0 0;");return n.area=n.renderspace.getBoundingClientRect()}n.renderspace.style.width=""+t.r.prev_bounds[2]+"px",n.renderspace.style.height=""+t.r.prev_bounds[3]+"px",t.r.resize(t.r.prev_bounds[2],t.r.prev_bounds[3]),o=n.canvases;for(i in o)r=o[i],r.setAttribute("style",(r.getAttribute("style")||"")+" "+"-webkit-transform: scale3d(1.0, 1.0, 1.0); -webkit-transform-origin: 0 0 0;");return n.area=n.renderspace.getBoundingClientRect()}),t.on("DOM_ADD",function(){var t,r;r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[];if(r!=null)return r.apply({},[n.hud].concat(t))}),t.on("REQUEST_FULLSCREEN",function(e){if(!t.supports("FULLSCREEN")){log.warn("Fullscreen not supported");return}if(!n.in_fullscreen)return n.renderspace.style.width=""+n.screen_w+" + px",n.renderspace.style.height=""+n.screen_h+" + px",n.renderspace.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}),window.addEventListener("resize",function(){return n.area=n.renderspace.getBoundingClientRect(),n.screen_w=window.screen.availHeight,n.screen_h=window.screen.availHeight,t.trigger("RESIZE",n.area)}),document.addEventListener("fullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,t.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)}),document.addEventListener("webkitfullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,t.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)}),document.addEventListener("mozfullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,t.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)})}return t}(),t.prototype.createCanvas=function(e,t,n,r){var i,s;return e==null&&(e=this.area.width),t==null&&(t=this.area.height),s=this.default_zindex+n,i=document.createElement("canvas"),i.width=e,i.height=t,r?(i.style["background-color"]="transparent",i.style.background="transparent",console.log("it shall be transparent "+s)):i.style.background="white",i.style["z-index"]=s,i},t.prototype.createCanvasLayer=function(e,t,n,r){var i,s;return e==null&&(e=this.area.width),t==null&&(t=this.area.height),s=this.default_zindex+n,this.canvases[s]?this.canvases[s]:(i=this.createCanvas(e,t,n,r),i)},t.prototype.addCanvas=function(e,t,n){var r;t==null&&(t=0),n==null&&(n=0),r=e.style["z-index"],e.style.left=""+t+"px",e.style.top=""+n+"px";if(this.canvases[r]){llogw("Canvas with z-index of "+r+" already exists");return}return this.canvases[r]=e,this.viewport.appendChild(e),e},t.prototype.removeCanvasLayer=function(e){var t;return t=this.default_zindex+ +e,llogi("Removing canvas layer at z-index: "+t+" / "+e),this.viewport.removeChild(this.canvases[t]),delete this.canvases[t]},t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;define("deferredcounter",["deferred"],function(e){var r;return r=function(e){function r(e){this.total_trigs=e,this.num_approved=0,this.num_rejected=0,r.__super__.constructor.call(this)}return t(r,e),r.prototype.resolve=function(e,t){if(this.num_approved+this.num_rejected===this.total_trigs)return r.__super__.resolve.call(this,e,{num_approved:this.num_approved,num_rejected:this.num_rejected},t)},r.prototype.reject=function(e,t){r.__super__.reject.call(this,e,{num_approved:this.num_approved,num_rejected:this.num_rejected},t);if(this.num_approved+this.num_rejected===this.total_trigs)return this.resolve(e,t)},r.prototype.acquire=function(){var e,t;return t=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.num_rejected++,this.reject(t,e)},r.prototype.release=function(){var e,t;return t=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.num_approved++,this.resolve(t,e)},r}(e),r})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("domeventmanager",[],function(){var t;return t=function(){function t(){this.getMousePos=e(this.getMousePos,this),this.mouseDown=e(this.mouseDown,this),this.mouseUp=e(this.mouseUp,this),this.mouseMove=e(this.mouseMove,this),this.mouseClick=e(this.mouseClick,this),this.mouseDblClick=e(this.mouseDblClick,this),this.keyUp=e(this.keyUp,this),this.keyDown=e(this.keyDown,this),this.wheelMoved=e(this.wheelMoved,this),this.mouse_leftbtn_down=!1,this.mouse_rightbtn_down=!1,this.can_drag=!0,this.pos=[0,0],this.viewport=Hal.dom.renderspace,this.hud=Hal.dom.hud,this.dragging=!1,this.under_hud=!1,this.viewport.addEventListener("mousedown",this.mouseDown),this.viewport.addEventListener("mouseup",this.mouseUp),this.viewport.addEventListener("mousemove",this.mouseMove),this.viewport.addEventListener("onmousewheel",this.wheelMoved),this.viewport.addEventListener("onContextMenu",function(){return!1}),this.viewport.addEventListener("mousewheel",this.wheelMoved),this.viewport.addEventListener("click",this.mouseClick),this.viewport.addEventListener("dblclick",this.mouseDblClick),window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp)}return t.prototype.wheelMoved=function(e){if(this.under_hud)return;return this.getMousePos(e),Hal.trigger("SCROLL",{down:e.wheelDelta<0,pos:this.pos})},t.prototype.keyDown=function(e){if(this.under_hud)return;return Hal.trigger("KEY_DOWN",e)},t.prototype.keyUp=function(e){if(this.under_hud)return;return Hal.trigger("KEY_UP",e)},t.prototype.mouseDblClick=function(e){return this.getMousePos(e),Hal.trigger("LEFT_DBL_CLICK",this.pos)},t.prototype.mouseClick=function(e){if(this.under_hud)return;return this.getMousePos(e),Hal.trigger("MOUSE_CLICK",this.pos)},t.prototype.mouseMove=function(e){this.under_hud=this.hud.querySelectorAll(":hover").length>0;if(this.under_hud)return;this.getMousePos(e),Hal.trigger("MOUSE_MOVE",this.pos);if(this.mouse_leftbtn_down&&!this.dragging&&this.can_drag)return Hal.trigger("DRAG_STARTED",this.pos),this.dragging=!0,this.can_drag=!1},t.prototype.mouseUp=function(e){if(this.under_hud){this.mouse_leftbtn_down=!1;return}this.getMousePos(e),this.dragging&&(this.dragging=!1,Hal.trigger("DRAG_ENDED",this.pos),this.can_drag=!0);if(this.mouse_rightbtn_down&&!this.dragging)return Hal.trigger("RIGHT_CLICK",this.pos),this.mouse_rightbtn_down=!1;if(this.mouse_leftbtn_down&&!this.dragging)return Hal.trigger("LEFT_CLICK",this.pos),this.mouse_leftbtn_down=!1},t.prototype.mouseDown=function(e){if(this.under_hud){this.mouse_leftbtn_down=!1;return}this.getMousePos(e);if(e.button===0)return this.mouse_leftbtn_down=!0;if(e.button===2)return this.mouse_rightbtn_down=!0},t.prototype.getMousePos=function(e){return this.pos[0]=e.clientX-Hal.dom.area.left,this.pos[1]=e.clientY-Hal.dom.area.top},t}(),t})}.call(this),function(){var e=[].slice;define("ajax",[],function(){var t,n;return n=function(){function e(e){this.url=e,this.success_=this.fail_=this.always_=function(){},this.success=function(e){return this.success_=e,this},this.fail=function(e){return this.fail_=e,this},this.always=function(e){return this.always_=e,this}}return e}(),t=new Object,t.Result=n,t.get=function(){var t,r,i,s;return s=arguments[0],r=2<=arguments.length?e.call(arguments,1):[],i=new n(document.domain+"/"+s),t=new XMLHttpRequest,t.open("GET",s),t.send(),t.onreadystatechange=function(){var e,n;if(t.readyState===4){n=t.getResponseHeader("Content-Type"),t.status===200?(e=t.responseText,n==="application/json"&&s.indexOf("json")===-1&&(e=JSON.parse(e)),i.success_(e),r[0]&&r[0](e)):(i.fail_(t.responseText),r[1]&&r[1](e)),i.always_(s||e);if(r[2])return r[2](e)}},i},t.post=function(){var t,r,i,s,o;return o=arguments[0],i=arguments[1],r=3<=arguments.length?e.call(arguments,2):[],s=new n(document.domain+"/"+o),t=new XMLHttpRequest,t.open("POST",o),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(i),t.onreadystatechange=function(){var e;if(t.readyState===4){e=t.getResponseHeader("Content-Type"),t.status===200?(i=t.responseText,e==="application/json"&&(i=JSON.parse(i)),s.success_(i),r[0]&&r[0](i)):(s.fail_(t.responseText),r[1]&&r[1](i)),s.always_(o||i);if(r[2])return r[2](i)}},s},t})}.call(this),function(){define("metaconfig",[],function(){var e;return e={Regex:{SpriteMatcher:/\/assets\/sprites\/(.*\/)(.*)\.png/,AssetType:/^(.*)\.(.*)$/},URI:{Sprites:"sprites/",Assets:"/assets/",Maps:"/map/",Websockets:"http://localhost:8080"}},e})}.call(this),function(){define("sprite",["metaconfig"],function(e){var t;return t=function(){function t(t,n,r,i,s,o){var u;this.img=t,this.x=r,this.y=i,this.w=s,this.h=o,u=this.img.src.match(e.Regex.SpriteMatcher),this.name=u&&u[2]?u[2]:"",this.w2=this.w*.5,this.h2=this.h*.5,this.folder=u&&u[1]?u[1]:"",this.onLazyLoad=null}return t.prototype.changeSprite=function(e){this.img=e.img,this.name=e.name,this.x=e.x,this.y=e.y,this.w=e.w,this.h=e.h,this.folder=e.folder,this.w2=e.w2,this.h2=e.h2;if(this.onLazyLoad!=null)return this.onLazyLoad()},t.prototype.getName=function(){return this.folder+this.name},t}(),t})}.call(this),function(){define("imgutils",[],function(){var e;return e=function(){function e(){this.hit_ctx=this.createCanvas(1,1).getContext("2d"),this.tint_ctx=this.createCanvas(800,600).getContext("2d")}return e.prototype.createCanvas=function(e,t){var n;return n=document.createElement("canvas"),n.width=e,n.height=t,n},e.prototype.clipImage=function(e,t){var n,r;return n=this.createCanvas(t.w,t.h),r=n.getContext("2d"),r.drawImage(e,t.x,t.y,t.w,t.h,0,0,t.w,t.h),e=new Image,e.src=n.toDataURL("image/png"),e},e.prototype.isTransparent=function(e,t,n){var r;return this.hit_ctx.drawImage(e,t,n,1,1,0,0,1,1),r=this.hit_ctx.getImageData(0,0,1,1).data,this.hit_ctx.clearRect(0,0,1,1),r[3]<255},e.prototype.getPixelAt=function(e,t,n){var r,i;return this.hit_ctx.drawImage(e,t,n,1,1,0,0,1,1),r=this.hit_ctx.getImageData(0,0,1,1).data,i=(t+n)*4,[r[i],r[i+1],r[i+2],r[i+3]]},e.prototype.tintImage=function(e,t,n){var r,i;return r=this.createCanvas(e.width,e.height),i=r.getContext("2d"),i.globalAlpha=1,i.drawImage(e,0,0),i.globalAlpha=n,i.globalCompositeOperation="source-atop",i.fillStyle=t,i.fillRect(0,0,e.width,e.height),r},e}(),e})}.call(this),function(){define("spritefactory",["sprite","imgutils"],function(e,t){var n;return n={},n.clipFromSpriteSheet=function(n,r,i){return new e(t.clipImage(n,i),r,0,0,i.w,i.h)},n.fromSingleImage=function(t,n){return new e(t,n,0,0,t.width,t.height)},n.dummySprite=function(){var t;return t=new Image,t.src="",new e(t,"n/a",0,0,t.width,t.height)},n})}.call(this),function(){define("spritesheet",[],function(){var e;return e=function(){function e(e,t,n,r){var i;this.path=e,this.img=t,this.meta=n,this.sprites=r!=null?r:{},i=this.path.match(/.*\/(.*)\.json/),i&&i.length>0?this.name=i[1]:this.name=this.path}return e.prototype.addSprite=function(e){return this.sprites[e.name]=e},e}(),e})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("assetmanager",["deferred","deferredcounter","ajax","spritefactory","sprite","spritesheet","eventdispatcher","metaconfig"],function(e,r,i,s,o,u,a,f){var l;return l=function(e){function n(){n.__super__.constructor.call(this),this.assets={sprites:{},spritesheets:{},audio:{},animation:{}},this.tint_cache={},this.wait_queue=[]}return t(n,e),n}(a),l.prototype.setResourcesRelativeURL=function(e){return f.URI.Assets=e},l.prototype.resolvePath=function(e){var t,n,r,i,s,o,u;n=e.split("/"),this.assets.hasOwnProperty(n[0])&&(i=this.assets[n[0]]),u=n.slice(1,n.length-1);for(s=0,o=u.length;s<o;s++)t=u[s],i.hasOwnProperty(t)||(i[t]=new Object),i=i[t],r=n[n.length-1],r=r.substring(0,r.lastIndexOf("."));return[i,r]},l.prototype.addToStorage=function(e,t){var n,r,i;return i=this.resolvePath(e),r=i[0],n=i[1],r[n]=t,r[n]},l.prototype.deleteFromStorage=function(e){var t,n,r;return r=this.resolvePath(e),n=r[0],t=r[1],n[t]=null,delete n[t]},l.prototype.loadImage=function(t){var n,r,i=this;return n=new e,r=new Image,r.src=t,r.onload=function(){return n.resolve(r,r)},r.onerror=function(){return n.reject(r,t)},n.promise()},l.prototype.loadImages=function(e){var t,n,i,s;t=new r(e.length);for(i=0,s=e.length;i<s;i++)n=e[i],this.loadImage(n).then(function(e){return t.release(this,e)}).fail(function(e){return t.acquire(this,e)});return t.promise()},l.prototype.getTintedSprite=function(e,t,n){var r;return t==null&&(t="red"),n==null&&(n=.5),r=e.getName()+t,this.tint_cache[r]||(this.tint_cache[r]=Hal.imgutils.tintImage(e.img,t,n)),this.tint_cache[r]},l.prototype.loadSprite=function(t){var n,r=this;return t=f.URI.Assets+t,n=new e,this.loadImage(t).then(function(e){var i,o;return o=s.fromSingleImage(e,t),i=o.getName(),r.wait_queue[i]&&(llogi("Sprite was in a waiting queue: SPRITE = "+i),r.wait_queue[i].changeSprite(o),delete r.wait_queue[t]),Hal.trigger("SPRITE_LOADED",o),n.resolve(r,o)}).fail(function(e){return n.reject(r,e)}),n.promise()},l.prototype.loadSound=function(t){var n;return t=f.URI.Assets+t,n=new e},l.prototype.addSprite=function(e){var t=this;return this.loadSprite(e).then(function(n){return t.addToStorage(e,n)})},l.prototype.addSound=function(){var e=this;return this.loadSound(g).then(function(t){return e.addToStorage(g,t)})},l.prototype.resolveFolderPath=function(e){var t,n,r,i,s,o,u;n=e.split("/");if(this.assets.hasOwnProperty(n[0])){i=this.assets[n[0]];if(n.length>3){u=n.slice(1,n.length-2);for(s=0,o=u.length;s<o;s++)t=u[s],i.hasOwnProperty(t)||(i[t]={}),i=i[t]}}return r=n[n.length-2],[i,r]},l.prototype.loadViaSocketIO=function(){var e=this;if(typeof io=="undefined"||io===null){lloge("Couldn't find socket.io library");return}return this.socket=io.connect(f.URI.Websockets),this.socket.on("connect",function(){return llogd("Connected via socket.io")}),this.socket.on("LOAD_SPRITES",function(t){var n,r,i,s,o,u,a;s=JSON.parse(t.files),i=s.length;if(i===0&&t[0].toString()===""){e.trigger("SPRITES_LOADED");return}e.trigger("SPRITES_LOADING",i),a=[];for(r=o=0,u=s.length;o<u;r=++o)n=s[r],a.push(function(n,r){return e.addSprite(t.url+n).then(function(){e.trigger("SPRITE_LOADED",n);if(r===i-1)return e.trigger("SPRITES_LOADED")})}(n,r));return a}),this.socket.on("LOAD_SOUNDS",function(t){var n,r,i,s,o,u,a;s=JSON.parse(t.files),i=s.length-1,e.trigger("SOUNDS_LOADING",i),a=[];for(r=o=0,u=s.length;o<u;r=++o)n=s[r],a.push(function(n,r){return e.addSound(t.url+n).then(function(){e.trigger("SOUND_LOADED");if(r===i)return e.trigger("SOUNDS_LOADED")})}(n,r));return a}),this.socket.on("SPRITE_FOLDER_ADDED",function(t){var n,r,i,s,o,u,a,f;llogd("Sprite folder added: data.url"),i=t.files.length,e.trigger("SPRITES_LOADING"),a=t.files,s=function(e,t){},f=[];for(r=o=0,u=a.length;o<u;r=++o)n=a[r],llogd("Adding sprite: "+n),s(n,r),f.push(e.addSprite(t.url+n).then(function(){e.trigger("SPRITE_LOADED",n);if(r===i)return e.trigger("SPRITES_LOADED")}));return f}),this.socket.on("SPRITE_ADDED",function(t){return llogd("Sprite added: "+t.url),e.addSprite(t.url)}),this.socket.on("SPRITESHEET_ADDED",function(e){return llogd("Spritesheet added: "+e.url)}),this.socket.on("SPRITE_DELETED",function(t){return llogd("Sprite deleted: "+t.url),e.deleteFromStorage(t.url)}),this.socket.on("SPRITE_FOLDER_DELETED",function(t){var n,r,i;return llogd("Sprite folder deleted: "+t.url),i=e.resolveFolderPath(t.url),r=i[0],n=i[1],delete r[n],e.trigger("SPRITES_LOADED")}),this.socket.on("SPRITESHEET_DELETED",function(e){return llogd("Spritesheet deleted: "+e.url),llogd(e)})},l.prototype.loadSpritesFromFileList=function(e){var t=this;return i.get(e,function(e){var n,r,i,s,o,u;e=e.split("\n"),r=e.length;if(r===0&&e[0].toString()===""){t.trigger("SPRITES_LOADED");return}t.trigger("SPRITES_LOADING",r),u=[];for(n=s=0,o=e.length;s<o;n=++s)i=e[n],u.push(function(e,n){return t.addSprite(e).then(function(){t.trigger("SPRITE_LOADED",e);if(n===r-1)return t.trigger("SPRITES_LOADED")})}(i,n));return u})},l.prototype.loadFromArray=function(e,t){n.call(this.assets,e)<0},l.prototype.getSprite=function(e){var t,n,r;return r=this.resolvePath(f.URI.Sprites+e+"."),n=r[0],t=r[1],n[t]},l.prototype.getSpritesFromFolder=function(e){var t,n,r,i,s,o,u,a;if(e==="/")return this.getSpriteFolders();t=e.indexOf("/"),t===0&&(e=e.substring(t+1)),t=e.charAt(e.length-1),t!=="/"&&(e=""+e+"/"),i={},u=this.resolveFolderPath(f.URI.Sprites+e),s=u[0],r=u[1],a=s[r];for(n in a)o=a[n],o.img!=null&&(i[n]=o);return i},l.prototype.getSpriteFoldersFromFolder=function(e){var t,n,r,i,s,o,u,a;t=e.indexOf("/"),t===0&&(e=e.substring(t+1)),t=e.charAt(e.length-1),t!=="/"&&(e=""+e+"/"),i={},u=this.resolveFolderPath(f.URI.Sprites+e),s=u[0],r=u[1],a=s[r];for(n in a)o=a[n],o.img==null&&(i[n]=o);return i},l.prototype.getSpriteFolders=function(){return this.assets.sprites},l.prototype.waitFor=function(e,t){return this.wait_queue[t]=e},l})}.call(this),function(){define("drawable",["vec2","geometry","sprite"],function(e,t,n){var r;return r=function(){function t(){this._drawableState=3840,this.stroke_color="white",this.fill_color="orange",this.sprite=null,this.glow_amount=1,this.glow_color="blue",this.stroke_width=1,this.opacity=1,this.on("CHANGE",function(e,r){if(e==="sprite"){if(this.sprite==null||!this.sprite instanceof n)return;return this.trigger("SPRITE_ADDED",this.sprite),this.drawableOnState(t.DrawableStates.Sprite),this.drawableOffState(t.DrawableStates.Fill),this.drawableOffState(t.DrawableStates.Stroke)}if(e==="glow"&&r===!0)return this.drawableOnState(t.DrawableStates.Stroke),this.drawableOnState(t.DrawableStates.Glow);if(e==="glow"&&r===!1)return this.drawableOffState(t.DrawableStates.Glow)}),this.on("POST_FRAME",function(n){var r,i,s,o,u;if(this.drawableIsState(t.DrawableStates.Fill)){this.ctx.fillStyle=this.fill_color,this.ctx.beginPath(),this.ctx.moveTo(this._mesh[0][0],this._mesh[0][1]),r=1;while(r<this._numvertices)this.ctx.lineTo(this._mesh[r][0],this._mesh[r][1]),++r;this.ctx.closePath(),this.ctx.fill()}this.drawableIsState(t.DrawableStates.Sprite)&&this.sprite!=null&&this.ctx.drawImage(this.sprite.img,-this.sprite.w2,-this.sprite.h2),this.drawableIsState(t.DrawableStates.Glow)&&(this.ctx.shadowColor=this.glow_color,this.ctx.shadowBlur=this.glow_amount);if(this.drawableIsState(t.DrawableStates.Stroke)){this.ctx.lineWidth=this.stroke_width,this.ctx.strokeStyle=this.stroke_color,this.ctx.beginPath(),this.ctx.moveTo(this._mesh[0][0],this._mesh[0][1]),r=1;while(r<this._numvertices)this.ctx.lineTo(this._mesh[r][0],this._mesh[r][1]),++r;this.ctx.closePath(),this.ctx.stroke(),this.ctx.lineWidth=1}this.drawableIsState(t.DrawableStates.Glow)&&(this.ctx.shadowBlur=0);if(this.drawableIsState(t.DrawableStates.DrawNormals)){r=0,o=e.acquire(),u=e.acquire(),i=e.acquire(),s=e.acquire();while(r<this._numvertices)e.copy(o,this._mesh[r]),e.copy(u,this._mesh[(r+1)%this._numvertices]),e.addAndScale(i,o,u,.5),e.sub(s,u,o),e.perpendicular(o,s),e.normalize(u,o),e.scale(o,u,50),e.add(s,o,i),this.ctx.strokeStyle="yellow",this.ctx.beginPath(),this.ctx.moveTo(i[0],i[1]),this.ctx.lineTo(s[0],s[1]),this.ctx.closePath(),this.ctx.stroke(),++r;e.release(o),e.release(u),e.release(i),e.release(s)}this.drawableIsState(t.DrawableStates.DrawCenter)&&this.ctx.strokeRect(0,0,1,1);if(this.drawableIsState(t.DrawableStates.DrawBBox))return this.ctx.strokeRect(this._bbox[0],this._bbox[1],this._bbox[2],this._bbox[3])})}return t.prototype.drawableToggleState=function(e){return e==null&&(e=0),this._drawableState^=e},t.prototype.drawableOnState=function(e){return e==null&&(e=0),this._drawableState|=e},t.prototype.drawableOffState=function(e){return e==null&&(e=0),this.drawableOnState(e),this.drawableToggleState(e)},t.prototype.drawableIsState=function(e){return e==null&&(e=0),(this._drawableState&e)===e},t.prototype.destructor=function(){},t}(),r.DrawableStates={DrawCenter:1,DrawOriginNormals:2,Glow:4,DrawNormals:8,Fill:16,Sprite:32,DrawBBox:64,Stroke:128},r})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("bbresolvers",["vec2","mathutil","geometry"],function(e,n,r){var i,s,o,u,a,f,l,c;return s={AABPolygonFromSprite:function(e,t,n){return t==null&&(t=f),n==null&&(n=a),u(e,t,n)},AABBoxFromSprite:function(e){var t;return t=new n.ARRAY_TYPE(4),t[0]=-e.w*.5,t[1]=-e.h*.5,t[2]=e.w,t[3]=e.h,t},AABCircleFromSprite:function(e){var t;return t=Math.sqrt(e.w*e.w+e.h*e.h)*.5,t},AABBFromPolygon:function(e){var t,r,i,s,o,u,a,f;i=Number.MAX_VALUE,s=Number.MAX_VALUE,t=-Number.MIN_VALUE,r=-Number.MIN_VALUE;for(a=0,f=e.length;a<f;a++)u=e[a],i=Math.min(u[0],i),s=Math.min(u[1],s),t=Math.max(u[0],t),r=Math.max(u[1],r);return o=new n.ARRAY_TYPE(4),o[0]=i,o[1]=s,o[2]=Math.abs(i)+t,o[3]=Math.abs(s)+r,o}},u=function(t,r,i){var s,o,u,a,f,l,c,h,p;h=[],p=t.w,l=t.h,s=Hal.dom.createCanvas(p,l),a=s.getContext("2d"),u=[],a.drawImage(t.img,0,0),c=a.getImageData(0,0,p,l),f=function(){var t,r,i,s,o,u,a,f,l,c,p,d,v,m,g,y;f=0,r=0,t=1/33;if(h.length<2)return h;for(c=g=0,y=h.length;g<y;c=++g){a=h[c],u=h[c+1];if(u==null)break;o=e.from(a[0],a[1]),p=e.from(u[0],u[1]),v=e.sub([],p,o);if(v!=null){d=h[c+2];if(d==null)break;m=e.sub([],p,e.from(d[0],d[1]))}if(v!=null&&m!=null){e.normalize(v,v),e.normalize(m,m),s=e.dot(v,m),f=r,r=e.dot(v,m),i=Math.abs(r-f);if(i>t)return l=[h[c+2][0]-n.EPSILON,h[c+2][1]-n.EPSILON],h.splice(0,c+2),l}}},h=new r(c.data,p,l);while((o=f())!=null)u.push(o);return llogd("Number of critical points: "+u.length),new i(u)},o=function(){function e(e,t,n,r){return this.data=e!=null?e:[],this.width=t,this.height=n,this.sample_rate=r!=null?r:1,this.samplingFunc()}return e.prototype.samplingFunc=function(){return[]},e.prototype.getPixelAt=function(e,t){var n;return n=(e+this.width*t)*4,[this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]]},e}(),f=function(e){function n(){return l=n.__super__.constructor.apply(this,arguments),l}return t(n,e),n.prototype.samplingFunc=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;e=130,i=[];for(t=s=0,f=this.width,l=this.sample_rate;l>0?s<f:s>f;t=s+=l)for(n=o=0,c=this.height;0<=c?o<c:o>c;n=0<=c?++o:--o){r=this.getPixelAt(t,n);if(r[3]>e){i.push({x:t,y:n});break}}for(t=u=0,h=this.width,p=this.sample_rate;p>0?u<h:u>h;t=u+=p)for(n=a=d=this.height;a>0;n=a+=-1){r=this.getPixelAt(t,n);if(r[3]>e){i.unshift({x:t,y:n});break}}return i},n}(o),i=function(){function e(e){return this.downsamplingFunc(e)}return e.prototype.downsamplingFunc=function(){return[]},e}(),a=function(e){function n(){return c=n.__super__.constructor.apply(this,arguments),c}return t(n,e),n.prototype.downsamplingFunc=function(e){var t,n,i,s,o,u,a,f,l,c,h,p,d;i=3,h=e[0],u=e.length,n=e[u-1],a=0,o=0,f=[];if(u<2)return e;for(s=p=1,d=u-1;1<=d?p<d:p>d;s=1<=d?++p:--p)t=r.perpDistance(e[s],h,n),t>a&&(o=s,a=t);return a>i?(l=this.downsamplingFunc(e.slice(0,+o+1||9e9)),c=this.downsamplingFunc(e.slice(o,u)),l=l.slice(0,l.length-1),f=l.concat(c)):(f.push(h),f.push(n)),f},n}(i),s})}.call(this),function(){define("collidable",["vec2","geometry","bbresolvers"],function(e,t,n){var r;return r=function(){function e(){this.in_collision=!1,this._bbox=new Array,this.on("SHAPE_CHANGED",function(e){return this._bbox=n.AABBFromPolygon(e)}),this.on("SPRITE_ADDED",function(e){return this._bbox=n.AABBoxFromSprite(e)}),this.on("COLLISION_STARTED",function(e){return this.stroke_color="yellow",this.in_collision=!0}),this.on("COLLISION_ENDED",function(e){return this.stroke_color="white",this.in_collision=!1})}return e.prototype.intersectsWithBBox=function(e){return t.rectangleIntersectsRectangle(t.transformRectangle(e._bbox,this.transform()),t.transformRectangle(this._bbox,e.transform()))},e}(),r})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("shape",["vec2","matrix3","halalentity","transformable","drawable","geometry","collidable","bbresolvers","sprite","groupy"],function(e,r,i,s,o,u,a,f,l,c){var h,p;return p=["angle","scale","position","origin"],h=function(e){function n(e){return e==null&&(e={}),n.__super__.constructor.call(this),this._mesh=null,this._numvertices=0,this.scene=null,this.quadtree=null,this.ctx=null,this.parseMeta(e),this.init(),this}return t(n,e),n.include(s),n.include(o),n.include(a),n.include(c),n}(i),h.prototype.parseMeta=function(e){e.shape!=null&&(this.setShape(e.shape),this.drawableOnState(o.DrawableStates.Stroke));if(e.x!=null&&e.y!=null)return this.setPosition(e.x,e.y)},h.prototype.init=function(){return this.on("CHANGE",function(e,t){if(n.call(p,e)>=0)return this._update_mesh_transform=!0,this._update_transform=!0,this._update_inverse=!0}),h.__super__.init.call(this),this},h.prototype.setSprite=function(e){return this.attr("sprite",e)},h.prototype.scenePosition=function(){return Hal.geometry.transformPoint(this.position[0],this.position[1],r.mul([],this.scene.transform(),this.transform()))},h.prototype.worldPosition=function(){return this.position},h.prototype.setShape=function(t){var n;return u.isPolygonConvex(t)||(llogw("Oh snap, mesh was degenerate"),t=u.polygonSortVertices(t)),this._mesh!=null&&this.destroyMesh(),n=Hal.geometry.polygonMeanPoint(t),this.setOrigin(n[0],n[1]),e.release(n),this._mesh=t,this._numvertices=this._mesh.length,this.trigger("SHAPE_CHANGED",this._mesh),this},h.prototype.addVertex=function(t,n){return this._numvertices=this._mesh.push(e.from(t,n)),u.isPolygonConvex(this._mesh)||(llogw("Oh snap, mesh was degenerate"),this.setShape(u.polygonSortVertices(this._mesh))),this},h.prototype.update=function(e){this.scene.update_ents&&(this._update_transform=!0),this.calcTransform()},h.prototype.draw=function(e){this.trigger("PRE_FRAME",e),this.ctx.setTransform(this.scene._transform[0],this.scene._transform[3],this.scene._transform[1],this.scene._transform[4],this.scene._transform[2],this.scene._transform[5]),this.ctx.transform(this._transform[0],this._transform[3],this._transform[1],this._transform[4],this._transform[2],this._transform[5]),this.trigger("POST_FRAME",e)},h.prototype.angleWithOrigin=function(t){return t=e.transformMat3(null,t,this._transform),u.angleOf([t[0]-this.origin[0],t[1]-this.origin[1]])},h.prototype.addShape=function(){},h.prototype.destroy=function(){this.scene.trigger("ENTITY_REQ_DESTROYING",this),this.destroyMesh(),this.destructor()},h.prototype.destroyMesh=function(){var t,n,r,i;this._numvertices=0;if(this._mesh!=null){i=this._mesh;for(n=0,r=i.length;n<r;n++)t=i[n],t instanceof Float32Array?e.release(t):llogw("That is some strange mesh");return this.trigger("SHAPE_CHANGED")}},h})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("tile",["shape"],function(e){var n;return n=function(e){function n(e){return n.__super__.constructor.call(this,e),this.row=e.row,this.col=e.col,this.layers=new Array,this.attr("stroke_width",.5),this}return t(n,e),n.prototype.containsLayer=function(e){var t;return t=e.layer,this.layers[t]!=null&&this.layers[t].name===e.name?!0:!1},n.prototype.addTileLayer=function(e){var t;return t=e.layer,this.layers[t]!=null&&this.layers[t].destroy(),this.layers[t]=e,this.sortLayers(),e.attachToTile(this),e},n.prototype.getLayers=function(){return this.layers.filter(function(e){if(e==null)return e})},n.prototype.removeLayer=function(e){return this.layers[e]!=null&&this.layers.splice(e,1),this.sortLayers()},n.prototype.init=function(e){return n.__super__.init.call(this,e),this},n.prototype.update=function(e){var t,r,i,s,o;n.__super__.update.call(this,e),s=this.layers,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],o.push(t!=null?t.update(e):void 0);return o},n.prototype.draw=function(e){var t,r,i,s,o;n.__super__.draw.call(this,e),s=this.layers,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],o.push(t!=null?t.draw(e):void 0);return o},n.prototype.sortLayers=function(){return this.layers.sort(function(e,t){return e==null||t==null?0:e.layer-t.layer})},n.prototype.destroyMesh=function(){this._mesh=null,n.__super__.destroyMesh.call(this)},n.prototype.toString=function(){return"Row: "+this.row+", Col: "+this.col+", Layers: "+this.getLayers().length},n}(e),n})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("tilelayer",["shape"],function(e){var n;return n=function(e){function n(e){n.__super__.constructor.call(this,e),this.setSprite(Hal.asm.getSprite(e.sprite)),this.name=e.name!=null?e.name:""+this.id,this.layer=e.layer!=null?e.layer:0,this.h=0,e.group!=null&&this.attr("group",e.group),this.attr("group",e.layer)}return t(n,e),n.prototype.attachToTile=function(e){return this.tile=e,this.trigger("PLACED_ON_TILE")},n.prototype.init=function(e){return n.__super__.init.call(this,e)},n.prototype.initListeners=function(){return n.__super__.initListeners.call(this),this.on("SELECTED",function(){return console.log("I'm selected: "+this.toString())}),this.on("DESELECTED",function(){return console.log("I'm deselected: "+this.toString())})},n.prototype.destroy=function(){return n.__super__.destroy.call(this),this.tile!=null&&this.tile.removeLayer(this.layer),delete this.tile},n.prototype.toString=function(){return typeof tile!="undefined"&&tile!==null?tile.toString():void 0},n}(e),n})}.call(this),function(){define("tilemanager",["tile","tilelayer"],function(e,t){var n;return n=function(){function n(e,t){var n=this;this.map=e,t==null&&(t=""),this.tile_layer_map={},this.tile_name_map={},this.tile_id_map={},this.markers=[],this._id=0,this.max_layers=this.map.max_layers,Hal.on("TILE_MNGR_NEW_TILE",function(e){return n.add(e)}),Hal.on("TILE_MNGR_LOAD_MARKERS",function(e){return n.loadMarkers(e)}),Hal.on("TILE_MNGR_NEW_MARKER",function(e){return n.addMarker(e)}),Hal.on("TILE_MNGR_LOAD_TILES",function(e){return n.load(e)})}return n.prototype.loadMarkers=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++)t=e[n],this.addMarker(t);return this.map.trigger("TM_MARKERS_LOADED")},n.prototype.addMarker=function(e){return this.markers.indexOf(e)===-1?this.markers.push(e):llogw("Marker "+e+" exists!")},n.prototype.loadFromList=function(e){var t,n=this;return e==null&&(e="assets/tiles.list"),Ajax.get(e,function(e){}),llogd("TileManager loaded tiles."),t=JSON.parse(t),this.load(t)},n.prototype.load=function(e){var t,n;llogd("Loading tiles...");for(t in e)n=e[t],this.add(n);return this.map.trigger("TM_TILES_LOADED")},n.prototype.add=function(e){var t;return t=this.tile_name_map[e.name],t!=null&&delete this.tile_layer_map[t.layer][t.name],this.tile_name_map[e.name]=e,this.tile_id_map[e.id]=e,this.tile_layer_map[e.layer]==null&&(this.tile_layer_map[e.layer]={}),this.tile_layer_map[e.layer][e.name]=e},n.prototype.getAllByLayer=function(e){return this.tile_layer_map[e]},n.prototype.findByName=function(e){var t;return t=this.tile_name_map[e],t==null&&llogw("No tile with name: "+e),t},n.prototype.findById=function(e){var t;return t=this.tile_id_map[e],t==null&&llogw("No tile with id: "+e),t},n.prototype.removeByName=function(e){var t;return t=this.tile_name_map[e],delete this.tile_layer_map[t.layer][t.name],delete this.tile_name_map[t.name],delete this.tile_id_map[t.id],t=null},n.prototype.removeById=function(e){var t;return t=this.tile_id_map[e],delete this.tile_layer_map[t.layer][t.name],delete this.tile_id_map[t.id],delete this.tile_name_map[t.name],t=null},n.prototype.newTileLayer=function(e){return new t(e)},n.prototype.newTile=function(t){var n,r,i,s;r=new e(t);for(n=i=0,s=this.max_layers;0<=s?i<s:i>s;n=0<=s?++i:--i)r.layers.push(null);return r},n.prototype.addTileLayerMetaByLayerId=function(e,t,n,r,i){var s;return r==null&&(r=0),i==null&&(i=0),s=this.findById(n),this.addTileLayerMeta(e,t,s,r,i)},n.prototype.addTileLayerInstance=function(e,t,n,r){var i,s,o,u,a,f,l;a=this.map.getTile(e,t);if(a==null){lloge("No tile at "+e+":"+t+"!!!");return}s=n.meta;if(s==null){lloge("No layermeta!!!");return}if(a.containsLayer(s)&&!r){llogw("You can't add same layer "+s.name+" twice");return}if(s.layer>this.max_layers){lloge("You can't have more than "+this.max_layers+" layers");return}return f=a.col/2*this.map.tilew,l=(a.row+a.col%2/2)*this.map.tileh,a.addTileLayer(n),o=a.sprite.w*.5-this.map.tilew2,u=a.sprite.h*.5-this.map.tileh2,n.attr("h",u),n.setPosition(f,l-u),i=this.map.renderer.getLayerContext(n.layer),this.map.addEntityToQuadSpace(n,i),n.trigger("ON_MAP"),a},n.prototype.addTileLayerMeta=function(e,t,n,r,i){var s,o,u,a,f,l,c;r==null&&(r=0),i==null&&(i=0),f=this.map.getTile(e,t);if(f==null){lloge("No holder!!!");return}if(n==null){lloge("No layermeta!!!");return}if(f.containsLayer(n)){llogw("You can't add same layer "+n.name+" twice");return}if(n.layer>this.max_layers){lloge("You can't have more than "+this.max_layers+" layers");return}l=f.col/2*this.map.tilew,c=(f.row+f.col%2/2)*this.map.tileh,o=this.newTileLayer(n);if(o.sprite==null){console.error("No sprite available for given tile: "+n.name),o.destroy();return}return f.addTileLayer(o),u=o.sprite.w*.5-this.map.tilew2,a=o.sprite.h*.5-this.map.tileh2,o.attr("h",a),o.setPosition(l,c-a),s=this.map.renderer.getLayerContext(o.layer),this.map.addEntityToQuadSpace(o,s),o.trigger("ON_MAP"),o},n.prototype.loadTileLayerById=function(e,t){return this.addTileLayerMetaByLayerId(e.row,e.col,t)},n}(),n})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("isometricscene",["scene","tilemanager","quadtree","geometry","vec2"],function(e,n,r,i,s){var o;return o=function(e){function o(e){var t,n,i,u,a,f;o.__super__.constructor.call(this,e),this.tilew2prop=2/this.tilew,this.tileh2prop=2/this.tileh,this.tilew2=this.tilew/2,this.tileh2=this.tileh/2,this.map=[],this.mpos=s.from(0,0),this.world_pos=s.from(0,0),this.max_rows=this.nrows-1,this.max_cols=this.ncols-1,this.selected_tile_x=0,this.selected_tile_y=this.tileh2,this.selected_tile=null,this.selected_tile_sprite=null,this.tiles_found=[],this.iso_shape=[s.from(-this.tilew2,0),s.from(0,this.tileh2),s.from(this.tilew2,0),s.from(0,-this.tileh2)],this.info={row:"Row: ",col:"Col: ",tilename:"Tile: ",mouse_position:"Mouse position: ",tile_under_mouse:"Tile position: ",world_position:"Mouse world position: "},t=Hal.dom.createCanvas(this.tilew,this.tileh).getContext("2d"),t.drawImage(this.mask.img,0,0),this.mask_data=t.getImageData(0,0,this.tilew,this.tileh).data,f=this.mask_data;for(i=u=0,a=f.length;u<a;i=++u)n=f[i],this.mask_data[i]=n<120;this.world_bounds=[0,0,(this.ncols-1)*this.tilew2,(this.nrows-.5)*this.tileh],this.world_center=[],this.world_center[0]=(this.world_bounds[2]-this.world_bounds[0])*.5,this.world_center[1]=(this.world_bounds[3]-this.world_bounds[1])*.5,this.section_dim=[Math.floor(this.world_bounds[2]/3),Math.floor(this.nrows*this.tileh/3)],this.cap=Math.floor(this.section_dim[0]/this.tilew2)*Math.floor(this.section_dim[1]/this.tileh),this.startTile=this.endTile=null,this.sections={center:new r([this.section_dim[0],this.section_dim[1],this.section_dim[0],this.section_dim[1]],this.cap,!1),ne:new r([0,0,this.section_dim[0],this.section_dim[1]],this.cap,!1),n:new r([this.section_dim[0],0,this.section_dim[0],this.section_dim[1]],this.cap,!1),nw:new r([2*this.section_dim[0],0,this.section_dim[0],this.section_dim[1]],this.cap,!1),e:new r([0,this.section_dim[1],this.section_dim[0],this.section_dim[1]],this.cap,!1),w:new r([2*this.section_dim[0],this.section_dim[1],this.section_dim[0],this.section_dim[1]],this.cap,!1),se:new r([0,2*this.section_dim[1],this.section_dim[0],this.section_dim[1]],this.cap,!1),s:new r([this.section_dim[0],2*this.section_dim[1],this.section_dim[0],this.section_dim[1]],this.cap,!1),sw:new r([2*this.section_dim[0],2*this.section_dim[1],this.section_dim[0],this.section_dim[1]],this.cap,!1)},this.sections.center.divide(),this.sections.ne.divide(),this.sections.n.divide(),this.sections.nw.divide(),this.sections.e.divide(),this.sections.w.divide(),this.sections.se.divide(),this.sections.s.divide(),this.sections.sw.divide(),this.screen_end=[]}return t(o,e),o.prototype.drawStat=function(){o.__super__.drawStat.call(this);if(this.tile_under_mouse!=null)return Hal.glass.ctx.fillText(this.info.mouse_position+s.str(this.mpos),0,130),Hal.glass.ctx.fillText(this.info.row+this.tile_under_mouse.row,0,145),Hal.glass.ctx.fillText(this.info.col+this.tile_under_mouse.col,0,160),Hal.glass.ctx.fillText(this.info.tile_under_mouse+s.str(this.tile_under_mouse.position),0,175),Hal.glass.ctx.fillText(this.info.world_position+s.str(this.world_pos),0,190)},o.prototype.drawQuadTree=function(e){return this.drawQuadSections(this.sections.center,"red"),this.drawQuadSections(this.sections.ne,"gold"),this.drawQuadSections(this.sections.n,"green"),this.drawQuadSections(this.sections.nw,"blue"),this.drawQuadSections(this.sections.e,"cyan"),this.drawQuadSections(this.sections.w,"orange"),this.drawQuadSections(this.sections.se,"yellow"),this.drawQuadSections(this.sections.s,"violet"),this.drawQuadSections(this.sections.sw,"brown")},o.prototype.drawQuadSections=function(e,t){if(this.paused)return;this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.strokeStyle=t,e.nw!=null&&(this.drawQuadSections(e.nw),this.ctx.strokeRect(e.nw.bounds[0],e.nw.bounds[1],e.nw.bounds[2],e.nw.bounds[3]),this.ctx.fillText(""+e.nw.id,e.nw.bounds[0]+e.nw.bounds[2]*.5,e.nw.bounds[1]+e.nw.bounds[3]*.5)),e.ne!=null&&(this.drawQuadSections(e.ne),this.ctx.strokeRect(e.ne.bounds[0],e.ne.bounds[1],e.ne.bounds[2],e.ne.bounds[3]),this.ctx.fillText(""+e.ne.id,e.ne.bounds[0]+e.ne.bounds[2]*.5,e.ne.bounds[1]+e.ne.bounds[3]*.5)),e.sw!=null&&(this.drawQuadSections(e.sw),this.ctx.strokeRect(e.sw.bounds[0],e.sw.bounds[1],e.sw.bounds[2],e.sw.bounds[3]),this.ctx.fillText(""+e.sw.id,e.sw.bounds[0]+e.sw.bounds[2]*.5,e.sw.bounds[1]+e.sw.bounds[3]*.5));if(e.se!=null)return this.drawQuadSections(e.se),this.ctx.strokeRect(e.se.bounds[0],e.se.bounds[1],e.se.bounds[2],e.se.bounds[3]),this.ctx.fillText(""+e.se.id,e.se.bounds[0]+e.se.bounds[2]*.5,e.se.bounds[1]+e.se.bounds[3]*.5)},o.prototype.parseMeta=function(e){return o.__super__.parseMeta.call(this,e),console.debug("Scene meta"),console.debug(e),this.tilew=e.tilew,this.tileh=e.tileh,this.nrows=+e.rows,this.ncols=+e.cols,this.max_layers=e.max_layers!=null?e.max_layers||5:void 0,this.mask=e.mask},o.prototype.init=function(){return o.__super__.init.call(this),this.clicked_layer=null,this.tile_under_mouse=null,this.screen_end=[this.bounds[2]+2*this.tilew,this.bounds[3]+2*this.tileh],this.initMap()},o.prototype.maxRows=function(){return Math.min(this.nrows-1,Math.round(this.bounds[3]/(this.tileh*this.scale[0])+4))},o.prototype.maxCols=function(){return Math.min(this.ncols-1,Math.round(this.bounds[2]/(this.tilew2*this.scale[1])+4))},o.prototype.toOrtho=function(e){var t,n,r,i,s;return t=(e[0]+this.tilew2)*this.tilew2prop,i=(e[1]+this.tileh2)*this.tileh2prop,n=~~(e[0]+this.tilew2-~~(t*.5)*this.tilew),r=~~(e[1]+this.tileh2-~~(i*.5)*this.tileh),s=this.mask_data[(n+this.tilew*r)*4+3],[t-(s^!(t&1)),(i-(s^!(i&1)))/2]},o.prototype.getNeighbours=function(e){var t,n,r,i,s,o;r=[];if(e==null)return r;o=Object.keys(e.direction);for(i=0,s=o.length;i<s;i++)t=o[i],n=this.getTile(e.row,e.col,e.direction[t]),n!=null&&r.push(n);return r},o.prototype.findInDirectionOf=function(e,t,n){var r,i,s,o,u;if(e==null)return[];o=[],o.push(e),s=e.row,i=e.col,r=e.direction[t];while(n>0){u=this.getTile(s,i,r);if(u==null)break;o.push(u),s=u.row,i=u.col,r=u.direction[t],n--}return o},o.prototype.isAdjacentTo=function(e,t){var n,r;return t==null?!1:(r=this.getNeighbours(t),n=r.some(function(t){return t.row===e.row&&t.col===e.col}),n)},o.prototype.getTile=function(e,t,n){return n==null&&(n=[0,0]),this.map[t+n[1]+(e+n[0])*this.ncols]},o.prototype.getTileAt=function(e){var t;return t=this.toOrtho(e),t[0]<0||t[1]<0||t[1]>=this.nrows||t[0]>=this.ncols?null:this.map[Math.floor(t[0])+Math.floor(t[1])*this.ncols]},o.prototype.initMapTiles=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;this.pause(),this.section_center=[],f=[],console.debug("Max layers: "+this.max_layers);for(a=l=1,p=this.max_layers;1<=p?l<=p:l>=p;a=1<=p?++l:--l)f.push(a);this.renderer.createLayers(f),this.map=new Array(this.nrows*this.ncols),n=0,i=performance.now();for(e=c=0,d=this.nrows-1;0<=d?c<=d:c>=d;e=0<=d?++c:--c)for(t=h=0,v=this.ncols-1;0<=v?h<=v:h>=v;t=0<=v?++h:--h)o=t/2*this.tilew,u=(e+t%2/2)*this.tileh,r=this.tm.newTile({shape:this.iso_shape,x:o,y:u,row:e,col:t}),this.map[n]=this.addEntity(r),this.sections.center.insert(this.map[n]),this.sections.ne.insert(this.map[n]),this.sections.n.insert(this.map[n]),this.sections.nw.insert(this.map[n]),this.sections.e.insert(this.map[n]),this.sections.w.insert(this.map[n]),this.sections.se.insert(this.map[n]),this.sections.s.insert(this.map[n]),this.sections.sw.insert(this.map[n]),n++;return s=performance.now()-i,llogd("Initializing sections took: "+s+" ms"),this.startTile=this.getTileAt([0,0]),this.endTile=this.getTileAt([this.bounds[2],this.bounds[3]]),console.debug(this.startTile),console.debug(this.endTile),this.trigger("MAP_TILES_INITIALIZED"),this.resume()},o.prototype.initMap=function(){return this.clicked_layer=null,this.on("TM_TILES_LOADED",function(){return this.loadMap()}),this.on("TM_MARKERS_LOADED",function(){}),this.tm=new n(this)},o.prototype.worldCenter=function(){return this.world_center[0]=(this.world_bounds[2]-this.world_bounds[0])*.5,this.world_center[1]=(this.world_bounds[3]-this.world_bounds[1])*.5,this.world_center},o.prototype.worldCenterTile=function(){return this.getTileAt(this.world_center)},o.prototype.saveBitmapMap=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;this.pause(),f=performance.now(),u=[],p=this.map.slice(),i=this.nrows<<32,r=this.ncols<<16,u.push(i|r);for(d=0,m=p.length;d<m;d++){a=p[d],h=a.row<<32,c=a.col<<16,u.push(h|c);for(n=v=0,g=this.max_layers;0<=g?v<g:v>g;n=0<=g?++v:--v){t=a.layers[n];if(t==null){u.push(-1);continue}s=this.tm.findByName(t.name),o=s.id<<32,e=t.h<<16,u.push(e|o)}}return l=performance.now()-f,this.resume(),console.info("Saving took: "+l+" ms"),this.trigger("SECTION_SAVED",u),u.reverse()},o.prototype.loadBitmapMap=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;e=e.slice(),f=performance.now(),this.pause(),u=65535,a=e.pop(),o=a>>32&u,s=a>>16&u,v=o*s;if(v>this.nrows*this.ncols||v===0)return console.error("Can't load this bitmap, it's too big"),this.resume(),!1;this.nrows=o,this.ncols=s;while((p=e.pop())!=null){d=p>>32&u,h=p>>16&u,c=this.getTile(d,h);if(c==null){console.warn("Oh snap, something's wrong, will try to recover");continue}for(t=m=0,g=this.max_layers;0<=g?m<g:m>g;t=0<=g?++m:--m){i=e.pop();if(i===-1)continue;r=i>>32&u,n=i>>16&u,this.tm.addTileLayerMetaByLayerId(d,h,r,0,n)}}return l=performance.now()-f,this.resume(),console.info("Loading took: "+l+" ms"),this.trigger("MAP_LOADED"),!0},o.prototype.loadMap=function(){return this.setWorldBounds(this.world_bounds),this.world_center[0]=(this.world_bounds[2]-this.world_bounds[0])*.5,this.world_center[1]=(this.world_bounds[3]-this.world_bounds[1])*.5,this.initMapTiles()},o.prototype.processLeftClick=function(){var e,t,n,r,o,u,a;this.clicked_layer!=null&&(this.clicked_layer.trigger("DESELECTED"),this.clicked_layer=null),t=performance.now(),this.tiles_found=[],this.quadtree.findEntitiesInRectangle(this.search_range,this._transform,this.tiles_found),a=this.tiles_found;for(o=0,u=a.length;o<u;o++){e=a[o],r=i.transformPoint(this.world_pos[0],this.world_pos[1],e.inverseTransform());if(Hal.im.isTransparent(e.sprite.img,r[0]+e.sprite.w2,r[1]+e.sprite.h2)){s.release(r);continue}s.release(r),this.clicked_layer==null?this.clicked_layer=e:e.tile.col===this.clicked_layer.tile.col&&e.tile.row===this.clicked_layer.tile.row?e.layer>this.clicked_layer.layer&&(this.clicked_layer=e):e.tile.row===this.clicked_layer.tile.row?e.h+e.position[1]>this.clicked_layer.h+this.clicked_layer.position[1]&&(this.clicked_layer=e):e.tile.col===this.clicked_layer.tile.col?e.h+e.position[1]>this.clicked_layer.h+this.clicked_layer.position[1]&&(this.clicked_layer=e):e.tile.col!==this.clicked_layer.tile.col&&e.tile.row!==this.clicked_layer.tile.row&&e.h+e.position[1]>this.clicked_layer.h+this.clicked_layer.position[1]&&(this.clicked_layer=e)}n=performance.now()-t,llogd("Searching took: "+n.toFixed(2)+" ms"),llogd("Tiles found: "+this.tiles_found.length);if(this.clicked_layer!=null)return this.trigger("LAYER_SELECTED",this.clicked_layer),this.clicked_layer.trigger("SELECTED")},o.prototype.draw=function(e){return o.__super__.draw.call(this,e),this.ctx.setTransform(this._transform[0],this._transform[3],this._transform[1],this._transform[4],this._transform[2],this._transform[5]),this.drawQuadTree(this.quadtree)},o.prototype.destroy=function(){var e,t,n,r,i,u,a;s.release(this.mpos),s.release(this.world_pos),u=this.mouse_moved_listeners;for(t=0,r=u.length;t<r;t++)e=u[t],Hal.removeTrigger("MOUSE_MOVE",e);a=this.mouse_left_click_listeners;for(n=0,i=a.length;n<i;n++)e=a[n],Hal.removeTrigger("LEFT_CLICK",e);return o.__super__.destroy.call(this)},o.prototype.initListeners=function(){var e=this;o.__super__.initListeners.call(this),this.mouse_left_click_listeners=[],this.mouse_moved_listeners=[],this.change_end_start_coords=Hal.on("RESIZE",function(t){return e.screen_end=[e.bounds[2]+2*e.tilew,e.bounds[3]+2*e.tileh]}),this.setMouseMoveListener(function(e){var t;s.copy(this.mpos,e),this.world_pos!=null&&s.release(this.world_pos),this.world_pos=this.screenToWorld(e),t=this.getTileAt(this.world_pos);if(t==null)return;if(this.tile_under_mouse!==t)return this.trigger("OVER_NEW_TILE",t),this.tile_under_mouse=t}),Hal.on("SAVE_MAP",function(){return e.saveBitmapMap()})},o.prototype.setMouseLeftClickListener=function(e){var t=this;return this.mouse_left_click_listeners.push(e),Hal.on("LEFT_CLICK",function(n){return e.call(t,n)})},o.prototype.setMouseMoveListener=function(e){var t=this;return this.mouse_moved_listeners.push(e),Hal.on("MOUSE_MOVE",function(n){return e.call(t,n)})},o.prototype.saveMap=function(){},o}(e),o})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("line",["vec2","matrix3","shape","geometry","mathutil"],function(e,n,r,i,s){var o;return o=function(n){function r(t,n){return r.__super__.constructor.call(this),this.setShape([e.from(0,0),e.from(t,n)]),this}return t(r,n),r}(r),o.prototype.setShape=function(e){if(e.length>2){lloge("This is a line, not a polygon"),this.destroyShape();return}return o.__super__.setShape.call(this,e),this.setOrigin(Number.MIN_VALUE,Number.MIN_VALUE),this},o.prototype.angleBetween=function(t){var n;return n=e.transformMat3(null,t._mesh[1],this._transform),i.angleBetweenLines(n,this._mesh[1])},o})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("halal",["logger","eventdispatcher","scene","dommanager","renderer","geometry","vec2","matrix3","deferred","deferredcounter","domeventmanager","assetmanager","imgutils","isometricscene","ajax","shape","line","mathutil","bbresolvers","drawable"],function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){var E,S,x,T,N,C,k,L,A,O,M,_,D,P;return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1)}}(),window.performance==null&&(window.performance=Date),x=performance.now(),T=0,A=1,S=0,L=0,M=0,D=0,k=30,O=1/k,N=null,_=!0,C=null,P=function(){return D=x,x=performance.now(),T=(x-D)*.001,S+=T,T=Math.min(T,O),Hal.trigger("ENTER_FRAME",T),C!=null&&!C.paused&&(C.update(T),C.draw(T)),S>=A&&(Hal.fps=L,S=0,L=0,Hal.trigger("FPS_UPDATE",Hal.fps)),Hal.trigger("EXIT_FRAME",T),M=requestAnimFrame(P),L++},E=function(e){function n(){n.__super__.constructor.call(this),this.dom=new i(this),this.glass_z_index=100,this.id=0,this.debug_mode=!1,this.pressed_keys=[],this.scenes=[],this.fps=0,this.glass=null,llogd("Engine constructed")}return t(n,e),n}(n),E.prototype.setFocusedScene=function(e){return C=e},E.prototype.addScene=function(e,t){return t==null&&(t=!0),this.scenes.length===0&&this.glass==null&&this.start(),e instanceof r?e.bounds?(e.name||(llogw("Name for scene wasn't provided"),e.name="#scene_"+e.id),e.init(),this.scenes.unshift(e),llogd("Added scene: "+e.name),Hal.trigger("SCENE_ADDED",e),t&&(C=e),e):(lloge("Bounds not set on scene "+e.name),null):(lloge("Not a Scene instance"),null)},E.prototype.pause=function(){return _=!0,cancelAnimationFrame(M),this.trigger("ENGINE_PAUSED")},E.prototype.resume=function(){return _=!1,P(),this.trigger("ENGINE_RESUMED")},E.prototype.viewportBounds=function(){return[0,0,this.dom.area.width,this.dom.area.height]},E.prototype.supports=function(e){return this.trigger("SUPPORTS_"+e)},E.prototype.init=function(){return this.evm=new c,this.glass=new s(this.viewportBounds(),null,this.glass_z_index,!0),this.glass.ctx.font="9pt monospace",this.glass.ctx.fillStyle="black",this.on("SCENE_REQ_DESTROY",function(e){var t;return t=this.scenes.indexOf(e),t===-1&&lloge("No such scene: "+e.name),this.scenes.splice(t,1),C===e&&(C=null),this.scenes.length===0&&(this.dom.removeCanvasLayer(this.glass_z_index),this.pause()),llogi("Destroyed scene: "+e.name),e=null}),llogd("Engine initialized")},E.prototype.start=function(){return this.init(),_=!1,this.trigger("ENGINE_STARTED"),llogd("Engine started"),P()},E.prototype.isPaused=function(){return _},E.prototype.debug=function(e){return this.debug_mode=e,Hal.trigger("DEBUG_MODE",this.debug_mode)},E.prototype.ID=function(){return++this.id},E.prototype.tween=function(e,t,n,r,i,s,o){var u,a,l,c,h;return s==null&&(s=1),l=new f,n*=.001,a=0,c=(i-r)/n,h=r,Hal.on("ENTER_FRAME",u=function(f){a+=f,h+=c*f,e.attr(t,h,o),a=Math.min(a,n);if(n===a){s--,e.attr(t,i,o);if(s!==0)return a=0,h=r;l.resolve(e,u),Hal.removeTrigger("ENTER_FRAME",u)}}),[l.promise(),u]},E.prototype.tweenF=function(e,t,n,r,i){var s,o,u,a;i==null&&(i=1),e*=.001,o=0,u=(r-n)/e,a=n,Hal.on("ENTER_FRAME",s=function(f){o+=f,a+=u*f,t(a,f),o=Math.min(o,e);if(e===o){i--,t(r,f);if(i!==0)return o=0,a=n;Hal.removeTrigger("ENTER_FRAME",s)}})},E.prototype.fadeInViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},0,1)},E.prototype.fadeOutViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},1,0)},E.prototype.math=y,E.prototype.geometry=o,E.prototype.asm=new h,E.prototype.im=new p,E.prototype.Line=g,E.prototype.Vec2=u,E.prototype.Matrix3=a,E.prototype.Shape=m,E.prototype.Scene=r,E.prototype.Ajax=v,E.prototype.BBResolvers=b,E.prototype.DrawableStates=w.DrawableStates,E.prototype.IsometricScene=d,E.prototype.Deferred=f,E.prototype.DeferredCounter=l,E.prototype.Keys={SHIFT:16,G:71,D:68,W:87,C:67,I:73,ONE:49,TWO:50,THREE:51,FOUR:52,DELETE:46,SPACE:32,LEFT:37,RIGHT:39,UP:38,DOWN:40,F:70},window.Hal=new E})}.call(this);