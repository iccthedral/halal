(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["eventdispatcher","scene","dommanager","renderer","mathutil","vec2","deferred","deferredcounter","domeventmanager","assetmanager","imgutils","entity","spriteentity","isometricmap"],function(e,n,r,i,s,o,u,a,f,l,c){var h,p,d,v,m,g,y,b,w,E,S,x,T;return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1)}}(),window.performance==null&&(window.performance=Date),d=performance.now(),v=0,b=1,p=0,y=0,E=0,x=0,g=30,w=1/g,m=null,S=!0,T=function(){var e,t,n,r;x=d,d=performance.now(),v=(d-x)*.001,p+=v,v=Math.min(v,w),Hal.trigger("ENTER_FRAME",v),r=Hal.scenes;for(t=0,n=r.length;t<n;t++)e=r[t],e.update(v),e.draw(v);return p>=b&&(Hal.fps=y,p=0,y=0,Hal.trigger("FPS_UPDATE",Hal.fps)),Hal.trigger("EXIT_FRAME",v),E=requestAnimFrame(T),y++},h=function(e){function n(){n.__super__.constructor.call(this),this.dom=new r(this),this.math=s,this.id=0,this.debug_mode=!1,this.pressed_keys=[],this.scenes=[],this.fps=0,log.debug("Engine constructed")}return t(n,e),n}(e),h.prototype.addScene=function(e){return e instanceof n?e.bounds?(e.name||(log.warn("Name for scene wasn't provided"),e.name="#scene_"+e.id),e.init(),Hal.trigger("SCENE_ADDED_"+e.name.toUpperCase(),e),this.scenes.unshift(e),log.debug("Added scene: "+e.name),e):(log.error("Bounds not set on scene "+e.name),null):(log.error("Not a Scene instance"),null)},h.prototype.pause=function(){return cancelAnimationFrame(E),S=!0,this.trigger("ENGINE_PAUSED")},h.prototype.resume=function(){return S=!1,T(),this.trigger("ENGINE_RESUMED")},h.prototype.viewportBounds=function(){return[0,0,this.dom.area.width,this.dom.area.height]},h.prototype.supports=function(e){return this.trigger("SUPPORTS_"+e)},h.prototype.init=function(){return this.evm=new f,this.on("MOUSE_MOVE",function(e){var t,n,r,i,s;i=this.scenes,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.mpos=e,s.push(t.world_pos=t.worldToLocal(e));return s}),this.on("DESTROY_SCENE",function(e){var t;return t=this.scenes.indexOf(e),t===-1&&log.error("No such scene: "+e.name),this.scenes[t]=null,this.scenes.splice(t,1)}),log.debug("Engine initialized")},h.prototype.start=function(){return this.init(),S=!1,this.trigger("ENGINE_STARTED"),log.debug("Engine started"),T()},h.prototype.isPaused=function(){return S},h.prototype.debug=function(e){this.debug_mode=e},h.prototype.ID=function(){return++this.id},h.prototype.drawInfo=function(){return this.glass.ctx.setTransform(1,0,0,1,0,0),this.glass.ctx.fillStyle="black",this.glass.ctx.fillText("FPS: "+this.fps,0,10)},h.prototype.tween=function(e,t,n,r,i,s){var o,a,f,l,c;return s==null&&(s=1),f=new u,n*=.001,a=0,l=(i-r)/n,c=r,Hal.on("ENTER_FRAME",o=function(u){a+=u,c+=l*u,e.attr(t,c),a=Math.min(a,n);if(n===a){s--,e.attr(t,i);if(s!==0)return a=0,c=r;f.resolve(e),Hal.remove("ENTER_FRAME",o)}}),f.promise()},h.prototype.tweenF=function(e,t,n,r,i){var s,o,u,a;i==null&&(i=1),e*=.001,o=0,u=(r-n)/e,a=n,Hal.on("ENTER_FRAME",s=function(f){o+=f,a+=u*f,t(a,f),o=Math.min(o,e);if(e===o){i--,t(r,f);if(i!==0)return o=0,a=n;Hal.remove("ENTER_FRAME",s)}})},h.prototype.fadeInViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},0,1)},h.prototype.fadeOutViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},1,0)},h.prototype.IsometricMap=function(e){return new IsometricMap(e)},h.prototype.Keys={SHIFT:16,G:71,D:68,W:87,C:67,I:73,ONE:49,TWO:50,THREE:51,FOUR:52,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,F:70},window.Hal=new h,window.Hal.glass=new i(Hal.viewportBounds(),null,11),window.Hal.asm=new l,window.Hal.im=new c,window.Hal})}).call(this);