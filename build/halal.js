(function(){define("logger",[],function(){var e;return e={levels:{DEBUG:function(){return window.llogi=function(e){return console.info.call(console,e)},window.lloge=function(e){return console.error.call(console,e)},window.llogd=function(e){return console.debug.call(console,e)},window.llogw=function(e){return console.warn.call(console,e)}},SILENT:function(){return window.llogi=window.lloge=window.llogd=window.llogw=function(){return window.llogw=console.warn}}},setLevel:function(t){var n;return n=t,e.levels[t].call()}},e.setLevel("DEBUG"),window.llog=e})}).call(this),function(){define("eventdispatcher",[],function(){var e;return e=function(){function e(){this.listeners={}}return e}(),e.prototype.on=function(e,t){var n,r,i,s;if(e instanceof Array)for(i=0,s=e.length;i<s;i++)r=e[i],this.listeners[r]==null&&(this.listeners[r]=[]),this.listeners[r].push(t);else this.listeners[e]==null&&(this.listeners[e]=[]),this.listeners[e].push(t),n=this.listeners[e].indexOf(t);return llogi("Added listener: TYPE = "+e),t},e.prototype.remove=function(e,t){var n;if(this.listeners[e]!=null){n=this.listeners[e].indexOf(t),n!==-1&&this.listeners[e].splice(n,1),t=null;if(n!==-1)return llogi("Removed listener: TYPE = "+e)}},e.prototype.removeAll=function(e){var t,n,r,i,s,o;if(e)return delete this.listeners[e],llogi("Removed listeners: TYPE = "+e);n=Object.keys(this.listeners),o=[];for(i=0,s=n.length;i<s;i++)t=n[i],llogi("Removed listeners: KEY = "+t),o.push(function(){var e,n,i,s;i=this.listeners[t],s=[];for(e=0,n=i.length;e<n;e++)r=i[e],s.push(this.remove(t,r));return s}.call(this));return o},e.prototype.trigger=function(e,t,n,r){var i,s,o,u,a;if(!this.listeners[e])return;u=this.listeners[e],a=[];for(s=0,o=u.length;s<o;s++)i=u[s],a.push(i.call(this,t,n,r));return a},e})}.call(this),function(){var e=[].slice;define("deferred",[],function(){var t,n;return n=function(){function e(){this.successChain=[],this.failChain=[]}return e.prototype.then=function(e){return this.successChain.push(e),this},e.prototype.fail=function(e){return this.failChain.push(e),this},e}(),t=function(){function t(e){this.prom=new n}return t.prototype.resolve=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.traverse_chain("successChain",n,t)},t.prototype.reject=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.traverse_chain("failChain",n,t)},t.prototype.promise=function(){return this.prom},t.prototype.traverse_chain=function(e,t,n){var r,i,s,o,u;t==null&&(t=this),o=this.prom[e],u=[];for(i=0,s=o.length;i<s;i++)r=o[i],u.push(r.apply(t,n));return u},t}(),t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;define("halalentity",["eventdispatcher","deferred"],function(e,r){var i,s,o,u;return s=function(){function e(e){this.obj=e,this.num_tweens=0,this.to_wait=0,this.tween_chain=[],this.animating=!1,this.clb_ids=[],this.done_clb=null,this.paused=!1}return e.prototype.tween=function(e){var t,n,r,i,s,o=this;return r=e.attr.match(/(.*)\[(\d)\]/),this.num_tweens++,this.to_wait<=0?(r!=null&&r.length===3&&(n=r[2],e.attr=r[1]),this.animating=!0,s=Hal.tween(this.obj,e.attr,e.duration,e.from,e.to,e.repeat,n),i=s[0],t=s[1],this.clb_ids.push(t),i.then(function(e){var t;t=o.clb_ids.indexOf(e),o.clb_ids.splice(t,1),o.num_tweens--,o.to_wait>0&&o.num_tweens!==0&&!o.paused&&(o.to_wait--,o.tween(o.tween_chain.pop()),o.num_tweens--),o.num_tweens===0&&o.done_clb!=null&&!o.paused&&o.done_clb.call(o.obj);if(o.num_tweens===0&&o.to_wait===0)return o.animating=!1}),this):(this.tween_chain.push(e),this)},e.prototype.wait=function(e,t){return this.to_wait++,this},e.prototype.pause=function(){var e,t,n,r;this.paused=!0,r=this.clb_ids;for(t=0,n=r.length;t<n;t++)e=r[t],Hal.remove("ENTER_FRAME",e);return this},e.prototype.resume=function(){var e,t,n,r;this.paused=!1,r=this.clb_ids;for(t=0,n=r.length;t<n;t++)e=r[t],Hal.on("ENTER_FRAME",e);return this},e.prototype.stop=function(){var e,t,n,r;this.paused=!0,r=this.clb_ids;for(t=0,n=r.length;t<n;t++)e=r[t],Hal.remove("ENTER_FRAME",e);return this.clb_ids=[],this.num_tweens=0,this.to_wait=0,this.animating=!1,this.wait_clb=null,this.done_clb=null,this.tween_chain=[],this},e.prototype.done=function(e){return this.done_clb=e,this},e}(),o={},i=function(e){function r(){return u=r.__super__.constructor.apply(this,arguments),u}return t(r,e),r.include=function(){var e,t,r,i,s,u;r=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.prototype.__classex__=this.name,r.prototype.constructor!=null&&(llogi("Copying constructor from "+this.name),o[this.name]==null&&(o[this.name]=[]),o[this.name].push(r.prototype.constructor)),llogi("Extending from "+this.name+" with "+r.name);if(!r.prototype)throw"include(obj) requires obj";s=r.prototype,u=[];for(t in s){i=s[t];if(t==="constructor")continue;this.prototype[t]!=null&&lloge("Added to inheritance chain fn: "+t),this.prototype[t]=i,u.push(llogd("Extended with "+t))}return u},r}(e),i.prototype.constructor=function(){var e,t,n,r;i.__super__.constructor.call(this);if(o[this.__classex__]){r=o[this.__classex__];for(t=0,n=r.length;t<n;t++)e=r[t],llogd("Calling "+this.__classex__+" constructor"),e.call(this)}return this.tweener=new s(this),this.init(),this},i.prototype.init=function(){return this},i.prototype.attr=function(e,t,n){if(arguments.length===1){if(typeof e=="string")return this[e];this.extend(e)}else n!=null?this[e][n]=t:this[e]=t;return this.trigger("CHANGE",e,t),this},i.prototype.extend=function(e,t){var n,r;if(e==null)return this;for(n in e){r=e[n];if(this===r)continue;typeof r=="function"&&t?(llogi("is a function "+n),this.prototype[n]=r):this[n]=r}return this},i.prototype.tween=function(e){return this.tweener.stop(),this.tweener.tween(e)},i})}.call(this),function(){define("renderer",[],function(){var e;return e=function(){function e(e,t,n){this.bounds=e,t!=null?this.canvas=t:(this.canvas=Hal.dom.createCanvasLayer(this.bounds[2],this.bounds[3],n),Hal.dom.addCanvas(this.canvas,this.bounds[0],this.bounds[1],!0)),this.ctx=this.canvas.getContext("2d")}return e}(),e.prototype.resize=function(e,t){return this.canvas.width=e,this.canvas.height=t,this.prev_bnds=this.bounds.slice(),this.bounds[2]=e,this.bounds[3]=t},e.prototype.strokeRect=function(e,t){return this.ctx.strokeStyle=t,this.ctx.strokeRect(e[0],e[1],e[2],e[3])},e.prototype.strokeRectO=function(e,t){return this.ctx.strokeStyle=t,this.ctx.strokeRect(e[0]-e[2]*.5,e[1]-e[3]*.5,e[2],e[3])},e.prototype.drawSprite=function(e,t,n){return t==null&&(t=0),n==null&&(n=0),this.ctx.drawImage(e.img,-e.w2-t,-e.h2-n)},e})}.call(this),function(){define("mathutil",[],function(){var e;return e={ARRAY_TYPE:typeof Float32Array!="undefined"?Float32Array:Array,TAU:Math.PI*2,EPSILON:1e-6,DEGREE:Math.PI/180,RADIAN:180/Math.PI},e.clamp=function(e,t,n){return e<t?e=t:e>n&&(e=n),e},e})}.call(this),function(){define("vec2",["mathutil"],function(e){var t,n,r,i,s;n={},t=[],n.free=1e4,n.max=1e4;for(r=i=0,s=n.max;0<=s?i<s:i>s;r=0<=s?++i:--i)t.push(new e.ARRAY_TYPE(2));return n.release=function(e){if(n.free>n.max){alert("you released a vector which you didn't acquired");return}return n.free++,n.free=t.push(e)},n.acquire=function(){if(n.free<=0){alert("no more vectors in pool");return}return n.free--,t.pop()},n.create=function(){return n.acquire()},n.newFrom=function(e){var t;return t=n.acquire(),t[0]=e[0],t[1]=e[1],t},n.clone=function(e){var t;return t=n.acquire(),t[0]=e[0],t[1]=e[1],t},n.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},n.from=function(e,t){var r;return r=n.acquire(),r[0]=e,r[1]=t,r},n.set=function(e,t,n){return e[0]=t,e[1]=n,e},n.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},n.sub=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e},n.mul=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},n.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},n.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},n.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},n.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},n.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},n.addAndScale=function(e,t,n,r){return e[0]=(t[0]+n[0])*r,e[1]=(t[1]+n[1])*r,e},n.distance=function(e,t){var n,r;return n=t[0]-e[0],r=t[1]-e[1],Math.sqrt(n*n+r*r)},n.sqDistance=function(e,t){var n,r;return n=t[0]-e[0],r=t[1]-e[1],n*n+r*r},n.length=function(e){var t,n;return t=e[0],n=e[1],Math.sqrt(t*t+n*n)},n.sqLength=function(e){var t,n;return t=e[0],n=e[1],t*t+n*n},n.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},n.normalize=function(e,t){var n,r,i;return r=t[0],i=t[1],n=r*r+i*i,n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n),e},n.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},n.lerp=function(e,t,n,r){var i,s;return i=t[0],s=t[1],e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e},n.random=function(e,t){var n;return t==null&&(t=1),n=Math.random()*2*Math.PI,e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},n.transformMat3=function(e,t,n){return e[0]=n[0]*t[0]+n[1]*t[1]+n[2],e[1]=n[3]*t[0]+n[4]*t[1]+n[5],e},n.perpendicular=function(e,t){return e[0]=t[1],e[1]=-t[0],e},n.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},n})}.call(this),function(){define("matrix3",["mathutil"],function(e){var t;return t={},t.create=function(){var t;return t=new e.ARRAY_TYPE(9),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},t.inverse=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;return n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p,d?(d=1/d,e[0]=c*d,e[1]=(-l*r+i*f)*d,e[2]=(u*r-i*o)*d,e[3]=h*d,e[4]=(l*n-i*a)*d,e[5]=(-u*n+i*s)*d,e[6]=p*d,e[7]=(-f*n+r*a)*d,e[8]=(o*n-r*s)*d,e):null},t.translate=function(t,n){var r;return r=new e.ARRAY_TYPE(9),r[0]=1,r[1]=0,r[2]=t,r[3]=0,r[4]=1,r[5]=n,r[6]=0,r[7]=0,r[8]=1,r},t.scale=function(t,n){var r;return t==null&&(t=1),n==null&&(n=1),r=new e.ARRAY_TYPE(9),r[0]=t,r[1]=0,r[2]=0,r[3]=0,r[4]=n,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},t.rotate=function(t,n,r){var i;return n==null&&(n=0),r==null&&(r=0),i=new e.ARRAY_TYPE(9),i[0]=Math.cos(t),i[1]=-Math.sin(t),i[2]=0,i[3]=Math.sin(t),i[4]=Math.cos(t),i[5]=0,i[6]=0,i[7]=0,i[8]=1,i},t.transpose=function(e,t){var n,r,i;return e===t?(n=t[1],r=t[2],i=t[5],e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=i):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e},t.clone=function(t){var n;return n=new e.ARRAY_TYPE(9),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n},t.copy=function(e){return out[0]=e[0],out[1]=e[1],out[2]=e[2],out[3]=e[3],out[4]=e[4],out[5]=e[5],out[6]=e[6],out[7]=e[7],out[8]=e[8],out},t.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.mul=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;return e=[],r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=n[0],p=n[1],d=n[2],v=n[3],m=n[4],g=n[5],y=n[6],b=n[7],w=n[8],e[0]=h*r+p*o+d*f,e[1]=h*i+p*u+d*l,e[2]=h*s+p*a+d*c,e[3]=v*r+m*o+g*f,e[4]=v*i+m*u+g*l,e[5]=v*s+m*a+g*c,e[6]=y*r+b*o+w*f,e[7]=y*i+b*u+w*l,e[8]=y*s+b*a+w*c,e},t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("camera",["vec2","halalentity","renderer","matrix3"],function(e,n,r,i){var s;return s=function(n){function r(e,t,n){var i,s=this;this.ctx=e,this.scene=n,r.__super__.constructor.call(this),this.x=t[0],this.y=t[1],this.w=this.scene.bounds[2],this.h=this.scene.bounds[3],this.dragging=!1,this.start_drag_point=[0,0],this.prev_pos=[this.x,this.y],this.zoom=1,this.zoom_step=.1,this.camera_speed=1.8,this.angle=0,this.view_frustum=[],this.recalcCamera(),this.setViewFrustum(t),i=Hal.dom.createCanvasLayer(this.w,this.h,5e4),Hal.dom.addCanvas(i,0,0,!0),this.cctx=i.getContext("2d"),this.on("CHANGE",function(e){var t;if(e==null)return;if((t=e[0])==="w2"||t==="w"||t==="h2"||t==="h")return this.clipViewport()}),this.scene.on(["ENTER_FULLSCREEN","EXIT_FULLSCREEN"],function(e){return s.zoom=e[0],s.recalcCamera(),s.trigger("CHANGE")})}return t(r,n),r.prototype.recalcCamera=function(){return this.w*=this.zoom,this.h*=this.zoom,this.w2=this.w*.5,this.h2=this.h*.5,this.cx=this.w2,this.cy=this.h2},r.prototype.resize=function(e,t){return this.w=e/this.zoom,this.h=t/this.zoom,this.recalcCamera(),this.trigger("CHANGE")},r.prototype.clipViewport=function(){return this.cctx.fillStyle="rgba(0, 0, 0, 255);",this.cctx.fillRect(0,0,this.w,this.h),this.cctx.translate(this.cx,this.cy),this.cctx.clearRect(-this.w2,-this.h2,this.w,this.h),this.cctx.translate(-this.cx,-this.cy)},r.prototype.enableDrag=function(){var e=this;return this.drag_started=Hal.on("DRAG_STARTED",function(t){if(e.scene.paused)return;return e.lerp_anim&&(Hal.remove("EXIT_FRAME",e.lerp_anim),e.lerp_anim=null),e.dragging=!0,e.start_drag_point=t.slice(),e.prev_pos=[e.x*e.zoom,e.y*e.zoom]}),this.drag_ended=Hal.on("DRAG_ENDED",function(t){return e.dragging=!1}),this.drag=Hal.on("MOUSE_MOVE",function(t){if(e.scene.paused)return;if(e.dragging)return e.x=(e.prev_pos[0]+(t[0]-e.start_drag_point[0]))/e.zoom,e.y=(e.prev_pos[1]+(t[1]-e.start_drag_point[1]))/e.zoom,e.viewport=Hal.math.transformRect([e.x,e.y,e.w,e.h],i.mul(i.scale(e.zoom,e.zoom),i.translate(-e.x,-e.y))),e.trigger("CHANGE",e.pos)})},r.prototype.enableZoom=function(){var e=this;return this.zoom_trig=Hal.on("SCROLL",function(t){if(e.scene.paused)return;return t.down?e.zoom-=e.zoom_step:e.zoom+=e.zoom_step,e.trigger("CHANGE",e.pos),e.trigger("ZOOM",e.zoom)})},r.prototype.setViewFrustum=function(e){return this.view_frustum[0]=e[0],this.view_frustum[1]=e[1],this.view_frustum[2]=e[2]-e[0],this.view_frustum[3]=e[3]-e[1],Hal.log.debug("Camera view frustum setted"),Hal.log.debug(this.view_frustum)},r.prototype.enableArrowKeys=function(){var e=this;return this.arrkeys=Hal.on("KEY_DOWN",function(t){t.keyCode===Hal.Keys.LEFT&&e.lerpTo([e.cx-e.camera_speed,e.cy]),t.keyCode===Hal.Keys.RIGHT&&e.lerpTo([e.cx+e.camera_speed,e.cy]),t.keyCode===Hal.Keys.UP&&e.lerpTo([e.cx,e.cy-e.camera_speed]);if(t.keyCode===Hal.Keys.DOWN)return e.lerpTo([e.cx,e.cy+e.camera_speed])})},r.prototype.disableArrowKeys=function(){return Hal.removeTrigger("KEY_DOWN",this.arrkeys)},r.prototype.enableLerp=function(){return this.lerpTo=function(t){var n,r,i=this;if(this.scene.paused)return;return n=this.cx-t[0]+this.x,r=this.cy-t[1]+this.y,this.lerp_anim&&(Hal.remove("EXIT_FRAME",this.lerp_anim),this.lerp_anim=null),this.lerp_anim=Hal.on("EXIT_FRAME",function(t){var s;return s=e.lerp([],[i.x,i.y],[n,r],t*i.camera_speed),i.x=s[0],i.y=s[1],~~Math.abs(i.x-n)+~~Math.abs(-i.y+r)<2&&(Hal.remove("EXIT_FRAME",i.lerp_anim),i.lerp_anim=null),i.trigger("CHANGE")})}},r.prototype.lerpTo=function(){},r.prototype.disableLerp=function(){return this.lerpTo=function(){}},r.prototype.disableZoom=function(){return Hal.removeTrigger("SCROLL",this.zoom_trig)},r.prototype.disableDrag=function(){return Hal.removeTrigger("DRAG_STARTED",this.drag_started),Hal.removeTrigger("DRAG_ENDED",this.drag_ended),Hal.removeTrigger("MOUSE_MOVE",this.drag)},r}(n),s})}.call(this),function(){define("quadtree",["vec2"],function(e){var t,n,r;return n=1,r=0,t=function(){function e(e){this.bounds=e,this.pts=[],this.nw=null,this.sw=null,this.ne=null,this.se=null,this.id=Hal.ID()}return e.prototype.total=function(){return r},e.prototype.insert=function(e){return Hal.math.isPointInRect(e.worldPos(),this.bounds)?this.pts.length<n?(e.quadspace=this,this.pts.push(e),r++,!0):(this.nw==null&&this.divide(),this.nw.insert(e)?!0:this.ne.insert(e)?!0:this.sw.insert(e)?!0:this.se.insert(e)?!0:!1):!1},e.prototype.remove=function(e){var t;t=this.pts.indexOf(e);if(t===-1)return;return this.pts.splice(t,1),r--},e.prototype.searchInRange=function(e,t,n){var r,i,s,o,u,a,f;i=[],s=[e[0]-t,e[1]-t,2*t,2*t];if(!Hal.math.rectIntersectsRect(s,this.bounds))return i;f=this.pts;for(u=0,a=f.length;u<a;u++)o=f[u],r=o.worldToLocal(n.localToWorld(e)),Hal.math.rectIntersectsRect(o.bbox,[r[0]-t*.5,r[1]-t*.5,t,t])&&i.push(o);return this.nw==null?i:(i=i.concat(this.nw.searchInRange(e,t,n)),i=i.concat(this.ne.searchInRange(e,t,n)),i=i.concat(this.sw.searchInRange(e,t,n)),i=i.concat(this.se.searchInRange(e,t,n)),i)},e.prototype.divide=function(){var t,n;return n=this.bounds[2]*.5,t=this.bounds[3]*.5,this.nw=new e([this.bounds[0],this.bounds[1],n,t]),this.ne=new e([this.bounds[0]+n,this.bounds[1],n,t]),this.sw=new e([this.bounds[0],this.bounds[1]+t,n,t]),this.se=new e([this.bounds[0]+n,this.bounds[1]+t,n,t])},e}(),t})}.call(this),function(){define("geometry",["vec2","matrix3","mathutil"],function(e,t,n){var r;return r=new Object,r.toDegrees=function(e){return e*n.RADIAN},r.toRadians=function(e){return e*n.DEGREE},r.angleOfPoint=function(e){var t;return t=Math.atan2(-e[1],e[0]),t<0&&(t+=Math.PI*2),t},r.angleOfLines=function(t,n){return t=e.normalize([],t),n=e.normalize([],n),Math.acos(e.dot(t,n))},r.createRegularPolygon=function(t,r){var i,s,o,u,a,f,l;o=[],s=n.TAU/t,i=0;for(u=l=0;0<=t?l<t:l>t;u=0<=t?++l:--l)a=r*Math.cos(i),f=r*Math.sin(i),o.push(e.from(a,f)),i+=s;return o},r.createStarPolygon=function(t,n,r){var i,s,o,u,a,f,l,c;i=this.createRegularPolygon(n,t),u=i.length,o=[],s=0,f=[];while(s<u)l=e.newFrom(i[s]),c=e.newFrom(i[(s+1)%u]),a=e.addAndScale([],l,c,.5),f=e.sub([],c,l),f=e.perpendicular([],f),f=e.normalize([],f),f=e.scale([],f,r),f[0]+=a[0],f[1]+=a[1],i.push(f),++s;return this.polygonSortVertices(i)},r.createPolygonFromRectangle=function(t,n){return[e.from(-t,-n),e.from(t,n),e.from(t,-n),e.from(-t,n)]},r.isPointInRectangle=function(e,t){return e[0]>=t[0]&&e[0]<=t[0]+t[2]&&e[1]>=t[1]&&e[1]<=t[1]+t[3]},r.isPointInCircle=function(e,t,n){var r,i,s;return i=e[0]-t[0]||0,s=e[1]-t[1]||0,r=Math.sqrt(i*i+s*s),r<n},r.isPointInPolygonDeprecated=function(e,t){var r,i,s,o,u,a;r=[-1e7,e[1]-n.EPSILON],i=e,s=0,u=t.length;for(o=a=0;0<=u?a<u:a>u;o=0<=u?++a:--a)this.lineIntersectsLine(r,i,t[o],t[(o+1)%u])&&s++;return s%2!==0},r.isPointInPolygon=function(e,t){var n,r,i,s,o,u,a;o=u=i=0,n=s=!1,r=t.length,o=r-1;for(u=a=0;0<=r?a<r:a>r;u=0<=r?++a:--a)i=this.isPointLeftOrRightOfLine(e,t[o],t[u]),i>0&&(s=!0),i<0&&(n=!0),o=u;return!n||!s},r.isPolygonConvex=function(e){var t,n,r,i,s,o,u,a;s=o=r,t=i=!1,n=e.length;if(n<=3)return!0;s=n-2,o=n-1;for(u=a=0;0<=n?a<n:a>n;u=0<=n?++a:--a)r=this.isPointLeftOrRightOfLine(e[u],e[s],e[o]),r>0&&(i=!0),r<0&&(t=!0),s=o,o=u;return!t||!i},r.isPointLeftOrRightOfLine=function(e,t,n){var r;return r=(n[1]-t[1])*e[0]-(n[0]-t[0])*e[1]+t[1]*n[0]-t[0]*n[1],r},r.rectangleContainsRectangle=function(e,t){return e[0]>=t[0]&&e[1]>=t[1]&&e[0]+e[2]<=t[0]+t[2]&&e[1]+e[3]<=t[1]+t[3]},r.rectangleContainsCircle=function(e,t,n){return!1},r.rectangleIntersectsRectangle=function(e,t){return e[0]<=t[0]+t[2]&&e[0]+e[2]>=t[0]&&e[1]<=t[1]+t[3]&&e[3]+e[1]>=t[1]},r.rectangeIntersectsOrContainsRectangle=function(e,t){return this.rectangleIntersectsRectangle(e,t)||this.rectangleContainsRectangle(e,t)},r.rectangleIntersectsOrContainsCircle=function(e,t,n){return this.rectangleIntersectsCircle(e,t,n)||this.isPointInRectangle(t,e)},r.rectangleIntersectsCircle=function(e,t,n){return this.lineIntersectsCircle([[e[0],e[1]],[e[0]+e[2],e[1]]],t,n)||this.lineIntersectsCircle([[e[0]+e[2],e[1]],[e[0]+e[2],e[1]+e[3]]],t,n)||this.lineIntersectsCircle([[e[0]+e[2],e[1]+e[3]],[e[0],e[1]+e[3]]],t,n)||this.lineIntersectsCircle([[e[0],e[1]+e[3]],[e[0],e[1]]],t,n)},r.lineIntersectsLine=function(e,t,n,r){var i,s,o,u,a,f;return u=(e[1]-n[1])*(r[0]-n[0])-(e[0]-n[0])*(r[1]-n[1]),f=(e[1]-n[1])*(t[0]-e[0])-(e[0]-n[0])*(t[1]-e[1]),i=(t[0]-e[0])*(r[1]-n[1])-(t[1]-e[1])*(r[0]-n[0]),i===0?!1:(s=1/i,o=u*s,a=f*s,o>=0&&o<=1&&a>=0&&a<=1?!0:!1)},r.lineIntersectsPolygon=function(e,t,n){var r,i,s;i=n.length;for(r=s=0;0<=i?s<i:s>i;r=0<=i?++s:--s)if(this.lineIntersectsLine(e,t,n[r],n[(r+1)%i]))return!0;return!1},r.lineIntersectsCircle=function(e,t,n){var r;return r=this.perpendicularDistanceToLine(t,e[0],e[1]),r<n},r.polygonPointInHull=function(e){var t,n,r,i;n=e[0],t=e.length;for(r=i=1;1<=t?i<t:i>t;r=1<=t?++i:--i)if(r[0]>n[0]||r[0]===n[0]&&r[1]>n[1])n[0]=r[0],n[1]=r[1];return n},r.polygonSortVertices=function(t){var n,r,i,s,o,u,a,f,l,c,h,p;n=new Array,a=this.polygonMeanPoint(t),o=t.length;for(r=l=0;0<=o?l<o:l>o;r=0<=o?++l:--l)n[r]=this.angleOfPoint([t[r][0]-a[0],t[r][1]-a[1]]);s=new Array;for(r=c=0;0<=o?c<o:c>o;r=0<=o?++c:--c){f=n[r],u=r;while(u>0&&f>n[u-1])n[u]=n[u-1],s[u]=s[u-1],u--;n[u]=f,s[u]=r}for(r=h=0,p=s.length;h<p;r=++h)i=s[r],n[r]=t[i];return e.release(a),n},r.polygonConvexHull=function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;l=t.length;if(l<=3)return t;m=this.polygonMeanPoint(t),n=new Array;for(o=g=0;0<=l?g<l:g>l;o=0<=l?++g:--g)n[o]=this.angleOfPoint([t[o][0]-m[0],t[o][1]-m[1]]);a=0,p=t[0];for(o=y=1;1<=l?y<l:y>l;o=1<=l?++y:--y){d=t[o];if(d[0]>p[0]||d[0]===p[0]&&d[1]>p[1])p=d,a=o}v=new Array,h=new Array,s=f=u=0;for(o=b=1;1<=l?b<l:b>l;o=1<=l?++b:--b)if(n[o]<=n[s])h[o]=s,v[s]=o,s=o;else if(n[o]>=n[f])v[o]=f,h[f]=o,f=o;else{u=s;while(n[u]<n[o])u=h[u];h[o]=u,v[o]=v[u],h[v[u]]=o,v[u]=o}v[s]=f,h[f]=s,c=l,i=!1,o=a;for(;;){this.isPointLeftOrRightOfLine(t[h[h[o]]],t[o],t[h[o]])>=0?(c--,u=h[h[o]],h[o]=u,v[u]=o,o=v[o]):o=h[o],h[h[o]]===a&&(i=!0);if(!!i&&h[o]===a)break}r=[];for(o=w=0;0<=c?w<c:w>c;o=0<=c?++w:--w)r[o]=t[a],a=h[a];return e.release(m),r},r.polygonMeanPoint=function(t){var n,r,i,s,o;r=e.from(0,0),n=t.length;for(s=0,o=t.length;s<o;s++)i=t[s],r[0]+=i[0],r[1]+=i[1];return r[0]/=n,r[1]/=n,r},r.polygonArea=function(e){var t,n,r,i,s,o;r=e.length,t=0;for(n=o=0;0<=r?o<r:o>r;n=0<=r?++o:--o)i=e[n],s=e[(n+1)%r],t+=i[0]*s[1]-s[0]*i[1];return t*.5},r.polygonTransform=function(t,n){var r,i,s,o,u;r=[];for(o=0,u=t.length;o<u;o++)i=t[o],s=e.create(),e.transformMat3(s,i,n),r.push(s);return r},r.polygonCentroidPoint=function(t){var n,r,i,s,o,u,a,f;r=e.from(0,0),o=t.length,n=this.polygonArea(t)*6;for(s=f=0;0<=o?f<o:f>o;s=0<=o?++f:--f)u=t[s],a=t[(s+1)%o],i=u[0]*a[1]-a[0]*u[1],r[0]+=(u[0]+a[0])*i,r[1]+=(u[1]+a[1])*i;return r[0]=r[0]/n,r[1]=r[1]/n,r},r.polygonIntersectsPolygon=function(e,t){var n,r,i,s,o,u,a;r=e.length,i=t.length;for(n=u=0;0<=r?u<r:u>r;n=0<=r?++u:--u){s=e[n],o=e[(n+1)%r];for(n=a=0;0<=i?a<i:a>i;n=0<=i?++a:--a)if(this.lineIntersectsLine(s,o,t[n],t[(n+1)%i]))return!0}return!1},r.polygonMinkowskiSum=function(t,n,r){var i,s,o,u,a,f,l;r==null&&(r=1),o=[];for(u=0,f=t.length;u<f;u++){i=t[u];for(a=0,l=n.length;a<l;a++)s=n[a],o.push(e.from(i[0]+r*s[0],i[1]+r*s[1]))}return o},r.polygonBottomMostPoint=function(t){var n,r,i,s;r=e.from(Number.MAX_VALUE,Number.MAX_VALUE);for(i=0,s=t.length;i<s;i++)n=t[i],n[0]<r[0]&&(r[0]=n[0]),n[1]<r[1]&&(r[1]=n[1]);return r},r.polygonTopMostPoint=function(t){var n,r,i,s;r=e.from(Number.MIN_VALUE,Number.MIN_VALUE);for(i=0,s=t.length;i<s;i++)n=t[i],n[0]>r[0]&&(r[0]=n[0]),n[1]>r[1]&&(r[1]=n[1]);return r},r.projectPointOnLine=function(t,n,r){var i,s,o,u,a;return o=e.sub([],r,n),u=e.sub([],t,n),e.normalize(o,o),e.normalize(u,u),i=e.dot(u,o),s=e.distance(n,t),a=e.scale([],o,i*s),a=e.from(n[0]+a[0],n[1]+a[1]),a},r.perpendicularDistanceToLine=function(t,n,r){var i,s;return i=this.projectPointOnLine(t,n,r),s=e.distance(t,i),e.release(i),s},r.perpendicularDistanceToLineSegment=function(t,n,r){var i,s,o;return i=this.projectPointOnLine(t,n,r),o=e.distance(n,r),e.distance(n,i)>o||e.distance(r,i)>o?Number.NaN:(s=e.distance(t,i),e.release(i),s)},r.pointComparison=function(e,t,n){var r,i,s;return e[0]>=0&&t[0]<0?!0:e[0]===0&&t[0]===0?e[1]>t[1]:(s=(e[0]-n[0])*(t[1]-n[1])-(t[0]-n[0])*(e[1]-n[1]),s<0?!0:s>0?!1:(r=(e[0]-n[0])*(e[0]-n[0])+(e[1]-n[1])*(e[1]-n[1]),i=(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1]),r>i))},r})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("scene",["halalentity","renderer","camera","matrix3","quadtree","vec2","geometry"],function(e,n,r,i,s,o,u){var a;return a=function(e){function r(e){e==null&&(e={}),r.__super__.constructor.call(this),this.name=e.name!=null?e.name:""+Hal.ID(),this.bounds=e.bounds!=null?e.bounds:Hal.viewportBounds(),this.paused=!0,this.bg_color=e.bg_color!=null?e.bg_color:"white",this.entities=[],this.identity_matrix=i.create(),this.mpos=[0,0],this.viewport_pos=[0,0],this.world_pos=[0,0],this.quadspace=null,this.ent_cache={},this.ent_groups={},this.draw_camera_center=e.draw_camera_center!=null,this.draw_stat=e.draw_stat==null,this.draw_quadspace=e.draw_quadspace!=null?e.draw_quadspace:!1,this.local_matrix=i.create(),this.z=e.z!=null?e.z:1,this.g=new n(this.bounds,null,this.z),this.cam_bounds=e.cam_bounds!=null?e.cam_bounds:this.bounds.slice(),this.draw_bbox=e.draw_bbox!=null,this.needs_updating=!0,this.center=[this.bounds[2]*.5,this.bounds[3]*.5],this.search_range=this.bounds[2],this.visible_ents=[],this.total_rendered=0,this.left_click_listener=null,this.left_dbl_click_listener=null,this.on("GROUP_CHANGE",function(e){var t,n;return t=this.ent_groups[e.group],t==null&&(t=this.ent_groups[e.group]=[]),n=t.indexOf(e),n!==-1?t.splice(n,1):t.push(e)}),this._identity_update=!0}return t(r,e),r.prototype.addEntity=function(e){return this.entities.push(e),this.ent_cache[e.id]=e,e.attr("scene",this),e.trigger("ENTITY_ADDED"),this.trigger("GROUP_CHANGE",e),e},r.prototype.destroy=function(){return this.removeAllEntities(),Hal.remove("EXIT_FRAME",this.exit_frame),Hal.remove("ENTER_FRAME",this.enter_frame),Hal.remove("LEFT_CLICK",this.left_click_listener),Hal.remove("LEFT_DBL_CLICK",this.left_dbl_click_listener),Hal.remove("RESIZE",this.resize_event),Hal.trigger("DESTROY_SCENE",this),this.quadspace=null,this.camera=null,this.renderer=null,this.removeAll()},r.prototype.drawStat=function(){return Hal.glass.ctx.setTransform(1,0,0,1,0,0),Hal.glass.ctx.clearRect(0,0,400,300),Hal.glass.ctx.fillStyle="black",Hal.glass.ctx.fillText("FPS: "+Hal.fps,0,10),Hal.glass.ctx.fillText("Num of entities: "+this.entities.length,0,25),Hal.glass.ctx.fillText("Mouse: "+this.mpos[0]+", "+this.mpos[1],0,55),Hal.glass.ctx.fillText("Num of free pool vectors: "+o.free,0,70)},r.prototype.removeEntity=function(e){var t,n;if(!this.ent_cache[e.id]){log.error("No such entity "+e.id+" in cache");return}n=this.entities.indexOf(e);if(n===-1){log.error("No such entity "+e.id+" in entity list");return}return t=this.ent_groups[e.group],t!=null&&(n=t.indexOf(e),t.splice(n,1)),delete this.ent_cache[e.id],this.trigger("ENTITY_DESTROYED",e),this.entities.splice(n,1)},r.prototype.getAllEntities=function(){return this.entities.slice()},r.prototype.removeAllEntities=function(e){var t,n,r,i;e==null&&(e=!1),i=this.getAllEntities();for(n=0,r=i.length;n<r;n++)t=i[n],t.destroy(e)},r.prototype.removeEntityByID=function(e){var t;return t=this.ent_cache[e],t!=null?t.removeEntity(t):log.error("No such entity "+e+" in entity cache")},r.prototype.update=function(e){var t,n,r,i;this.g.ctx.fillStyle=this.bg_color,this.g.ctx.setTransform(1,0,0,1,0,0),this.g.ctx.fillRect(0,0,this.bounds[2],this.bounds[3]),i=this.entities;for(n=0,r=i.length;n<r;n++)t=i[n],t.update(this.g.ctx,e);return this.total_rendered=0},r.prototype.checkForCollisions=function(e){var t,n,r,i,s,a,f,l;f=this.entities,l=[];for(s=0,a=f.length;s<a;s++){n=f[s];if(n===e)continue;i=e.transformShape(n),t=u.polygonIntersectsPolygon(e._mesh,i),t&&!e.in_collision&&!n.in_collision?(e.trigger("COLLISION_STARTED",n),n.trigger("COLLISION_STARTED",e)):e.in_collision&&n.in_collision&&!t&&(e.trigger("COLLISION_ENDED",n),n.trigger("COLLISION_ENDED",e)),l.push(function(){var e,t,n;n=[];for(e=0,t=i.length;e<t;e++)r=i[e],n.push(o.release(r));return n}())}return l},r.prototype.draw=function(e){var t,n,r,i,s;this.draw_stat&&this.drawStat(),i=this.entities,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.draw(this.g.ctx,e));return s},r.prototype.pause=function(){return this.attr("paused",!0)},r.prototype.resume=function(){return this.attr("paused",!1)},r.prototype.group=function(e){return this.ent_groups[e]==null?[]:this.ent_groups[e].slice()},r.prototype.init=function(){return this.paused=!1},r}(e),a})}.call(this),function(){define("dommanager",[],function(){var e;return e=function(){function e(e){var t=this;this.renderspace=document.getElementById("renderspace"),this.hud=document.getElementById("hud"),this.viewport=document.getElementById("viewport"),this.area=renderspace.getBoundingClientRect(),this.current_zindex=1e3,this.canvases=[],this.in_fullscreen=!1,this.screen_w=window.screen.availWidth,this.screen_h=window.screen.availHeight,this.fullscreen_scale=[1,1],this.viewport.style["z-index"]=1e7,e.on("SUPPORTS_FULLSCREEN",function(){return document.body.mozRequestFullScreen||document.body.webkitRequestFullScreen||document.body.requestFullScreen}),e.on("FULLSCREEN_CHANGE",function(n){var r,i,s,o;if(n){e.r.resize(t.screen_w/t.fullscreen_scale[0],t.screen_h/t.fullscreen_scale[1]),s=t.canvases;for(i in s)r=s[i],r.setAttribute("style",(r.getAttribute("style")||"")+" "+"-webkit-transform: scale3d("+t.fullscreen_scale[0]+","+t.fullscreen_scale[1]+", 1.0); -webkit-transform-origin: 0 0 0;");return t.area=t.renderspace.getBoundingClientRect()}t.renderspace.style.width=""+e.r.prev_bounds[2]+"px",t.renderspace.style.height=""+e.r.prev_bounds[3]+"px",e.r.resize(e.r.prev_bounds[2],e.r.prev_bounds[3]),o=t.canvases;for(i in o)r=o[i],r.setAttribute("style",(r.getAttribute("style")||"")+" "+"-webkit-transform: scale3d(1.0, 1.0, 1.0); -webkit-transform-origin: 0 0 0;");return t.area=t.renderspace.getBoundingClientRect()}),e.on("DOM_ADD",function(e){if(e!=null)return e.call({},t.hud)}),e.on("REQUEST_FULLSCREEN",function(n){if(!e.supports("FULLSCREEN")){log.warn("Fullscreen not supported");return}if(!t.in_fullscreen)return t.renderspace.style.width=""+t.screen_w+" + px",t.renderspace.style.height=""+t.screen_h+" + px",t.renderspace.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}),window.addEventListener("resize",function(){return t.area=t.renderspace.getBoundingClientRect(),t.screen_w=window.screen.availHeight,t.screen_h=window.screen.availHeight,e.trigger("RESIZE",t.area)}),document.addEventListener("fullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,e.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)}),document.addEventListener("webkitfullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,e.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)}),document.addEventListener("mozfullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,e.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)})}return e}(),e.prototype.createCanvas=function(e,t){var n;return e==null&&(e=this.area.width),t==null&&(t=this.area.height),n=document.createElement("canvas"),n.width=e,n.height=t,n},e.prototype.createCanvasLayer=function(e,t,n){var r,i;return e==null&&(e=this.area.width),t==null&&(t=this.area.height),i=this.current_zindex+n,this.canvases[i]?this.canvases[i]:(r=this.createCanvas(e,t),r.style["z-index"]=i,r)},e.prototype.addCanvas=function(e,t,n,r){var i;t==null&&(t=0),n==null&&(n=0),i=e.style["z-index"];if(this.canvases[i]){llogw("Canvas with z-index of "+i+" already exists");return}return e.style.left=""+t+"px",e.style.top=""+n+"px",r||(e.style["background-color"]="white"),this.viewport.appendChild(e),this.canvases[i]=e},e})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;define("deferredcounter",["deferred"],function(e){var r;return r=function(e){function r(e){this.total_trigs=e,this.num_approved=0,this.num_rejected=0,r.__super__.constructor.call(this)}return t(r,e),r.prototype.resolve=function(e,t){if(this.num_approved+this.num_rejected===this.total_trigs)return r.__super__.resolve.call(this,e,{num_approved:this.num_approved,num_rejected:this.num_rejected},t)},r.prototype.reject=function(e,t){r.__super__.reject.call(this,e,{num_approved:this.num_approved,num_rejected:this.num_rejected},t);if(this.num_approved+this.num_rejected===this.total_trigs)return this.resolve(e,t)},r.prototype.acquire=function(){var e,t;return t=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.num_rejected++,this.reject(t,e)},r.prototype.release=function(){var e,t;return t=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.num_approved++,this.resolve(t,e)},r}(e),r})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("domeventmanager",[],function(){var t;return t=function(){function t(){this.getMousePos=e(this.getMousePos,this),this.mouseDown=e(this.mouseDown,this),this.mouseUp=e(this.mouseUp,this),this.mouseMove=e(this.mouseMove,this),this.mouseClick=e(this.mouseClick,this),this.mouseDblClick=e(this.mouseDblClick,this),this.keyUp=e(this.keyUp,this),this.keyDown=e(this.keyDown,this),this.wheelMoved=e(this.wheelMoved,this),this.mouse_leftbtn_down=!1,this.mouse_rightbtn_down=!1,this.can_drag=!0,this.pos=Hal.Vec2.from(0,0),this.viewport=Hal.dom.viewport,this.hud=Hal.dom.hud,this.dragging=!1,this.under_hud=!1,this.viewport.addEventListener("mousedown",this.mouseDown),this.viewport.addEventListener("mouseup",this.mouseUp),this.viewport.addEventListener("mousemove",this.mouseMove),this.viewport.addEventListener("onmousewheel",this.wheelMoved),this.viewport.addEventListener("onContextMenu",function(){return!1}),this.viewport.addEventListener("mousewheel",this.wheelMoved),this.viewport.addEventListener("click",this.mouseClick),this.viewport.addEventListener("dblclick",this.mouseDblClick),window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp)}return t.prototype.wheelMoved=function(e){return this.getMousePos(e),Hal.trigger("SCROLL",{down:e.wheelDelta<0,pos:this.pos})},t.prototype.keyDown=function(e){if(this.under_hud)return;return Hal.trigger("KEY_DOWN",e)},t.prototype.keyUp=function(e){if(this.under_hud)return;return Hal.trigger("KEY_UP",e)},t.prototype.mouseDblClick=function(e){return this.getMousePos(e),Hal.trigger("LEFT_DBL_CLICK",this.pos)},t.prototype.mouseClick=function(e){if(this.under_hud)return;return this.getMousePos(e),Hal.trigger("MOUSE_CLICK",this.pos)},t.prototype.mouseMove=function(e){this.under_hud=this.hud.querySelectorAll(":hover").length>0;if(this.under_hud)return;this.getMousePos(e),Hal.trigger("MOUSE_MOVE",this.pos);if(this.mouse_leftbtn_down&&!this.dragging&&this.can_drag)return Hal.trigger("DRAG_STARTED",this.pos),this.dragging=!0,this.can_drag=!1},t.prototype.mouseUp=function(e){if(this.under_hud){this.mouse_leftbtn_down=!1;return}this.getMousePos(e),this.dragging&&(this.dragging=!1,Hal.trigger("DRAG_ENDED",this.pos),this.can_drag=!0);if(this.mouse_rightbtn_down&&!this.dragging)return Hal.trigger("RIGHT_CLICK",this.pos),this.mouse_rightbtn_down=!1;if(this.mouse_leftbtn_down&&!this.dragging)return Hal.trigger("LEFT_CLICK",this.pos),this.mouse_leftbtn_down=!1},t.prototype.mouseDown=function(e){if(this.under_hud){this.mouse_leftbtn_down=!1;return}this.getMousePos(e);if(e.button===0)return this.mouse_leftbtn_down=!0;if(e.button===2)return this.mouse_rightbtn_down=!0},t.prototype.getMousePos=function(e){return this.pos[0]=e.clientX-Hal.dom.area.left,this.pos[1]=e.clientY-Hal.dom.area.top},t}(),t})}.call(this),function(){var e=[].slice;define("ajax",[],function(){var t,n;return n=function(){function e(e){this.url=e,this.success_=this.fail_=this.always_=function(){},this.success=function(e){return this.success_=e,this},this.fail=function(e){return this.fail_=e,this},this.always=function(e){return this.always_=e,this}}return e}(),t=new Object,t.get=function(){var t,r,i,s,o;return o=arguments[0],i=arguments[1],r=3<=arguments.length?e.call(arguments,2):[],s=new n(document.domain+"/"+o),t=new XMLHttpRequest,t.open("GET",""+o+"?"+i),t.send(),t.onreadystatechange=function(){var e;if(t.readyState===4){e=t.getResponseHeader("Content-Type"),t.status===200?(i=t.responseText,e==="application/json"&&o.indexOf("json")===-1&&(i=JSON.parse(i)),s.success_(i),r[0]&&r[0](i)):(s.fail_(t.responseText),r[1]&&r[1](i)),s.always_(o||i);if(r[2])return r[2](i)}},s},t.post=function(){var t,r,i,s,o;return o=arguments[0],i=arguments[1],r=3<=arguments.length?e.call(arguments,2):[],s=new n(document.domain+"/"+o),t=new XMLHttpRequest,t.open("POST",o),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(i),t.onreadystatechange=function(){var e;if(t.readyState===4){e=t.getResponseHeader("Content-Type"),t.status===200?(i=t.responseText,e==="application/json"&&(i=JSON.parse(i)),s.success_(i),r[0]&&r[0](i)):(s.fail_(t.responseText),r[1]&&r[1](i)),s.always_(o||i);if(r[2])return r[2](i)}},s},t})}.call(this),function(){define("metaconfig",[],function(){var e;return e={Regex:{SpriteMatcher:/\/assets\/sprites\/(.*\/)(.*)\.png/,AssetType:/^(.*)\.(.*)$/},URI:{Sprites:"sprites/",Assets:"/assets/",Websockets:"http://localhost:8080"}},e})}.call(this),function(){define("sprite",["metaconfig"],function(e){var t;return t=function(){function t(t,n,r,i,s,o){var u;this.img=t,this.x=r,this.y=i,this.w=s,this.h=o,u=this.img.src.match(e.Regex.SpriteMatcher),this.name=u&&u[2]?u[2]:"",this.w2=this.w*.5,this.h2=this.h*.5,this.folder=u&&u[1]?u[1]:"",this.onLazyLoad=null}return t.prototype.changeSprite=function(e){this.img=e.img,this.name=e.name,this.x=e.x,this.y=e.y,this.w=e.w,this.h=e.h,this.folder=e.folder,this.w2=e.w2,this.h2=e.h2;if(this.onLazyLoad!=null)return this.onLazyLoad()},t.prototype.getName=function(){return this.folder+this.name},t}(),t})}.call(this),function(){define("imgutils",[],function(){var e;return e=function(){function e(){this.hit_ctx=this.createCanvas(1,1).getContext("2d"),this.tint_ctx=this.createCanvas(800,600).getContext("2d")}return e.prototype.createCanvas=function(e,t){var n;return n=document.createElement("canvas"),n.width=e,n.height=t,n},e.prototype.clipImage=function(e,t){var n,r;return n=this.createCanvas(t.w,t.h),r=n.getContext("2d"),r.drawImage(e,t.x,t.y,t.w,t.h,0,0,t.w,t.h),e=new Image,e.src=n.toDataURL("image/png"),e},e.prototype.isTransparent=function(e,t,n){var r;return this.hit_ctx.drawImage(e,t,n,1,1,0,0,1,1),r=this.hit_ctx.getImageData(0,0,1,1).data,this.hit_ctx.clearRect(0,0,1,1),r[3]<255},e.prototype.getPixelAt=function(e,t,n){var r,i;return this.hit_ctx.drawImage(e,t,n,1,1,0,0,1,1),r=this.hit_ctx.getImageData(0,0,1,1).data,i=(t+n)*4,[r[i],r[i+1],r[i+2],r[i+3]]},e.prototype.tintImage=function(e,t,n){var r,i;return r=this.createCanvas(e.width,e.height),i=r.getContext("2d"),i.globalAlpha=1,i.drawImage(e,0,0),i.globalAlpha=n,i.globalCompositeOperation="source-atop",i.fillStyle=t,i.fillRect(0,0,e.width,e.height),r},e}(),e})}.call(this),function(){define("spritefactory",["sprite","imgutils"],function(e,t){var n;return n={},n.clipFromSpriteSheet=function(n,r,i){return new e(t.clipImage(n,i),r,0,0,i.w,i.h)},n.fromSingleImage=function(t,n){return new e(t,n,0,0,t.width,t.height)},n.dummySprite=function(){var t;return t=new Image,t.src="",new e(t,"n/a",0,0,t.width,t.height)},n})}.call(this),function(){define("spritesheet",[],function(){var e;return e=function(){function e(e,t,n,r){var i;this.path=e,this.img=t,this.meta=n,this.sprites=r!=null?r:{},i=this.path.match(/.*\/(.*)\.json/),i&&i.length>0?this.name=i[1]:this.name=this.path}return e.prototype.addSprite=function(e){return this.sprites[e.name]=e},e}(),e})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("assetmanager",["deferred","deferredcounter","ajax","spritefactory","sprite","spritesheet","eventdispatcher","metaconfig"],function(e,r,i,s,o,u,a,f){var l;return l=function(e){function n(){n.__super__.constructor.call(this),this.assets={sprites:{},spritesheets:{},audio:{},animation:{}},this.tint_cache={},this.wait_queue=[]}return t(n,e),n}(a),l.prototype.setResourcesRelativeURL=function(e){return f.URI.Assets=e},l.prototype.resolvePath=function(e){var t,n,r,i,s,o,u;n=e.split("/"),this.assets.hasOwnProperty(n[0])&&(i=this.assets[n[0]]),u=n.slice(1,n.length-1);for(s=0,o=u.length;s<o;s++)t=u[s],i.hasOwnProperty(t)||(i[t]=new Object),i=i[t],r=n[n.length-1],r=r.substring(0,r.lastIndexOf("."));return[i,r]},l.prototype.addToStorage=function(e,t){var n,r,i;return i=this.resolvePath(e),r=i[0],n=i[1],r[n]=t,r[n]},l.prototype.deleteFromStorage=function(e){var t,n,r;return r=this.resolvePath(e),n=r[0],t=r[1],n[t]=null,delete n[t]},l.prototype.loadImage=function(t){var n,r,i=this;return n=new e,r=new Image,r.src=t,r.onload=function(){return n.resolve(r,r)},r.onerror=function(){return n.reject(r,t)},n.promise()},l.prototype.loadImages=function(e){var t,n,i,s;t=new r(e.length);for(i=0,s=e.length;i<s;i++)n=e[i],this.loadImage(n).then(function(e){return t.release(this,e)}).fail(function(e){return t.acquire(this,e)});return t.promise()},l.prototype.getTintedSprite=function(e,t,n){var r;return t==null&&(t="red"),n==null&&(n=.5),r=e.getName()+t,this.tint_cache[r]||(this.tint_cache[r]=Hal.imgutils.tintImage(e.img,t,n)),this.tint_cache[r]},l.prototype.loadSprite=function(t){var n,r=this;return t=f.URI.Assets+t,n=new e,this.loadImage(t).then(function(e){var i,o;return o=s.fromSingleImage(e,t),i=o.getName(),r.wait_queue[i]&&(llogi("Sprite was in a waiting queue: SPRITE = "+i),r.wait_queue[i].changeSprite(o),delete r.wait_queue[t]),Hal.trigger("SPRITE_LOADED",o),n.resolve(r,o)}).fail(function(e){return n.reject(r,e)}),n.promise()},l.prototype.loadSound=function(t){var n;return t=f.URI.Assets+t,n=new e},l.prototype.addSprite=function(e){var t=this;return this.loadSprite(e).then(function(n){return t.addToStorage(e,n)})},l.prototype.addSound=function(){var e=this;return this.loadSound(g).then(function(t){return e.addToStorage(g,t)})},l.prototype.resolveFolderPath=function(e){var t,n,r,i,s,o,u;n=e.split("/");if(this.assets.hasOwnProperty(n[0])){i=this.assets[n[0]];if(n.length>3){u=n.slice(1,n.length-2);for(s=0,o=u.length;s<o;s++)t=u[s],i.hasOwnProperty(t)||(i[t]={}),i=i[t]}}return r=n[n.length-2],[i,r]},l.prototype.loadViaSocketIO=function(){var e=this;if(typeof io=="undefined"||io===null){lloge("Couldn't find socket.io library");return}return this.socket=io.connect(f.URI.Websockets),this.socket.on("connect",function(){return llogd("Connected via socket.io")}),this.socket.on("LOAD_SPRITES",function(t){var n,r,i,s,o,u,a;s=JSON.parse(t.files),i=s.length,e.trigger("SPRITES_LOADING",i),a=[];for(r=o=0,u=s.length;o<u;r=++o)n=s[r],a.push(function(n,r){return e.addSprite(t.url+n).then(function(){e.trigger("SPRITE_LOADED",n);if(r>=i-1)return e.trigger("SPRITES_LOADED")})}(n,r));return a}),this.socket.on("LOAD_SOUNDS",function(t){var n,r,i,s,o,u,a;s=JSON.parse(t.files),i=s.length,e.trigger("SOUNDS_LOADING",i),a=[];for(r=o=0,u=s.length;o<u;r=++o)n=s[r],a.push(function(n,r){return e.addSound(t.url+n).then(function(){e.trigger("SOUND_LOADED");if(r>=i-1)return e.trigger("SOUNDS_LOADED")})}(n,r));return a}),this.socket.on("SPRITE_FOLDER_ADDED",function(t){var n,r,i,s,o,u,a,f;llogd("Sprite folder added: data.url"),i=t.files.length,e.trigger("SPRITES_LOADING"),a=t.files,s=function(e,t){},f=[];for(r=o=0,u=a.length;o<u;r=++o)n=a[r],llogd("Adding sprite: "+n),s(n,r),f.push(e.addSprite(t.url+n).then(function(){e.trigger("SPRITE_LOADED",n);if(r>=i-1)return e.trigger("SPRITES_LOADED")}));return f}),this.socket.on("SPRITE_ADDED",function(t){return llogd("Sprite added: "+t.url),e.addSprite(t.url)}),this.socket.on("SPRITESHEET_ADDED",function(e){return llogd("Spritesheet added: "+e.url)}),this.socket.on("SPRITE_DELETED",function(t){return llogd("Sprite deleted: "+t.url),e.deleteFromStorage(t.url)}),this.socket.on("SPRITE_FOLDER_DELETED",function(t){var n,r,i;return llogd("Sprite folder deleted: "+t.url),i=e.resolveFolderPath(t.url),r=i[0],n=i[1],delete r[n],e.trigger("SPRITES_LOADED")}),this.socket.on("SPRITESHEET_DELETED",function(e){return llogd("Spritesheet deleted: "+e.url),llogd(e)})},l.prototype.loadSpritesFromFileList=function(e){var t=this;return i.get(e,function(e){var n,r,i,s,o,u;e=e.split("\r\n"),e.splice(-1),r=e.length,t.trigger("SPRITES_LOADING",r),u=[];for(n=s=0,o=e.length;s<o;n=++s)i=e[n],u.push(function(e,n){return t.addSprite(e).then(function(){t.trigger("SPRITE_LOADED",e);if(n>=r-1)return t.trigger("SPRITES_LOADED")})}(i,n));return u})},l.prototype.loadFromArray=function(e,t){n.call(this.assets,e)<0},l.prototype.getSprite=function(e){var t,n,r;return r=this.resolvePath(f.URI.Sprites+e+"."),n=r[0],t=r[1],n[t]},l.prototype.getSpritesFromFolder=function(e){var t,n,r,i,s,o,u,a;if(e==="/")return this.getSpriteFolders();t=e.indexOf("/"),t===0&&(e=e.substring(t+1)),t=e.charAt(e.length-1),t!=="/"&&(e=""+e+"/"),i={},u=this.resolveFolderPath(f.URI.Sprites+e),s=u[0],r=u[1],a=s[r];for(n in a)o=a[n],o.img!=null&&(i[n]=o);return i},l.prototype.getSpriteFoldersFromFolder=function(e){var t,n,r,i,s,o,u,a;t=e.indexOf("/"),t===0&&(e=e.substring(t+1)),t=e.charAt(e.length-1),t!=="/"&&(e=""+e+"/"),i={},u=this.resolveFolderPath(f.URI.Sprites+e),s=u[0],r=u[1],a=s[r];for(n in a)o=a[n],o.img==null&&(i[n]=o);return i},l.prototype.getSpriteFolders=function(){return this.assets.sprites},l.prototype.waitFor=function(e,t){return this.wait_queue[t]=e},l})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("bboxalgos",["vec2"],function(e){var n,r,i,s,o,u,a,f;return n={polyBBoxFromSprite:function(e,t,n){return t==null&&(t=u),n==null&&(n=o),i(e,t,n)},rectBBoxFromSprite:function(e){return[-e.w*.5,-e.h*.5,e.w,e.h]},rectFromPolyShape:function(e){var t,n,r,i,s,o,u;r=Number.MAX_VALUE,i=Number.MAX_VALUE,t=-Number.MIN_VALUE,n=-Number.MIN_VALUE;for(o=0,u=e.length;o<u;o++)s=e[o],r=Math.min(s[0],r),i=Math.min(s[1],i),t=Math.max(s[0],t),n=Math.max(s[1],n);return[r,i,Math.abs(r)+t,Math.abs(i)+n]},circularBBoxFromSprite:function(e){var t;return t=Math.sqrt(e.w*e.w+e.h*e.h)*.5,[t]},rectIntersectsRect:function(e){return Hal.math.rectIntersectsRect(e,[this.pos[0],this.pos[1],this.bounds[2],this.bounds[3]])},rectIntersectsCircle:function(e){return Hal.math.rectIntersectsAndHullsCircle(e,this.pos,this.bounds[0])},rectBoundCheck:function(e){return Hal.math.isPointInRect(e,[this.pos[0],this.pos[1],this.bounds[2],this.bounds[3]])},circularBoundCheck:function(e){return Hal.math.isPointInCircle(e,this.pos,this.bounds[0])}},i=function(t,n,r){var i,s,o,u,a,f,l,c,h;c=[],h=t.w,f=t.h,i=Hal.dom.createCanvas(h,f),u=i.getContext("2d"),o=[],u.drawImage(t.img,0,0),l=u.getImageData(0,0,h,f),a=function(){var t,n,r,i,s,o,u,a,f,l,h,p,d,v,m,g;a=0,n=0,t=1/33;if(c.length<2)return void 0;for(l=m=0,g=c.length;m<g;l=++m){u=c[l],o=c[l+1];if(o==null)break;s=e.fromValues(u.x,u.y),h=e.fromValues(o.x,o.y),d=e.sub([],h,s);if(d!=null){p=c[l+2];if(p==null)break;v=e.sub([],h,e.fromValues(p.x,p.y))}if(d!=null&&v!=null){e.normalize(d,d),e.normalize(v,v),i=e.dot(d,v),a=n,n=e.dot(d,v),r=Math.abs(n-a);if(r>t)return f=[c[l+2].x-Hal.math.epsilon,c[l+2].y-Hal.math.epsilon],c.splice(0,l+2),f}}},c=new n(l.data,h,f);while(s=a())o.push(s);return Hal.log.debug("num criticals: "+o.length),new r(o)},s=function(){function e(e,t,n,r){return this.data=e!=null?e:[],this.width=t,this.height=n,this.sample_rate=r!=null?r:1,this.samplingFunc()}return e.prototype.samplingFunc=function(){return[]},e.prototype.getPixelAt=function(e,t){var n;return n=(e+this.width*t)*4,[this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]]},e}(),u=function(e){function n(){return a=n.__super__.constructor.apply(this,arguments),a}return t(n,e),n.prototype.samplingFunc=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;e=130,i=[];for(t=s=0,f=this.width-1,l=this.sample_rate;l>0?s<=f:s>=f;t=s+=l)for(n=o=0,c=this.height;0<=c?o<=c:o>=c;n=0<=c?++o:--o){r=this.getPixelAt(t,n);if(r[3]>e){i.push({x:t,y:n});break}}for(t=u=0,h=this.width-1,p=this.sample_rate;p>0?u<=h:u>=h;t=u+=p)for(n=a=d=this.height;a>=0;n=a+=-1){r=this.getPixelAt(t,n);if(r[3]>e){i.unshift({x:t,y:n});break}}return i},n}(s),r=function(){function e(e){return this.downsamplingFunc(e)}return e.prototype.downsamplingFunc=function(){return[]},e}(),o=function(e){function n(){return f=n.__super__.constructor.apply(this,arguments),f}return t(n,e),n.prototype.downsamplingFunc=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;r=3,l=e[0],n=e[e.length-1],o=0,s=0,u=[];if(e.length<2)return e;for(i=c=1,h=e.length-2;1<=h?c<=h:c>=h;i=1<=h?++c:--c)t=Hal.math.perpDistance(e[i],l,n),t>o&&(s=i,o=t);return o>r?(a=this.downsamplingFunc(e.slice(0,+s+1||9e9)),f=this.downsamplingFunc(e.slice(s,+(e.length-1)+1||9e9)),a=a.slice(0,a.length-1),u=a.concat(f)):(u.push(e[0]),u.push(e[e.length-1])),u},n}(r),n})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("entity",["halalentity","scene","matrix3","bboxalgos","vec2"],function(e,n,r,i,s){var o;return o=function(e){function n(e){e==null&&(e={}),n.__super__.constructor.call(this),this.id=Hal.ID(),this.shape=e.shape!=null?e.shape:[[0,0],[0,1],[1,1],[1,0]],this.x=e.x!=null?e.x:0,this.y=e.y!=null?e.y:0,this.angle=e.angle!=null?e.angle:0,this.scale=e.scale!=null?e.scale:1,this.stroke_color=e.stroke_color!=null?e.stroke_color:"black",this.glow=e.glow!=null?e.glow:!1,this.glow_color=e.glow_color!=null?e.glow_color:"blue",this.glow_amount=e.glow_amount!=null?e.glow_amount:16,this.line_width=e.line_width!=null?e.line_width:1,this.draw_shape=e.draw_shape!=null?e.draw_shape:!0,this.opacity=e.opacity!=null?e.opacity:1,this.parent=null,this.world_pos=[0,0],this.group=e.group!=null?e.group:"default",this.quadspace=null,this.needs_updating=!0,this.draw_origin=!1,this.local_matrix=this.localMatrix(),this.calcShapeAndBox(),this.children=[],this.shapes=[],this.drawables=[],this.ent_groups={},this.scene=null,this.selected_color="white",this.unselected_color=this.stroke_color,this.on("CHANGE",function(e){var t,n,r,i,s;n=e[0];if(n==="angle"||n==="scale"||n==="h"||n==="w"||n==="x"||n==="y"||n==="glow"||n==="parent"||n==="line_width")this.parent!=null&&(this.parent.needs_updating=!0),this.needs_updating=!0;n==="shape"&&this.calcShapeAndBox();if(n==="x"||n==="y")if(this.parent!=null&&this.quadspace!=null){this.parent.trigger("ENTITY_MOVING",this),s=this.children;for(r=0,i=s.length;r<i;r++)t=s[r],this.parent.trigger("ENTITY_MOVING",t)}if(n==="group")return this.trigger("GROUP_CHANGE",this)}),this.on("GROUP_CHANGE",function(e){var t,n;t=this.ent_groups[e.group],t==null&&(t=this.ent_groups[e.group]=[]),n=t.indexOf(e),n!==-1?t.splice(n,1):t.push(e);if(this.parent!=null)return this.parent.trigger("GROUP_CHANGE",e)}),this.on("ENTITY_ADDED",function(){return this.init()})}return t(n,e),n.prototype.calcShapeAndBox=function(){return this.attr("bbox",i.rectFromPolyShape(this.shape))},n.prototype.localMatrix=function(){return[this.scale,0,this.x,0,this.scale,this.y,0,0,1]},n.prototype.rotationMatrix=function(){return[Math.cos(this.angle),-Math.sin(this.angle),0,Math.sin(this.angle),Math.cos(this.angle),0,0,0,1]},n.prototype.requestUpdate=function(){return this.scene.needs_updating=!0},n.prototype.group=function(e){return this.ent_groups[e]==null?[]:this.ent_groups[e].slice()},n.prototype.init=function(){return this.on("EXIT_FRAME",function(){return this.scene.g.ctx.setTransform(1,0,0,1,0,0)}),this.on("LEFT_CLICK",function(e){return this.selected=!this.selected,this.selected?this.trigger("SELECTED"):this.trigger("DESELECTED")})},n.prototype.viewportPos=function(){var e;return e=r.transpose([],this.local_matrix),s.transformMat3([],[0,0],e)},n.prototype.worldPos=function(){return this.localToWorld([this.x,this.y])},n.prototype.localToWorld=function(e){return s.transformMat3([],e,this.scene.local_matrix)},n.prototype.worldToLocal=function(e){return s.transformMat3([],e,r.transpose([],r.invert([],this.local_matrix)))},n.prototype.addEntity=function(e){return this.children.push(e),this.trigger("CHILD_ENTITY_ADDED",e),e.attr("scene",this.scene),e.attr("parent",this),e.attr("is_child",!0),this.trigger("GROUP_CHANGE",e.group)},n.prototype.addEntityToQuadspace=function(e){return this.children.push(e),this.trigger("CHILD_ENTITY_ADDED",e),e.attr("scene",this.scene),e.attr("parent",this),e.attr("is_child",!0),this.trigger("GROUP_CHANGE",e.group),e},n.prototype.destroy=function(e){return e==null&&(e=!1),this.removeAll(),this.scene==null?llogw("this entity didn't belong to a scene"):this.scene.removeEntity(this),this.destroyChildren(e),this.children=null,this.drawables=null,this.parent=null,this.quadspace==null?llogw("this entity had no quadspace"):this.quadspace.remove(this),this.quadspace=null,this.scene=null,this.trigger("DESTROY")},n.prototype.destroyChildren=function(e){var t,n,r,i,s;if(!e||this.children==null)return;i=this.children,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.destroy(e));return s},n.prototype.update=function(e){var t,n,r,i,s;if(this.needs_updating){this.glow||(this.scene.g.ctx.shadowBlur=0),this.calcLocalMatrix(),i=this.children,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.update(e));return s}},n.prototype.calcLocalMatrix=function(){return this.local_matrix=r.mul(this.rotationMatrix(),this.localMatrix()),this.local_matrix=r.mul(this.local_matrix,this.parent.local_matrix)},n.prototype.addDrawable=function(e){return this.drawables.push(e)},n.prototype.addShape=function(e){return this.shapes.push(e)},n.prototype.draw=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;this.needs_updating&&(this.scene.g.ctx.setTransform(this.local_matrix[0],this.local_matrix[3],this.local_matrix[1],this.local_matrix[4],this.local_matrix[2],this.local_matrix[5]),this.needs_updating=!1),this.scene.g.ctx.globalAlpha=this.opacity,this.draw_shape&&this.line_width>1&&(this.scene.g.ctx.lineWidth=this.line_width),this.glow&&(this.scene.g.ctx.shadowBlur=this.glow_amount,this.scene.g.ctx.shadowColor=this.glow_color),this.draw_shape&&this.scene.g.strokePolygon(this.shape,this.selected?this.selected_color:this.stroke_color),this.glow&&(this.scene.g.ctx.shadowBlur=0),this.line_width!==1&&this.draw_shape&&(this.scene.g.ctx.lineWidth=1),this.draw_origin&&(this.scene.g.drawLine(0,0,0,-100,"green"),this.scene.g.drawLine(-50,0,50,0,"green")),this.draw_bbox&&this.scene.g.strokeRect(this.bbox,"cyan"),f=this.children;for(r=0,o=f.length;r<o;r++)t=f[r],t.draw(e);l=this.drawables;for(i=0,u=l.length;i<u;i++)n=l[i],n.call(this,e);c=this.shapes,h=[];for(s=0,a=c.length;s<a;s++)n=c[s],h.push(this.scene.g.strokePolygon(n,"blue"));return h},n}(e),o})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("spriteentity",["entity","bboxalgos","spritefactory"],function(e,n,r){var i;return i=function(e){function i(e){var t=this;i.__super__.constructor.call(this,e),this.sprite=Hal.asm.getSprite(e.sprite),this.visible_sprite=e.visible_sprite!=null?e.visible_sprite:!0,this.h=e.height!=null?e.height:0,this.w=e.width!=null?e.width:0,this.sprite==null?(this.sprite=r.dummySprite(),Hal.asm.waitFor(this.sprite,e.sprite)):this.calcShapeAndBBox(),this.sprite.onLazyLoad=function(){return t.calcShapeAndBBox()}}return t(i,e),i.prototype.init=function(){return i.__super__.init.call(this)},i.prototype.inShapeBounds=function(e){return e=this.worldToLocal(this.scene.localToWorld(e)),Hal.math.isPointInRect(e,this.bbox)&&!Hal.im.isTransparent(this.sprite.img,e[0]+this.bbox[2]*.5,e[1]+this.bbox[3]*.5)?!0:!1},i.prototype.calcShapeAndBBox=function(){return this.attr("bbox",n.rectBBoxFromSprite(this.sprite))},i.prototype.draw=function(){i.__super__.draw.call(this);if(this.visible_sprite)return this.scene.g.drawSprite(this.sprite,this.w,this.h)},i}(e),i})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("tilemanager",["spriteentity"],function(e){var n,r,i;return n=function(e){function n(e){n.__super__.constructor.call(this,e),this.row=e.row,this.col=e.col,this.layers=[null,null,null,null,null]}return t(n,e),n.prototype.addTileLayer=function(e,t){var n,r;t=t||e.layer,r=this.layers[t]!=null;if(r&&this.layers[t].name===e.name){llogd("You're trying to add the same layer");return}return r&&this.layers[t].destroy(),this.layers[t]=e,n=this.addEntityToQuadspace(e),n.attr("shape",this.shape),n.attr("draw_shape",!1),n},n.prototype.init=function(){return n.__super__.init.call(this),this.on("LAYER_DESTROYED",function(e){return llogd("layer destroyed "+e),this.layers[e]=null})},n.prototype.destroy=function(e){return e==null&&(e=!1),this.parent.trigger("ENTITY_DESTROYED",this),n.__super__.destroy.call(this,e)},n}(e),r=function(e){function n(e){n.__super__.constructor.call(this,e),this.name=e.name!=null?e.name:""+this.id,this.layer=e.layer!=null?e.layer:0,this.on("SELECTED",function(){return this.attr("glow",!0),this.attr("glow_color","blue"),this.attr("draw_shape",!0),this.attr("stroke_color","white"),Hal.tween(this,"line_width",200,1,14.5,5)}),this.on("DESELECTED",function(){return this.attr("line_width",1),this.attr("glow",!1),this.attr("draw_shape",!1)})}return t(n,e),n.prototype.destroy=function(e){return e==null&&(e=!0),llogd("destroying myself"),llogd(this),this.parent!=null&&this.parent.trigger("LAYER_DESTROYED",this.layer),n.__super__.destroy.call(this,e)},n}(e),i=function(){function e(e,t){var n=this;this.map=e,t==null&&(t=""),this.tile_layer_map={},this.tile_name_map={},this._id=0,Hal.on("TILE_MNGR_NEW_TILE",function(e){return n.add(e)}),Hal.on("TILE_MNGR_LOAD_TILES",function(e){return n.load(e)})}return e.prototype.loadFromList=function(e){var t,n,r,i,s=this;e==null&&(e="assets/TilesList.list"),Ajax.get("assets/amjad/TilesList.json",function(e){}),llogd("TileManager loaded tiles."),r=JSON.parse(r),i=[];for(t in r)n=r[t],i.push(this.add(n));return i},e.prototype.load=function(e){var t,n,r;llogd("Loading tiles..."),llogd(e),r=[];for(t in e)n=e[t],r.push(this.add(n));return r},e.prototype.add=function(e){return e.id=++this._id,this.tile_name_map[e.name]=e,this.tile_layer_map[e.layer]==null&&(this.tile_layer_map[e.layer]={}),this.tile_layer_map[e.layer][e.name]=e},e.prototype.removeByName=function(e){var t;return t=this.tile_name_map[e],delete this.tile_layer_map[t.layer][t.name],delete this.tile_name_map[t.name],t=null},e.prototype.newTileLayer=function(e){return new r(e)},e.prototype.newTileHolder=function(e){return e.parent=this.map,new n(e)},e.prototype.addTileLayerToHolder=function(e,t,n,r,i){n==null&&(n=t.layer),r==null&&(r=0),i==null&&(i=0);if(e==null||t==null){llogd("holder or tile is null");return}t.attr("group")==="default"&&t.attr("group","layer_"+n),llogd("x_offset: "+r),llogd("y_offset: "+i),t=e.addTileLayer(t,n);if(t==null)return;return llogd(r),llogd(i),t.attr("w",r),t.attr("h",i),t},e}()})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("isometricmap",["scene","spriteentity","entity","tilemanager"],function(e,n,r,i){var s;return s=function(e){function n(e){var t,r,s,o,u,a,f=this;this.tilew=e.tilew,this.tileh=e.tileh,this.nrows=e.rows,this.ncols=e.cols,this.tm=new i(this),this.tilew2prop=2/this.tilew,this.tileh2prop=2/this.tileh,this.tilew2=this.tilew/2,this.tileh2=this.tileh/2,this.map=[],this.translate_x=0,this.max_rows=this.nrows-1,this.max_cols=this.ncols-1,this.selected_tile=null,this.selected_tile_x=0,this.selected_tile_y=0,this.selected_tile_sprite=null,this.old_camx=0,this.on_exit_frame=null,this.supported_modes={"mode-default":function(){f.processMouseClick()},"mode-erase":function(){f.processMouseClick();if(f.clicked_layer==null||f.clicked_layer.animating)return;return f.clicked_layer.tween({attr:"h",from:0,to:100,duration:500}).tween({attr:"opacity",from:1,to:0,duration:700}).done(function(){return this.destroy()}),f.clicked_layer=null},"mode-place":function(){var e;e=f.tm.addTileLayerToHolder(f.tile_under_mouse,f.tm.newTileLayer(f.selected_tile),f.selected_tile.layer,f.selected_tile_x,f.selected_tile_y)}},this.camera_moved=!1,this.current_mode="mode-default",this.current_mode_clb=this.supported_modes[this.current_mode],e.cam_bounds=[this.tilew2,this.tileh2,this.ncols*this.tilew2,(this.nrows-.5)*this.tileh],llogd("camera bounds: "+e.cam_bounds),n.__super__.constructor.call(this,e),this.iso_shape=[[-this.tilew2,0],[0,this.tileh2],[this.tilew2,0],[0,-this.tileh2]],this.display={startr:0,endr:0,startc:0,endc:0},this.info={row:"row: ",col:"col: ",tilename:"tile: ",start_row:"starting row: ",start_col:"starting col: ",end_row:"end row: ",end_col:"end_col: ",tile_x:"tile_x: ",tile_y:"tile_y: ",cam_mouse:"camera_mouse: "},this.mask=Hal.asm.getSprite("test/tilemask_128x64"),t=Hal.dom.createCanvas(this.tilew,this.tileh).getContext("2d"),t.drawImage(this.mask.img,0,0),this.mask_data=t.getImageData(0,0,this.tilew,this.tileh).data,a=this.mask_data;for(s=o=0,u=a.length;o<u;s=++o)r=a[s],this.mask_data[s]=r<120;this.over={green:Hal.asm.getSprite("test/grid_unit_over_green_128x64"),red:Hal.asm.getSprite("test/grid_unit_over_red_128x64")},this.last_clicked_layer=null,this.tile_under_mouse=null}return t(n,e),n.prototype.showRegion=function(e,t,n){var r,i,s,o,u,a,f,l;s=this.getTileAt(this.worldToLocal(e));if(s==null)return;u=s.row,o=s.col,o%2===0&&(t-=1),f=this.getTile(Hal.math.clamp(u-t,u,this.nrows-1),Hal.math.clamp(o-n,o,this.ncols-1)),i=this.getTile(Hal.math.clamp(u+t,u,this.nrows-1),Hal.math.clamp(o+n,o,this.ncols-1)),l=this.getTile(Hal.math.clamp(u-t,u,this.nrows-1),Hal.math.clamp(o+n,o,this.ncols-1)),r=this.getTile(Hal.math.clamp(u+t,u,this.nrows-1),Hal.math.clamp(o-n,o,this.ncols-1));if(f==null||l==null||r==null||i==null)return;return a=[f.x-(l.x-f.x),f.y-(i.y-f.y),(l.x-f.x)*2,(i.y-f.y)*2],this.g.strokeRect(a,"cyan")},n.prototype.drawStat=function(){return n.__super__.drawStat.call(this),this.tile_under_mouse!=null&&(Hal.glass.ctx.fillText(this.info.row+this.tile_under_mouse.row,0,195),Hal.glass.ctx.fillText(this.info.col+this.tile_under_mouse.col,0,210),Hal.glass.ctx.fillText(this.info.tile_x+this.tile_under_mouse.x,0,225),Hal.glass.ctx.fillText(this.info.tile_y+this.tile_under_mouse.y,0,240)),Hal.glass.ctx.fillText(this.info.start_row+this.display.startr,0,115),Hal.glass.ctx.fillText(this.info.start_col+this.display.startc,0,130),Hal.glass.ctx.fillText(this.info.end_row+this.display.endr,0,145),Hal.glass.ctx.fillText(this.info.end_col+this.display.endc,0,160),Hal.glass.ctx.fillText(this.info.cam_mouse+(""+(-this.camera.x+this.mpos[0]).toFixed(2)+", "+(-this.camera.y+this.mpos[1]).toFixed(2)),0,255)},n.prototype.init=function(){var e=this;return n.__super__.init.call(this),this.camera.on("CHANGE",function(){return e.calcDrawingArea()}),Hal.on("LEFT_CLICK",function(){return e.current_mode_clb()}),Hal.on("EDITOR_MODE_CHANGED",function(t){return e.current_mode=t,e.supported_modes[e.current_mode]?e.current_mode_clb=e.supported_modes[e.current_mode]:llogw("Mode "+mode+" not supported"),llogd(e.current_mode)}),Hal.on("TILE_LAYER_SELECTED",function(t){return llogd("Tile layer selected from editor"),llogd(t),e.selected_tile=t,e.selected_tile_sprite=Hal.asm.getSprite(e.selected_tile.sprite),e.selected_tile_x=e.selected_tile_sprite.w2-e.tilew2,e.selected_tile_y=e.selected_tile_sprite.h2-e.tileh2}),Hal.on("RIGHT_CLICK",function(t){if(e.paused)return;return e.camera.lerpTo(e.localToWorld(e.world_pos))}),Hal.on("MOUSE_MOVE",function(t){var n;n=e.getTileAt(e.worldToLocal(t));if(n!==e.tile_under_mouse){e.tile_under_mouse&&(e.tile_under_mouse.attr("line_width",1),e.tile_under_mouse.attr("glow",!1),e.tile_under_mouse.attr("draw_shape",!1)),e.tile_under_mouse=n;if(n!=null)return n.attr("glow",!0),n.attr("draw_shape",!0),n.attr("stroke_color","white"),Hal.tween(n,"line_width",400,1,3.5,1)}}),this.initMap()},n.prototype.calcDrawingArea=function(){var e,t,n;return this.old_camx=this.camera.x,this.camera.x%this.tilew2===0&&(llogd("oh jea"),this.camera_moved=!0),n=this.getTileAt(this.worldToLocal([0,0])),n==null?(e=0,t=0):(e=n.col,t=n.row),this.display={startc:e,endr:this.maxRows(),startr:t,endc:this.maxCols()}},n.prototype.maxRows=function(){return Math.min(this.nrows-1,Math.round(this.bounds[3]/(this.tileh*this.camera.zoom)+4))},n.prototype.maxCols=function(){return Math.min(this.ncols-1,Math.round(this.bounds[2]/(this.tilew2*this.camera.zoom)+4))},n.prototype.toOrtho=function(e){var t,n,r,i,s;return t=(e[0]+this.tilew2)*this.tilew2prop,i=(e[1]+this.tileh2)*this.tileh2prop,n=~~(e[0]+this.tilew2-~~(t*.5)*this.tilew),r=~~(e[1]+this.tileh2-~~(i*.5)*this.tileh),s=this.mask_data[(n+this.tilew*r)*4+3],[t-(s^!(t&1)),(i-(s^!(i&1)))/2]},n.prototype.getTile=function(e,t,n){return n==null&&(n=[0,0]),this.map[t+n[1]+(e+n[0])*this.ncols]},n.prototype.getTileAt=function(e){var t;return t=this.toOrtho(e),t[0]<0||t[1]<0||t[1]>=this.nrows||t[0]>=this.ncols?null:this.map[Math.floor(t[0])+Math.floor(t[1])*this.ncols]},n.prototype.initMap=function(){var e,t,n,r,i,s,o,u,a,f,l,c;this.clicked_layer=null,llogd("max rows: "+this.maxRows()),llogd("max cols: "+this.maxCols()),llogd("total at this resolution: "+this.maxRows()*this.maxCols()),this.max_rows=this.maxRows(),this.max_cols=this.maxCols(),this.map=new Array(this.nrows*this.ncols),n=0,i=performance.now();for(e=a=0,l=this.nrows-1;0<=l?a<=l:a>=l;e=0<=l?++a:--a)for(t=f=0,c=this.ncols-1;0<=c?f<=c:f>=c;t=0<=c?++f:--f)o=t/2*this.tilew,u=(e+t%2/2)*this.tileh,r=this.tm.newTileHolder({shape:this.iso_shape,draw_shape:!1,x:o,y:u,row:e,col:t,visible_sprite:!0,sprite:"test/grid_unit_128x64"}),this.map[n]=this.addEntityToQuadspace(r),n++;return s=performance.now()-i,llogd("it took: "+i),this.calcDrawingArea(),this.camera.trigger("CHANGE")},n.prototype.processMouseClick=function(){var e,t,n,r;this.clicked_layer!=null&&(this.clicked_layer.trigger("DESELECTED"),this.clicked_layer=null),r=this.quadspace.searchInRange(this.world_pos,this.search_range,this);for(t=0,n=r.length;t<n;t++){e=r[t];if(!e.inShapeBounds(this.world_pos))continue;llogd(e),this.clicked_layer==null?this.clicked_layer=e:e.parent.col===this.clicked_layer.parent.col&&e.parent.row===this.clicked_layer.parent.row?e.layer>this.clicked_layer.layer&&(this.clicked_layer=e):e.parent.row===this.clicked_layer.parent.row?e.h+e.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=e):e.parent.col===this.clicked_layer.parent.col?e.h+e.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=e):e.parent.col!==this.clicked_layer.parent.col&&e.parent.row!==this.clicked_layer.parent.row&&e.h+e.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=e)}if(this.clicked_layer!=null)return llogd("clicked layer"),llogd(this.clicked_layer),this.trigger("LAYER_SELECTED",this.clicked_layer),this.clicked_layer.trigger("LEFT_CLICK")},n.prototype.splitMap=function(){var e;return e={nw:null,ns:null,s:null,w:null,e:null,n:null,sw:null,se:null,c:null}},n.prototype.loadRandomMap=function(e,t){var n,r,i,s,o,u;u=[];for(e=s=0,o=this.ncols-1;0<=o?s<=o:s>=o;e=0<=o?++s:--s)u.push(function(){var t,s,o;o=[];for(n=t=0,s=this.nrows-1;0<=s?t<=s:t>=s;n=0<=s?++t:--t)i=this.getTile(e,n),r=5,o.push(function(){var e;e=[];while(r>0&&!i.isFull())this.addRandomLayer(i),e.push(--r);return e}.call(this));return o}.call(this));return u},n.prototype.addRandomLayer=function(e){var t,n,r,i,s,o,u;return u=Object.keys(this.tmngr.Tiles),r=~~(Math.random()*u.length),t=u[r],s=amj.tmngr.Tiles[t],o=Object.keys(s),n=~~(Math.random()*o.length),t=o[n],i=s[t]},n.prototype.genRandomMap=function(){},n}(e),s})}.call(this),function(){define("transformable",["vec2","matrix3"],function(e,t){var n;return n=function(){function n(){this.origin=e.from(0,0),this.scale=e.from(1,1),this.position=e.from(0,0),this.angle=0,this._transform=t.create(),this._inverse=t.create(),this._update_transform=!0,this._update_inverse=!0}return n}(),n.prototype.setOrigin=function(t,n,r){return r==null&&(r=!0),e.set(this.origin,t,n),r&&this.move(t-this.origin[0],n-this.origin[1]),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.setPosition=function(t,n){return e.set(this.position,t,n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.setScale=function(t,n){return e.set(this.scale,t,n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.setRotation=function(e){return this.angle=e,this.angle<0&&(this.angle+=Math.PI*2),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.rotate=function(e){return this.angle+=e,this.angle<0&&(this.angle+=Math.PI*2),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.move=function(t,n){return e.set(this.position,this.position[0]+t,this.position[1]+n),this._update_transform=!0,this._update_inverse=!0,this},n.prototype.transform=function(){return this._update_transform&&(this._transform[3]=-Math.sin(-this.angle)*this.scale[0],this._transform[0]=Math.cos(-this.angle)*this.scale[0],this._transform[1]=Math.sin(-this.angle)*this.scale[1],this._transform[4]=Math.cos(-this.angle)*this.scale[1],this._transform[2]=-this.origin[0]*this._transform[0]-this.origin[1]*this._transform[1]+this.position[0],this._transform[5]=-this.origin[0]*this._transform[3]-this.origin[1]*this._transform[4]+this.position[1],this._update_transform=!1),this._transform},n.prototype.inverseTransform=function(){return this._update_inverse&&(t.inverse(this._inverse,this._transform),this._update_inverse=!1),this._inverse},n})}.call(this),function(){define("drawable",["vec2","geometry","sprite"],function(e,t,n){var r;return r=function(){function r(){llogd(this),this._drawableState=0,this.stroke_color="white",this.fill_color="orange",this.sprite=null,this.on("CHANGE",function(e){var r;if(e[0]==="sprite"){if(this.sprite==null||!this.sprite instanceof n)return;return r=t.createPolygonFromRectangle(this.sprite.w*.5,this.sprite.h*.5),this.setShape(r),this.drawableOnState(this.DrawableStates.Sprite),this.drawableOffState(this.DrawableStates.Fill)}}),this.on("POST_FRAME",function(t,n){var r,i,s,o,u;if(this.drawableIsState(this.DrawableStates.Fill)){t.fillStyle=this.fill_color,t.beginPath(),t.moveTo(this._mesh[0][0],this._mesh[0][1]),r=1;while(r<this._numvertices)t.lineTo(this._mesh[r][0],this._mesh[r][1]),++r;t.closePath(),t.fill()}this.drawableIsState(this.DrawableStates.Sprite)&&this.sprite!=null&&t.drawImage(this.sprite.img,-this.sprite.w2,-this.sprite.h2);if(this.drawableIsState(this.DrawableStates.Stroke)){t.strokeStyle=this.stroke_color,t.beginPath(),t.moveTo(this._mesh[0][0],this._mesh[0][1]),r=1;while(r<this._numvertices)t.lineTo(this._mesh[r][0],this._mesh[r][1]),++r;t.closePath(),t.stroke()}if(this.drawableIsState(this.DrawableStates.DrawOriginNormals)){r=0;while(r<this._numvertices)o=e.newFrom(this._mesh[r]),u=e.newFrom(this._mesh[(r+1)%this._numvertices]),s=e.sub([],u,o),s=e.perpendicular([],s),s=e.normalize([],s),s=e.scale([],s,50),t.strokeStyle="yellow",t.beginPath(),t.moveTo(0,0),t.lineTo(s[0],s[1]),t.closePath(),t.stroke(),++r}if(this.drawableIsState(this.DrawableStates.DrawNormals)){r=0,o=e.acquire(),u=e.acquire(),i=e.acquire(),s=e.acquire();while(r<this._numvertices)e.copy(o,this._mesh[r]),e.copy(u,this._mesh[(r+1)%this._numvertices]),e.addAndScale(i,o,u,.5),e.sub(s,u,o),e.perpendicular(o,s),e.normalize(u,o),e.scale(o,u,50),e.add(s,o,i),t.strokeStyle="yellow",t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(s[0],s[1]),t.closePath(),t.stroke(),++r;e.release(o),e.release(u),e.release(i),e.release(s)}if(this.drawableIsState(this.DrawableStates.DrawCenter))return t.strokeRect(0,0,1,1)})}return r.prototype.drawableToggleState=function(e){return e==null&&(e=DrawableStates.stroke),this._drawableState^=e},r.prototype.drawableOnState=function(e){return this._drawableState|=e},r.prototype.drawableOffState=function(e){return this.drawableOnState(e),this.drawableToggleState(e)},r.prototype.drawableIsState=function(e){return(this._drawableState&e)===e},r}(),r.prototype.DrawableStates={Stroke:0,DrawCenter:1,DrawOriginNormals:2,Glow:4,DrawNormals:8,Fill:16,Sprite:32},r})}.call(this),function(){define("collidable",["vec2","geometry"],function(e,t){var n;return n=function(){function e(){this.in_collision=!1,this.on("COLLISION_STARTED",function(e){return this.stroke_color="yellow",this.in_collision=!0}),this.on("COLLISION_ENDED",function(e){return this.stroke_color="white",this.in_collision=!1})}return e}(),n})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("bbresolvers",["vec2","mathutil","geometry"],function(e,n,r){var i,s,o,u,a,f,l,c;return s={AABPolygonFromSprite:function(e,t,n){return t==null&&(t=f),n==null&&(n=a),u(e,t,n)},AABBoxFromSprite:function(e){var t;return t=new n.ARRAY_TYPE(4),t[0]=-e.w*.5,t[1]=-e.h*.5,t[2]=e.w,t[3]=e.h,t},AABCircleFromSprite:function(e){var t;return t=Math.sqrt(e.w*e.w+e.h*e.h)*.5,t},AABBFromPolygon:function(e){var t,r,i,s,o,u,a,f;i=Number.MAX_VALUE,s=Number.MAX_VALUE,t=-Number.MIN_VALUE,r=-Number.MIN_VALUE;for(a=0,f=e.length;a<f;a++)u=e[a],i=Math.min(u[0],i),s=Math.min(u[1],s),t=Math.max(u[0],t),r=Math.max(u[1],r);return o=new n.ARRAY_TYPE(4),o[0]=i,o[1]=s,o[2]=Math.abs(i)+t,o[3]=Math.abs(s)+r,o}},u=function(t,r,i){var s,o,u,a,f,l,c,h,p;h=[],p=t.w,l=t.h,s=Hal.dom.createCanvas(p,l),a=s.getContext("2d"),u=[],a.drawImage(t.img,0,0),c=a.getImageData(0,0,p,l),f=function(){var t,r,i,s,o,u,a,f,l,c,p,d,v,m,g,y;f=0,r=0,t=1/33;if(h.length<2)return h;for(c=g=0,y=h.length;g<y;c=++g){a=h[c],u=h[c+1];if(u==null)break;o=e.from(a[0],a[1]),p=e.from(u[0],u[1]),v=e.sub([],p,o);if(v!=null){d=h[c+2];if(d==null)break;m=e.sub([],p,e.from(d[0],d[1]))}if(v!=null&&m!=null){e.normalize(v,v),e.normalize(m,m),s=e.dot(v,m),f=r,r=e.dot(v,m),i=Math.abs(r-f);if(i>t)return l=[h[c+2][0]-n.EPSILON,h[c+2][1]-n.EPSILON],h.splice(0,c+2),l}}},h=new r(c.data,p,l);while((o=f())!=null)u.push(o);return llogd("Number of critical points: "+u.length),new i(u)},o=function(){function e(e,t,n,r){return this.data=e!=null?e:[],this.width=t,this.height=n,this.sample_rate=r!=null?r:1,this.samplingFunc()}return e.prototype.samplingFunc=function(){return[]},e.prototype.getPixelAt=function(e,t){var n;return n=(e+this.width*t)*4,[this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]]},e}(),f=function(e){function n(){return l=n.__super__.constructor.apply(this,arguments),l}return t(n,e),n.prototype.samplingFunc=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;e=130,i=[];for(t=s=0,f=this.width,l=this.sample_rate;l>0?s<f:s>f;t=s+=l)for(n=o=0,c=this.height;0<=c?o<c:o>c;n=0<=c?++o:--o){r=this.getPixelAt(t,n);if(r[3]>e){i.push({x:t,y:n});break}}for(t=u=0,h=this.width,p=this.sample_rate;p>0?u<h:u>h;t=u+=p)for(n=a=d=this.height;a>0;n=a+=-1){r=this.getPixelAt(t,n);if(r[3]>e){i.unshift({x:t,y:n});break}}return i},n}(o),i=function(){function e(e){return this.downsamplingFunc(e)}return e.prototype.downsamplingFunc=function(){return[]},e}(),a=function(e){function n(){return c=n.__super__.constructor.apply(this,arguments),c}return t(n,e),n.prototype.downsamplingFunc=function(e){var t,n,i,s,o,u,a,f,l,c,h,p,d;i=3,h=e[0],u=e.length,n=e[u-1],a=0,o=0,f=[];if(u<2)return e;for(s=p=1,d=u-1;1<=d?p<d:p>d;s=1<=d?++p:--p)t=r.perpDistance(e[s],h,n),t>a&&(o=s,a=t);return a>i?(l=this.downsamplingFunc(e.slice(0,+o+1||9e9)),c=this.downsamplingFunc(e.slice(o,u)),l=l.slice(0,l.length-1),f=l.concat(c)):(f.push(h),f.push(n)),f},n}(i),s})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("shape",["vec2","matrix3","halalentity","transformable","drawable","geometry","collidable","bbresolvers","sprite"],function(e,r,i,s,o,u,a,f,l){var c,h;return h=["angle","scale","position","origin"],c=function(e){function n(){return n.__super__.constructor.call(this),this._mesh=[],this._numvertices=0,this}return t(n,e),n.include(s),n.include(o),n.include(a),n}(i),c.prototype.init=function(){return this.on("CHANGE",function(e,t){if(n.call(h,e)>=0)return this._update_mesh_transform=!0,this._update_transform=!0,this._update_inverse=!0}),this},c.prototype.transformShape=function(t){var n,r,i,s,o;n=0,r=[];while(n<t._numvertices)i=t._mesh[n],s=e.acquire(),o=e.acquire(),e.transformMat3(s,i,t.transform()),e.transformMat3(o,s,this.inverseTransform()),r.push(o),e.release(s),++n;return r},c.prototype.setShape=function(t){var n;return u.isPolygonConvex(t)||(llogw("Oh snap, mesh was degenerate"),t=u.polygonSortVertices(t)),n=Hal.geometry.polygonCentroidPoint(t),llogd(n),this.setOrigin(n[0],n[1]),e.release(n),this._mesh=t,this._numvertices=this._mesh.length,this},c.prototype.addVertex=function(t,n){return this._numvertices=this._mesh.push(e.from(t,n)),u.isPolygonConvex(this._mesh)||(llogw("Oh snap, mesh was degenerate"),this.setShape(u.polygonSortVertices(this._mesh))),this},c.prototype.update=function(e,t){this.transform(),this.scene.checkForCollisions(this)},c.prototype.draw=function(e,t){this.trigger("PRE_FRAME",e,t),e.setTransform(this._transform[0],this._transform[3],this._transform[1],this._transform[4],this._transform[2],this._transform[5]),this.trigger("POST_FRAME",e,t)},c.prototype.angleWithOrigin=function(t){return t=e.transformMat3(null,t,this._transform),u.angleOf([t[0]-this.origin[0],t[1]-this.origin[1]])},c.prototype.addShape=function(){},c})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("line",["vec2","matrix3","shape","geometry","mathutil"],function(e,n,r,i,s){var o;return o=function(n){function r(t,n){return r.__super__.constructor.call(this),this._mesh[0]=e.from(this.origin[0],this.origin[1]),this._mesh[1]=e.from(t,n),this._numvertices=2,this}return t(r,n),r}(r),o.prototype.angleBetween=function(t){var n;return n=e.transformMat3(null,t._mesh[1],this._transform),i.angleBetweenLines(n,this._mesh[1])},o})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("halal",["logger","eventdispatcher","scene","dommanager","renderer","geometry","vec2","matrix3","deferred","deferredcounter","domeventmanager","assetmanager","imgutils","entity","spriteentity","isometricmap","ajax","shape","line","mathutil"],function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){var E,S,x,T,N,C,k,L,A,O,M,_,D;return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1)}}(),window.performance==null&&(window.performance=Date),x=performance.now(),T=0,L=1,S=0,k=0,O=0,_=0,C=60,A=1/C,N=null,M=!0,D=function(){var e,t,n,r;_=x,x=performance.now(),T=(x-_)*.001,S+=T,T=Math.min(T,A),Hal.trigger("ENTER_FRAME",T),r=Hal.scenes;for(t=0,n=r.length;t<n;t++)e=r[t],e.update(T),e.draw(T);return S>=L&&(Hal.fps=k,S=0,k=0,Hal.trigger("FPS_UPDATE",Hal.fps)),Hal.trigger("EXIT_FRAME",T),O=requestAnimFrame(D),k++},E=function(e){function n(){n.__super__.constructor.call(this),this.dom=new i(this),this.id=0,this.debug_mode=!1,this.pressed_keys=[],this.scenes=[],this.fps=0,llogd("Engine constructed")}return t(n,e),n}(n),E.prototype.addScene=function(e){return e instanceof r?e.bounds?(e.name||(llogw("Name for scene wasn't provided"),e.name="#scene_"+e.id),e.init(),Hal.trigger("SCENE_ADDED_"+e.name.toUpperCase(),e),this.scenes.unshift(e),llogd("Added scene: "+e.name),e):(lloge("Bounds not set on scene "+e.name),null):(lloge("Not a Scene instance"),null)},E.prototype.pause=function(){return M=!0,cancelAnimationFrame(O),this.trigger("ENGINE_PAUSED")},E.prototype.resume=function(){return M=!1,D(),this.trigger("ENGINE_RESUMED")},E.prototype.viewportBounds=function(){return[0,0,this.dom.area.width,this.dom.area.height]},E.prototype.supports=function(e){return this.trigger("SUPPORTS_"+e)},E.prototype.init=function(){return this.evm=new c,this.glass=new s(this.viewportBounds(),null,11),this.glass.ctx.font="10pt monospace",this.glass.ctx.fillStyle="black",this.on("MOUSE_MOVE",function(e){var t,n,r,i,s;i=this.scenes,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.mpos=e);return s}),this.on("DESTROY_SCENE",function(e){var t;return t=this.scenes.indexOf(e),t===-1&&lloge("No such scene: "+e.name),this.scenes[t]=null,this.scenes.splice(t,1)}),llogd("Engine initialized")},E.prototype.start=function(){return this.init(),M=!1,this.trigger("ENGINE_STARTED"),llogd("Engine started"),D()},E.prototype.isPaused=function(){return M},E.prototype.debug=function(e){return this.debug_mode=e,Hal.trigger("DEBUG_MODE",this.debug_mode)},E.prototype.ID=function(){return++this.id},E.prototype.drawInfo=function(){return this.glass.ctx.setTransform(1,0,0,1,0,0),this.glass.ctx.fillText("FPS: "+this.fps,0,10)},E.prototype.tween=function(e,t,n,r,i,s,o){var u,a,l,c,h;return s==null&&(s=1),l=new f,n*=.001,a=0,c=(i-r)/n,h=r,Hal.on("ENTER_FRAME",u=function(f){a+=f,h+=c*f,e.attr(t,h,o),a=Math.min(a,n);if(n===a){s--,e.attr(t,i,o);if(s!==0)return a=0,h=r;l.resolve(e,u),Hal.remove("ENTER_FRAME",u)}}),[l.promise(),u]},E.prototype.tweenF=function(e,t,n,r,i){var s,o,u,a;i==null&&(i=1),e*=.001,o=0,u=(r-n)/e,a=n,Hal.on("ENTER_FRAME",s=function(f){o+=f,a+=u*f,t(a,f),o=Math.min(o,e);if(e===o){i--,t(r,f);if(i!==0)return o=0,a=n;Hal.remove("ENTER_FRAME",s)}})},E.prototype.fadeInViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},0,1)},E.prototype.fadeOutViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},1,0)},E.prototype.math=w,E.prototype.geometry=o,E.prototype.asm=new h,E.prototype.im=new p,E.prototype.Line=b,E.prototype.Vec2=u,E.prototype.Matrix3=a,E.prototype.Shape=y,E.prototype.Scene=r,E.prototype.Ajax=g,E.prototype.Keys={SHIFT:16,G:71,D:68,W:87,C:67,I:73,ONE:49,TWO:50,THREE:51,FOUR:52,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,F:70},window.Hal=new E,window.Hal})}.call(this);