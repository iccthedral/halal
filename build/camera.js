(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["vec2","halalentity","renderer"],function(e,n,r){var i;return i=function(n){function r(e,t,n){var i,s=this;this.ctx=e,this.scene=n,r.__super__.constructor.call(this),this.x=t[0],this.y=t[1],this.w=this.scene.bounds[2],this.h=this.scene.bounds[3],this.dragging=!1,this.start_drag_point=[0,0],this.prev_pos=[this.x,this.y],this.zoom=1,this.zoom_step=.1,this.camera_speed=90,this.angle=0,this.view_frustum=[],this.recalcCamera(),this.setViewFrustum(t),i=Hal.dom.createCanvasLayer(this.w,this.h,5e4),Hal.dom.addCanvas(i,0,0,!0),this.cctx=i.getContext("2d"),this.on("CHANGE",function(e){var t;if(e==null)return;if((t=e[0])==="w2"||t==="w"||t==="h2"||t==="h")return this.clipViewport()}),this.scene.on(["ENTER_FULLSCREEN","EXIT_FULLSCREEN"],function(e){return s.zoom=e[0],s.recalcCamera(),s.trigger("CHANGE")})}return t(r,n),r.prototype.recalcCamera=function(){return this.w*=this.zoom,this.h*=this.zoom,this.w2=this.w*.5,this.h2=this.h*.5,this.cx=this.w2,this.cy=this.h2},r.prototype.resize=function(e,t){return this.w=e/this.zoom,this.h=t/this.zoom,this.recalcCamera(),this.trigger("CHANGE")},r.prototype.clipViewport=function(){return this.cctx.fillStyle="rgba(0, 0, 0, 255);",this.cctx.fillRect(0,0,this.w,this.h),this.cctx.translate(this.cx,this.cy),this.cctx.clearRect(-this.w2,-this.h2,this.w,this.h),this.cctx.translate(-this.cx,-this.cy)},r.prototype.enableDrag=function(){var e=this;return this.drag_started=Hal.on("DRAG_STARTED",function(t){if(e.scene.paused)return;return e.lerp_anim&&(Hal.remove("EXIT_FRAME",e.lerp_anim),e.lerp_anim=null),e.dragging=!0,e.start_drag_point=t.slice(),e.prev_pos=[e.x*e.zoom,e.y*e.zoom]}),this.drag_ended=Hal.on("DRAG_ENDED",function(t){return e.dragging=!1}),this.drag=Hal.on("MOUSE_MOVE",function(t){if(e.scene.paused)return;if(e.dragging)return e.x=(e.prev_pos[0]+(t[0]-e.start_drag_point[0]))/e.zoom,e.y=(e.prev_pos[1]+(t[1]-e.start_drag_point[1]))/e.zoom,e.trigger("CHANGE",e.pos)})},r.prototype.enableZoom=function(){var e=this;return this.zoom_trig=Hal.on("SCROLL",function(t){if(e.scene.paused)return;return t.down?e.zoom-=e.zoom_step:e.zoom+=e.zoom_step,e.trigger("CHANGE",e.pos),e.trigger("ZOOM",e.zoom)})},r.prototype.setViewFrustum=function(e){return this.view_frustum[0]=e[0],this.view_frustum[1]=e[1],this.view_frustum[2]=e[2]-e[0],this.view_frustum[3]=e[3]-e[1],log.debug("Camera view frustum setted"),log.debug(this.view_frustum)},r.prototype.enableArrowKeys=function(){var e=this;return this.arrkeys=Hal.on("KEY_DOWN",function(t){t.keyCode===Hal.Keys.LEFT&&e.lerpTo([e.cx-e.camera_speed,e.cy]),t.keyCode===Hal.Keys.RIGHT&&e.lerpTo([e.cx+e.camera_speed,e.cy]),t.keyCode===Hal.Keys.UP&&e.lerpTo([e.cx,e.cy-e.camera_speed]);if(t.keyCode===Hal.Keys.DOWN)return e.lerpTo([e.cx,e.cy+e.camera_speed])})},r.prototype.disableArrowKeys=function(){return Hal.removeTrigger("KEY_DOWN",this.arrkeys)},r.prototype.enableLerp=function(){return this.lerpTo=function(t){var n,r,i=this;if(this.scene.paused)return;return n=this.cx-t[0]+this.x,r=this.cy-t[1]+this.y,this.lerp_anim&&(Hal.remove("EXIT_FRAME",this.lerp_anim),this.lerp_anim=null),this.lerp_anim=Hal.on("EXIT_FRAME",function(t){var s;return s=e.lerp([],[i.x,i.y],[n,r],t*i.camera_speed),i.x=s[0],i.y=s[1],~~Math.abs(i.x-n)+~~Math.abs(-i.y+r)<2&&(Hal.remove("EXIT_FRAME",i.lerp_anim),i.lerp_anim=null),i.trigger("CHANGE")})}},r.prototype.lerpTo=function(){},r.prototype.disableLerp=function(){return this.lerpTo=function(){}},r.prototype.disableZoom=function(){return Hal.removeTrigger("SCROLL",this.zoom_trig)},r.prototype.disableDrag=function(){return Hal.removeTrigger("DRAG_STARTED",this.drag_started),Hal.removeTrigger("DRAG_ENDED",this.drag_ended),Hal.removeTrigger("MOUSE_MOVE",this.drag)},r}(n),i})}).call(this);