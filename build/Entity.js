(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["HalalEntity","Scene","Matrix3","BBoxAlgos","Vec2"],function(e,n,r,i,s){var o;return o=function(e){function o(e){e==null&&(e={}),o.__super__.constructor.call(this),this.id=Hal.ID(),this.shape=e.shape!=null?e.shape:[[0,0],[0,1],[1,1],[1,0]],this.x=e.x!=null?e.x:0,this.y=e.y!=null?e.y:0,this.angle=e.angle!=null?e.angle:0,this.scale=e.scale!=null?e.scale:1,this.stroke_color=e.stroke_color!=null?e.stroke_color:"black",this.glow=e.glow!=null?e.glow:!1,this.glow_color=e.glow_color!=null?e.glow_color:"blue",this.glow_amount=e.glow_amount!=null?e.glow_amount:16,this.line_width=e.line_width!=null?e.line_width:1,this.draw_shape=e.draw_shape!=null?e.draw_shape:!0,this.opacity=e.opacity!=null?e.opacity:1,this.parent=null,this.world_pos=[0,0],this.quadspace=null,this.needs_updating=!0,this.draw_origin=!1,this.local_matrix=this.localMatrix(),this.bbox=i.rectFromPolyShape(this.shape),this.children=[],this.shapes=[],this.drawables=[],this.scene=null,this.selected_color="white",this.unselected_color=this.stroke_color,this.on("CHANGE",function(e){var t,n,r,s,o,u;n=e[0];if(n==="angle"||n==="scale"||n==="x"||n==="y"||n==="glow"||n==="parent"||n==="line_width"||n==="h")this.needs_updating=!0;n==="shape"&&this.sprite==null&&(this.bbox=i.rectFromPolyShape(this.shape),this.needs_updating=!0);if(n==="x"||n==="y")if(this.parent!=null&&this.quadspace!=null){this.parent.trigger("ENTITY_MOVING",this),o=this.children,u=[];for(r=0,s=o.length;r<s;r++)t=o[r],u.push(this.parent.trigger("ENTITY_MOVING",t));return u}}),this.on("ENTITY_ADDED",function(){return this.init()})}return t(o,e),o.prototype.localMatrix=function(){return[this.scale,0,this.x,0,this.scale,this.y,0,0,1]},o.prototype.rotationMatrix=function(){return[Math.cos(this.angle),-Math.sin(this.angle),0,Math.sin(this.angle),Math.cos(this.angle),0,0,0,1]},o.prototype.init=function(){var e=this;return this.parent instanceof n&&this.parent.camera.on("CHANGE",function(){return e.needs_updating=!0}),this.on("EXIT_FRAME",function(){return this.scene.g.ctx.setTransform(1,0,0,1,0,0)}),this.on("LEFT_CLICK",function(e){return this.selected=!this.selected,this.selected?this.trigger("SELECTED"):this.trigger("DESELECTED"),log.debug("yay, i've been selected: "+this.id)})},o.prototype.viewportPos=function(){var e;return e=r.transpose([],this.local_matrix),s.transformMat3([],[0,0],e)},o.prototype.worldPos=function(){return this.localToWorld([this.x,this.y])},o.prototype.localToWorld=function(e){var t;return t=r.transpose([],this.local_matrix),s.transformMat3([],e,t)},o.prototype.worldToLocal=function(e){return s.transformMat3([],e,r.transpose([],r.invert([],this.local_matrix)))},o.prototype.addEntity=function(e){return this.children.push(e),this.scene.addEntity(e),this.trigger("CHILD_ENTITY_ADDED",e),e.attr("scene",this.scene),e.attr("parent",this)},o.prototype.addEntityToQuadspace=function(e){return this.children.push(e),this.scene.addEntityToQuadspace(e),this.trigger("CHILD_ENTITY_ADDED",e),e.attr("scene",this.scene),e.attr("parent",this),e},o.prototype.destroy=function(e){return e==null&&(e=!0),this.removeAll(),this.scene.removeEntity(this),e&&this.destroyChildren(),this.children=null,this.drawables=null,this.parent=null,this.quadspace==null?log.warn("this entity had no quadspace"):this.quadspace.remove(this),this.quadspace=null,this.scene=null,this.trigger("ON_DESTROY")},o.prototype.destroyChildren=function(){var e,t,n,r,i;r=this.children,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.destroy());return i},o.prototype.update=function(e){this.scene.g.ctx.setTransform(this.local_matrix[0],this.local_matrix[3],this.local_matrix[1],this.local_matrix[4],this.local_matrix[2],this.local_matrix[5]);if(this.needs_updating){this.local_matrix=r.mul(this.rotationMatrix(),this.localMatrix()),this.local_matrix=r.mul(this.local_matrix,this.parent.local_matrix),this.needs_updating=!1;if(!this.glow)return this.scene.g.ctx.shadowBlur=0}},o.prototype.addDrawable=function(e){return this.drawables.push(e)},o.prototype.addShape=function(e){return this.shapes.push(e)},o.prototype.draw=function(e){var t,n,r,i,s,o,u,a;this.scene.g.ctx.globalAlpha=this.opacity,this.draw_shape&&this.line_width>1&&(this.scene.g.ctx.lineWidth=this.line_width),this.glow&&(this.scene.g.ctx.shadowBlur=this.glow_amount,this.scene.g.ctx.shadowColor=this.glow_color),this.draw_shape&&this.scene.g.strokePolygon(this.shape,this.selected?this.selected_color:this.stroke_color),this.glow&&(this.scene.g.ctx.shadowBlur=0),this.line_width!==1&&this.draw_shape&&(this.scene.g.ctx.lineWidth=1),this.draw_origin&&(this.scene.g.drawLine(0,0,0,-100,"green"),this.scene.g.drawLine(-50,0,50,0,"green")),this.draw_bbox&&this.scene.g.strokeRect(this.bbox,"cyan"),o=this.drawables;for(n=0,i=o.length;n<i;n++)t=o[n],t.call(this,e);u=this.shapes,a=[];for(r=0,s=u.length;r<s;r++)t=u[r],a.push(this.scene.g.strokePolygon(t,"blue"));return a},o}(e),o})}).call(this);