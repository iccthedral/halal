(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["halalentity","renderer","camera","matrix3","quadtree","vec2"],function(e,n,r,i,s,o){var u;return u=function(e){function u(e){e==null&&(e={}),u.__super__.constructor.call(this),this.name=e.name!=null?e.name:""+Hal.ID(),this.bounds=e.bounds!=null?e.bounds:Hal.viewportBounds(),this.paused=!0,this.bg_color=e.bg_color!=null?e.bg_color:"white",this.entities=[],this.identity_matrix=i.create(),this.mpos=[0,0],this.viewport_pos=[0,0],this.world_pos=[0,0],this.quadspace=null,this.ent_cache={},this.ent_groups={},this.draw_camera_center=e.draw_camera_center!=null,this.draw_stat=e.draw_stat==null,this.draw_quadspace=e.draw_quadspace!=null?e.draw_quadspace:!1,this.local_matrix=i.create(),this.z=e.z!=null?e.z:1,this.g=new n(this.bounds,null,this.z),this.cam_bounds=e.cam_bounds!=null?e.cam_bounds:this.bounds.slice(),this.draw_bbox=e.draw_bbox!=null,this.draw=e.draw!=null?e.draw:function(){},this.update=e.update!=null?e.update:function(){},this.needs_updating=!0,this.center=[this.bounds[2]*.5,this.bounds[3]*.5],this.search_range=this.bounds[2],this.visible_ents=[],this.world_center_pos=this.worldToLocal(this.center),this.total_rendered=0,this.left_click_listener=null,this.left_dbl_click_listener=null,this.resetQuadSpace([0,0,this.cam_bounds[2],this.cam_bounds[3]]),this.on("GROUP_CHANGE",function(e){var t,n;return t=this.ent_groups[e.group],t==null&&(t=this.ent_groups[e.group]=[]),n=t.indexOf(e),n!==-1?t.splice(n,1):t.push(e)})}return t(u,e),u.prototype.resetQuadSpace=function(e){return Hal.log.debug("QuadSpace reset"),this.quadspace=null,this.quadspace=new s(e),this.quadspace.divide(),this.addCamera()},u.prototype.addCamera=function(){return this.camera=new r(this.g.ctx,this.cam_bounds,this),this.camera.enableDrag(),this.camera.enableLerp(),this.camera.enableZoom()},u.prototype.addEntityToQuadspace=function(e){return e=this.addEntity(e),this.quadspace.insert(e)||Hal.log.warn("Couldn't add entity "+e.id+" to quadspace"),e},u.prototype.addEntity=function(e){return this.entities.push(e),this.ent_cache[e.id]=e,e.attr("parent",this),e.attr("scene",this),e.attr("needs_updating",!0),e.trigger("ENTITY_ADDED"),this.trigger("GROUP_CHANGE",e),e},u.prototype.rotationMatrix=function(){return[Math.cos(this.camera.angle),-Math.sin(this.camera.angle),this.camera.cx,Math.sin(this.camera.angle),Math.cos(this.camera.angle),this.camera.cy,0,0,1]},u.prototype.localMatrix=function(){return[this.camera.zoom,0,this.camera.zoom*(this.camera.x-this.camera.cx),0,this.camera.zoom,this.camera.zoom*(this.camera.y-this.camera.cy),0,0,1]},u.prototype.worldToLocal=function(e){return o.transformMat3([],e,i.transpose([],i.invert([],this.local_matrix)))},u.prototype.localToWorld=function(e){var t;return t=i.transpose(i.create(),this.local_matrix),o.transformMat3([],e,t)},u.prototype.destroy=function(){return this.removeAllEntities(),this.camera.remove("CHANGE",this.cam_change),Hal.remove("EXIT_FRAME",this.exit_frame),Hal.remove("ENTER_FRAME",this.enter_frame),Hal.remove("LEFT_CLICK",this.left_click_listener),Hal.remove("LEFT_DBL_CLICK",this.left_dbl_click_listener),Hal.remove("RESIZE",this.resize_event),Hal.trigger("DESTROY_SCENE",this),this.quadspace=null,this.camera=null,this.renderer=null,this.removeAll()},u.prototype.drawStat=function(){if(this.paused)return;return Hal.glass.ctx.setTransform(1,0,0,1,0,0),Hal.glass.ctx.clearRect(0,0,400,300),Hal.glass.ctx.font="10pt monospace",Hal.glass.ctx.fillStyle="black",Hal.glass.ctx.fillText("FPS: "+Hal.fps,0,10),Hal.glass.ctx.fillText("Num of entities: "+this.entities.length,0,25),Hal.glass.ctx.fillText("Zoom: "+this.camera.zoom,0,40),Hal.glass.ctx.fillText("Mouse: "+this.mpos[0]+", "+this.mpos[1],0,55),Hal.glass.ctx.fillText("Camera pos: "+this.camera.x.toFixed(2)+", "+this.camera.y.toFixed(2),0,70),Hal.glass.ctx.fillText("World pos: "+this.world_pos[0].toFixed(2)+", "+this.world_pos[1].toFixed(2),0,85),Hal.glass.ctx.fillText("Center relative pos: "+(this.mpos[0]-this.camera.cx-this.bounds[0])+", "+(this.mpos[1]-this.camera.cy-this.bounds[1]),0,100),Hal.glass.ctx.fillText("Rendered total: "+this.total_rendered,0,175)},u.prototype.removeEntity=function(e){var t,n;if(!this.ent_cache[e.id]){log.error("No such entity "+e.id+" in cache");return}n=this.entities.indexOf(e);if(n===-1){log.error("No such entity "+e.id+" in entity list");return}return t=this.ent_groups[e.group],t!=null&&(n=t.indexOf(e),t.splice(n,1)),delete this.ent_cache[e.id],this.trigger("ENTITY_DESTROYED",e),this.entities.splice(n,1)},u.prototype.getAllEntities=function(){return this.entities.slice()},u.prototype.removeAllEntities=function(e){var t,n,r,i;e==null&&(e=!1),i=this.getAllEntities();for(n=0,r=i.length;n<r;n++)t=i[n],t.destroy(e)},u.prototype.removeEntityByID=function(e){var t;return t=this.ent_cache[e],t!=null?t.removeEntity(t):log.error("No such entity "+e+" in entity cache")},u.prototype.update_=function(e){return this.delta=e,this.total_rendered=0,this.needs_updating&&(this.applyIdentity(),this.g.ctx.fillStyle=this.bg_color,this.g.ctx.fillRect(0,0,this.bounds[2],this.bounds[3]),this.calcLocalMatrix(),this.updateSceneGraph(this.quadspace)),this.update(e)},u.prototype.draw_=function(e){var t,n,r,i;this.delta=e;if(this.paused)return;this.applyLocal(),this.draw_quadspace&&(this.drawQuadSpace(this.quadspace),this.g.ctx.textAlign="start",this.g.strokeRect(this.camera.view_frustum,"green"));if(this.needs_updating){i=this.visible_ents;for(n=0,r=i.length;n<r;n++)t=i[n],t.draw(this.delta),this.total_rendered++;this.visible_ents=[],this.needs_updating=!1}return this.draw(e)},u.prototype.applyLocal=function(){return this.g.ctx.setTransform(this.local_matrix[0],this.local_matrix[3],this.local_matrix[1],this.local_matrix[4],this.local_matrix[2],this.local_matrix[5])},u.prototype.applyIdentity=function(){return this.g.ctx.setTransform(this.identity_matrix[0],this.identity_matrix[3],this.identity_matrix[1],this.identity_matrix[4],this.identity_matrix[2],this.identity_matrix[5])},u.prototype.updateSceneGraph=function(e){var t,n,r,i,s,o,u,a;if(this.paused)return;e.nw!=null&&this.updateSceneGraph(e.nw),e.ne!=null&&this.updateSceneGraph(e.ne),e.sw!=null&&this.updateSceneGraph(e.sw),e.se!=null&&this.updateSceneGraph(e.se),n=this.worldToLocal([0,0]),i=[n[0],n[1],this.camera.w/this.camera.zoom,this.camera.h/this.camera.zoom];if(Hal.math.rectIntersectsOrContainsRect(i,e.bounds)){u=e.pts,a=[];for(s=0,o=u.length;s<o;s++)r=u[s],t=[r.x+r.bbox[0],r.y+r.bbox[1],r.bbox[2]-r.bbox[0],r.bbox[3]-r.bbox[1]],Hal.math.rectIntersectsOrContainsRect(i,t)?(this.visible_ents.push(r),r.needs_updating=!0,a.push(r.update(this.delta))):a.push(void 0);return a}},u.prototype.drawQuadSpace=function(e){if(this.paused)return;this.g.ctx.textAlign="center",this.g.ctx.fillStyle="white",e.nw!=null&&(this.drawQuadSpace(e.nw),this.g.ctx.strokeRect(e.nw.bounds[0],e.nw.bounds[1],e.nw.bounds[2],e.nw.bounds[3]),this.g.ctx.fillText(""+e.nw.id,e.nw.bounds[0]+e.nw.bounds[2]*.5,e.nw.bounds[1]+e.nw.bounds[3]*.5)),e.ne!=null&&(this.drawQuadSpace(e.ne),this.g.ctx.strokeRect(e.ne.bounds[0],e.ne.bounds[1],e.ne.bounds[2],e.ne.bounds[3]),this.g.ctx.fillText(""+e.ne.id,e.ne.bounds[0]+e.ne.bounds[2]*.5,e.ne.bounds[1]+e.ne.bounds[3]*.5)),e.sw!=null&&(this.drawQuadSpace(e.sw),this.g.ctx.strokeRect(e.sw.bounds[0],e.sw.bounds[1],e.sw.bounds[2],e.sw.bounds[3]),this.g.ctx.fillText(""+e.sw.id,e.sw.bounds[0]+e.sw.bounds[2]*.5,e.sw.bounds[1]+e.sw.bounds[3]*.5));if(e.se!=null)return this.drawQuadSpace(e.se),this.g.ctx.strokeRect(e.se.bounds[0],e.se.bounds[1],e.se.bounds[2],e.se.bounds[3]),this.g.ctx.fillText(""+e.se.id,e.se.bounds[0]+e.se.bounds[2]*.5,e.se.bounds[1]+e.se.bounds[3]*.5)},u.prototype.calcLocalMatrix=function(){return this.local_matrix=i.mul(this.localMatrix(),this.rotationMatrix())},u.prototype.pause=function(){return this.attr("paused",!0)},u.prototype.resume=function(){return this.attr("paused",!1)},u.prototype.group=function(e){return this.ent_groups[e]==null?[]:this.ent_groups[e].slice()},u.prototype.init=function(){var e=this;return this.paused=!1,this.attr("draw_bbox",this.draw_bbox!=null),this.on("CHANGE",function(e){var t=this;if(e&&e[0]!=="draw_quadspace"&&e[0]==="draw_bbox")return this.entities.forEach(function(e){return e.attr("draw_bbox",t.draw_bbox)})}),this.cam_change=this.camera.on("CHANGE",function(){if(e.paused)return;return e.needs_updating=!0}),this.resize_event=Hal.on("RESIZE",function(t){return e.g.resize(t.width,t.height),e.bounds[2]=t.width,e.bounds[3]=t.height,e.camera.resize(t.width,t.height)}),this.exit_frame=Hal.on("EXIT_FRAME",function(){if(e.paused)return;e.draw_camera_center&&(e.g.ctx.setTransform(1,0,0,1,0,0),e.g.ctx.translate(e.camera.cx,e.camera.cy),e.g.strokeRectO([0,0,6,6],"white"),e.g.ctx.lineWidth=5,e.g.strokeRectO([0,0,e.camera.w,e.camera.h],"white"),e.g.ctx.translate(-e.camera.cx,-e.camera.cy),e.g.ctx.lineWidth=1);if(e.draw_stat)return e.drawStat()}),this.calcLocalMatrix(),this.left_click_listener=Hal.on("LEFT_CLICK",function(t){return e.trigger("LEFT_CLICK",t)}),this.left_dbl_click_listener=Hal.on("LEFT_DBL_CLICK",function(t){return e.trigger("LEFT_DBL_CLICK",t)}),this.on("ENTITY_MOVING",function(e){return Hal.math.isPointInRect(e.viewportPos(),e.quadspace.bounds)||(Hal.log.debug("i'm out of my quadspace "+e.id),e.quadspace.remove(e),this.quadspace.insert(e)),this.camera.trigger("CHANGE")})},u}(e),u})}).call(this);