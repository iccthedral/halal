(function(){define("eventdispatcher",[],function(){var e;return e=function(){function e(){this.listeners=[]}return e}(),e.prototype.on=function(e,t){var n,r,i,s;if(e instanceof Array)for(i=0,s=e.length;i<s;i++)r=e[i],this.listeners[r]==null&&(this.listeners[r]=[]),this.listeners[r].push(t);else this.listeners[e]==null&&(this.listeners[e]=[]),this.listeners[e].push(t),n=this.listeners[e].indexOf(t);return t},e.prototype.remove=function(e,t){var n;if(this.listeners[e]!=null)return n=this.listeners[e].indexOf(t),n!==-1&&this.listeners[e].splice(n,1),t=null},e.prototype.removeAll=function(e){var t,n,r,i,s,o;if(e)return delete this.listeners[e];n=Object.keys(this.listeners),o=[];for(i=0,s=n.length;i<s;i++)t=n[i],o.push(function(){var e,n,i,s;i=this.listeners[t],s=[];for(e=0,n=i.length;e<n;e++)r=i[e],s.push(this.remove(t,r));return s}.call(this));return o},e.prototype.trigger=function(e,t,n){var r,i,s,o,u;n==null&&(n=this);if(!this.listeners[e])return;o=this.listeners[e],u=[];for(i=0,s=o.length;i<s;i++)r=o[i],r!=null?u.push(r.call(n,t,r)):u.push(void 0);return u},e})}).call(this),function(){var e=[].slice;define("deferred",[],function(){var t,n;return n=function(){function e(){this.successChain=[],this.failChain=[]}return e.prototype.then=function(e){return this.successChain.push(e),this},e.prototype.fail=function(e){return this.failChain.push(e),this},e}(),t=function(){function t(e){this.prom=new n}return t.prototype.resolve=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.traverse_chain("successChain",n,t)},t.prototype.reject=function(){var t,n;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],this.traverse_chain("failChain",n,t)},t.prototype.promise=function(){return this.prom},t.prototype.traverse_chain=function(e,t,n){var r,i,s,o,u;t==null&&(t=this),o=this.prom[e],u=[];for(i=0,s=o.length;i<s;i++)r=o[i],u.push(r.apply(t,n));return u},t}(),window.Deferred=t,t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("halalentity",["eventdispatcher","deferred"],function(e,n){var r,i;return i=function(){function e(e){this.obj=e,this.num_tweens=0,this.to_wait=0,this.tween_chain=[],this.animating=!1}return e.prototype.tween=function(e){var t,n=this;return this.num_tweens++,this.to_wait>0?(this.tween_chain.push(e),this):(this.animating=!0,t=Hal.tween(this.obj,e.attr,e.duration,e.from,e.to,e.repeat),t.then(function(){n.num_tweens--,n.num_tweens===0&&n.done_clb!=null&&n.done_clb.call(n.obj),n.to_wait>0&&(n.to_wait--,n.tween(n.tween_chain.pop()),n.num_tweens--);if(n.num_tweens===0&&n.to_wait===0)return n.animating=!1}),this)},e.prototype.wait=function(e){return this.wait_clb=e,this.to_wait++,this},e.prototype.done=function(e){this.done_clb=e},e}(),r=function(e){function n(){n.__super__.constructor.call(this),this.animating=!1}return t(n,e),n.prototype.attr=function(e,t){return arguments.length===1?typeof e=="string"?this[e]:(this.extend(e),this.trigger("CHANGE",e)):(this[e]=t,this.trigger("CHANGE",[e,t]))},n.prototype.extend=function(e){var t,n;if(e==null)return this;for(t in e){n=e[t];if(this===n)continue;this[t]=n}return this},n.prototype.tween=function(e){return(new i(this)).tween(e)},n}(e)})}.call(this),function(){define("renderer",[],function(){var e;return e=function(){function e(e,t,n){this.bounds=e,t!=null?this.canvas=t:(this.canvas=Hal.dom.createCanvasLayer(this.bounds[2],this.bounds[3],n),Hal.dom.addCanvas(this.canvas,this.bounds[0],this.bounds[1],!0)),this.ctx=this.canvas.getContext("2d")}return e}(),e.prototype.resize=function(e,t){return this.canvas.width=e,this.canvas.height=t,this.prev_bnds=this.bounds.slice(),this.bounds[2]=e,this.bounds[3]=t},e.prototype.strokePolygon=function(e,t){var n,r,i,s;this.ctx.strokeStyle=t,this.ctx.beginPath(),this.ctx.moveTo(e[0][0],e[0][1]),s=e.slice(1);for(r=0,i=s.length;r<i;r++)n=s[r],this.ctx.lineTo(n[0],n[1]);return this.ctx.closePath(),this.ctx.stroke()},e.prototype.drawLine=function(e,t,n,r,i){return this.ctx.strokeStyle=i,this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(n,r),this.ctx.closePath(),this.ctx.stroke()},e.prototype.strokeRect=function(e,t){return this.ctx.strokeStyle=t,this.ctx.strokeRect(e[0],e[1],e[2],e[3])},e.prototype.drawSprite=function(e,t,n){return t==null&&(t=0),n==null&&(n=0),this.ctx.drawImage(e.img,-e.w2-t,-e.h2-n)},e})}.call(this),define("vec2",[],function(){var e={};return e.create=function(){var e=[];return e[0]=0,e[1]=0,e},e.clone=function(e){var t=[];return t[0]=e[0],t[1]=e[1],t},e.fromValues=function(e,t){var n=[];return n[0]=e,n[1]=t,n},e.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},e.set=function(e,t,n){return e[0]=t,e[1]=n,e},e.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},e.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e},e.sub=e.subtract,e.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},e.mul=e.multiply,e.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},e.div=e.divide,e.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},e.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},e.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},e.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},e.distance=function(e,t){var n=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(n*n+r*r)},e.dist=e.distance,e.sqDistance=function(e,t){var n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},e.sqDist=e.sqDistance,e.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},e.len=e.length,e.sqLength=function(e){var t=e[0],n=e[1];return t*t+n*n},e.sqLen=e.sqLength,e.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},e.normalize=function(e,t){var n=t[0],r=t[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i),e},e.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},e.perp=function(t){return e.fromValues(t[1],-t[0])},e.clerp=function(e,t,n,r){var i=t[0],s=t[1];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e},e.cross=function(e,t){var n=e[0]*t[1]-e[1]*t[0];return out[0]=out[1]=0,out[2]=n,out},e.lerp=function(e,t,n,r){var i=t[0],s=t[1];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e},e.lerpInt=function(e,t,n,r){var i=t[0],s=t[1];return e[0]=Math.floor(i+r*(n[0]-i)),e[1]=Math.floor(s+r*(n[1]-s)),e},e.random=function(e,t){t=t||1;var n=Math.random()*2*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},e.transformMat2=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i,e[1]=n[1]*r+n[3]*i,e},e.transformMat2d=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i+n[4],e[1]=n[1]*r+n[3]*i+n[5],e},e.transformMat3=function(e,t,n){var r=t[0],i=t[1];return e[0]=r*n[0]+i*n[3]+n[6],e[1]=r*n[1]+i*n[4]+n[7],e},e.transformMat4=function(e,t,n){var r=t[0],i=t[1];return e[0]=r*n[0]+i*n[4]+n[12],e[1]=r*n[1]+i*n[5]+n[13],e},e.forEach=function(){var t=e.create();return function(e,n,r,i,s,o){var u,a;n||(n=2),r||(r=0),i?a=Math.min(i*n+r,e.length):a=e.length;for(u=r;u<a;u+=n)t[0]=e[u],t[1]=e[u+1],s(t,t,o),e[u]=t[0],e[u+1]=t[1];return e}}(),e.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},window.Vec2=e,e}),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("camera",["vec2","halalentity","renderer"],function(e,n,r){var i;return i=function(n){function r(e,t,n){var i,s=this;this.ctx=e,this.scene=n,r.__super__.constructor.call(this),this.x=t[0],this.y=t[1],this.w=this.scene.bounds[2],this.h=this.scene.bounds[3],this.dragging=!1,this.start_drag_point=[0,0],this.prev_pos=[this.x,this.y],this.zoom=1,this.zoom_step=.1,this.camera_speed=90,this.angle=0,this.view_frustum=[],this.recalcCamera(),this.setViewFrustum(t),i=Hal.dom.createCanvasLayer(this.w,this.h,5e4),Hal.dom.addCanvas(i,0,0,!0),this.cctx=i.getContext("2d"),this.on("CHANGE",function(e){var t;if(e==null)return;if((t=e[0])==="w2"||t==="w"||t==="h2"||t==="h")return this.clipViewport()}),this.scene.on(["ENTER_FULLSCREEN","EXIT_FULLSCREEN"],function(e){return s.zoom=e[0],s.recalcCamera(),s.trigger("CHANGE")})}return t(r,n),r.prototype.recalcCamera=function(){return this.w*=this.zoom,this.h*=this.zoom,this.w2=this.w*.5,this.h2=this.h*.5,this.cx=this.w2,this.cy=this.h2},r.prototype.resize=function(e,t){return this.w=e/this.zoom,this.h=t/this.zoom,this.recalcCamera(),this.trigger("CHANGE")},r.prototype.clipViewport=function(){return this.cctx.fillStyle="rgba(0, 0, 0, 255);",this.cctx.fillRect(0,0,this.w,this.h),this.cctx.translate(this.cx,this.cy),this.cctx.clearRect(-this.w2,-this.h2,this.w,this.h),this.cctx.translate(-this.cx,-this.cy)},r.prototype.enableDrag=function(){var e=this;return this.drag_started=Hal.on("DRAG_STARTED",function(t){if(e.scene.paused)return;return e.lerp_anim&&(Hal.remove("EXIT_FRAME",e.lerp_anim),e.lerp_anim=null),e.dragging=!0,e.start_drag_point=t.slice(),e.prev_pos=[e.x*e.zoom,e.y*e.zoom]}),this.drag_ended=Hal.on("DRAG_ENDED",function(t){return e.dragging=!1}),this.drag=Hal.on("MOUSE_MOVE",function(t){if(e.scene.paused)return;if(e.dragging)return e.x=(e.prev_pos[0]+(t[0]-e.start_drag_point[0]))/e.zoom,e.y=(e.prev_pos[1]+(t[1]-e.start_drag_point[1]))/e.zoom,e.trigger("CHANGE",e.pos)})},r.prototype.enableZoom=function(){var e=this;return this.zoom_trig=Hal.on("SCROLL",function(t){if(e.scene.paused)return;return t.down?e.zoom-=e.zoom_step:e.zoom+=e.zoom_step,e.trigger("CHANGE",e.pos),e.trigger("ZOOM",e.zoom)})},r.prototype.setViewFrustum=function(e){return this.view_frustum[0]=e[0],this.view_frustum[1]=e[1],this.view_frustum[2]=e[2]-e[0],this.view_frustum[3]=e[3]-e[1],log.debug("Camera view frustum setted"),log.debug(this.view_frustum)},r.prototype.enableArrowKeys=function(){var e=this;return this.arrkeys=Hal.on("KEY_DOWN",function(t){t.keyCode===Hal.Keys.LEFT&&e.lerpTo([e.cx-e.camera_speed,e.cy]),t.keyCode===Hal.Keys.RIGHT&&e.lerpTo([e.cx+e.camera_speed,e.cy]),t.keyCode===Hal.Keys.UP&&e.lerpTo([e.cx,e.cy-e.camera_speed]);if(t.keyCode===Hal.Keys.DOWN)return e.lerpTo([e.cx,e.cy+e.camera_speed])})},r.prototype.disableArrowKeys=function(){return Hal.removeTrigger("KEY_DOWN",this.arrkeys)},r.prototype.enableLerp=function(){return this.lerpTo=function(t){var n,r,i=this;if(this.scene.paused)return;return n=this.cx-t[0]+this.x,r=this.cy-t[1]+this.y,this.lerp_anim&&(Hal.remove("EXIT_FRAME",this.lerp_anim),this.lerp_anim=null),this.lerp_anim=Hal.on("EXIT_FRAME",function(t){var s;return s=e.lerp([],[i.x,i.y],[n,r],t*i.camera_speed),i.x=s[0],i.y=s[1],~~Math.abs(i.x-n)+~~Math.abs(-i.y+r)<2&&(Hal.remove("EXIT_FRAME",i.lerp_anim),i.lerp_anim=null),i.trigger("CHANGE")})}},r.prototype.lerpTo=function(){},r.prototype.disableLerp=function(){return this.lerpTo=function(){}},r.prototype.disableZoom=function(){return Hal.removeTrigger("SCROLL",this.zoom_trig)},r.prototype.disableDrag=function(){return Hal.removeTrigger("DRAG_STARTED",this.drag_started),Hal.removeTrigger("DRAG_ENDED",this.drag_ended),Hal.removeTrigger("MOUSE_MOVE",this.drag)},r}(n),i})}.call(this),function(){define("matrix3",[],function(){var e;return e={},e.create=function(){var e;return e=[],e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},e.invert=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;return n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p,d===0?(log.debug("oh god no"),null):(d=1/d,e[0]=c*d,e[1]=(-l*r+i*f)*d,e[2]=(u*r-i*o)*d,e[3]=h*d,e[4]=(l*n-i*a)*d,e[5]=(-u*n+i*s)*d,e[6]=p*d,e[7]=(-f*n+r*a)*d,e[8]=(o*n-r*s)*d,e)},e.transpose=function(e,t){var n,r,i;return e===t?(n=t[1],r=t[2],i=t[5],e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=i):(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]),e},e.mul=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;return w=[],n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=t[0],h=t[1],p=t[2],d=t[3],v=t[4],m=t[5],g=t[6],y=t[7],b=t[8],w[0]=c*n+h*s+p*a,w[1]=c*r+h*o+p*f,w[2]=c*i+h*u+p*l,w[3]=d*n+v*s+m*a,w[4]=d*r+v*o+m*f,w[5]=d*i+v*u+m*l,w[6]=g*n+y*s+b*a,w[7]=g*r+y*o+b*f,w[8]=g*i+y*u+b*l,w},window.Matrix3=e,e})}.call(this),function(){define("quadtree",["vec2"],function(e){var t,n;return n=12,t=function(){function e(e){this.bounds=e,this.pts=[],this.nw=null,this.sw=null,this.ne=null,this.se=null}return e.prototype.insert=function(e){return Hal.math.isPointInRect(e.worldPos(),this.bounds)?this.pts.length<n?(e.quadspace=this,this.pts.push(e),!0):(this.nw==null&&this.divide(),this.nw.insert(e)?!0:this.ne.insert(e)?!0:this.sw.insert(e)?!0:this.se.insert(e)?!0:!1):!1},e.prototype.remove=function(e){var t;return t=this.pts.indexOf(e),this.pts.splice(t,1)},e.prototype.searchInRange=function(e,t,n){var r,i,s,o,u,a,f;i=[],s=[e[0]-t,e[1]-t,2*t,2*t];if(!Hal.math.rectIntersectsRect(s,this.bounds))return i;f=this.pts;for(u=0,a=f.length;u<a;u++)o=f[u],r=o.worldToLocal(n.localToWorld(e)),Hal.math.rectIntersectsRect(o.bbox,[r[0]-t,r[1]-t,2*t,2*t])&&i.push(o);return this.nw==null?i:(i=i.concat(this.nw.searchInRange(e,t,n)),i=i.concat(this.ne.searchInRange(e,t,n)),i=i.concat(this.sw.searchInRange(e,t,n)),i=i.concat(this.se.searchInRange(e,t,n)),i)},e.prototype.divide=function(){var t,n;return n=this.bounds[2]*.5,t=this.bounds[3]*.5,this.nw=new e([this.bounds[0],this.bounds[1],n,t]),this.ne=new e([this.bounds[0]+n,this.bounds[1],n,t]),this.sw=new e([this.bounds[0],this.bounds[1]+t,n,t]),this.se=new e([this.bounds[0]+n,this.bounds[1]+t,n,t])},e}(),t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("scene",["halalentity","renderer","camera","matrix3","quadtree","vec2"],function(e,n,r,i,s,o){var u;return u=function(e){function u(e){e==null&&(e={}),u.__super__.constructor.call(this),this.name=e.name!=null?e.name:""+Hal.ID(),this.bounds=e.bounds!=null?e.bounds:Hal.viewportBounds(),this.paused=!0,this.bg_color=e.bg_color!=null?e.bg_color:"white",this.entities=[],this.identity_matrix=i.create(),this.update_clip=!1,this.mpos=[0,0],this.viewport_pos=[0,0],this.world_pos=[0,0],this.quadspace=null,this.ent_cache={},this.draw_camera_center=e.draw_camera_center!=null?e.draw_camera_center:!1,this.draw_stat=e.draw_stat!=null?e.draw_stat:!0,this.draw_quadspace=e.draw_quadspace!=null?e.draw_quadspace:!1,this.local_matrix=i.create(),this.z=e.z!=null?e.z:1,this.g=new n(this.bounds,null,this.z),this.cam_bounds=e.cam_bounds!=null?e.cam_bounds:this.bounds.slice(),log.debug(this.cam_bounds),this.resetQuadSpace([0,0,this.cam_bounds[2],this.cam_bounds[3]])}return t(u,e),u.prototype.resetQuadSpace=function(e){return log.debug("QuadSpace reset"),this.quadspace=null,this.quadspace=new s(e),this.quadspace.divide()},u.prototype.addCamera=function(){return this.camera=new r(this.g.ctx,this.cam_bounds,this),this.camera.enableDrag(),this.camera.enableLerp(),this.camera.enableZoom()},u.prototype.addEntityToQuadspace=function(e){return e=this.addEntity(e),this.quadspace.insert(e),e},u.prototype.addEntity=function(e){return this.entities.push(e),this.ent_cache[e.id]=e,e.attr("parent",this),e.attr("scene",this),e.attr("needs_updating",!0),e.trigger("ENTITY_ADDED"),e},u.prototype.rotationMatrix=function(){return[Math.cos(this.camera.angle),-Math.sin(this.camera.angle),this.camera.cx,Math.sin(this.camera.angle),Math.cos(this.camera.angle),this.camera.cy,0,0,1]},u.prototype.localMatrix=function(){return[this.camera.zoom,0,this.camera.zoom*(this.camera.x-this.camera.cx),0,this.camera.zoom,this.camera.zoom*(this.camera.y-this.camera.cy),0,0,1]},u.prototype.worldToLocal=function(e){return o.transformMat3([],e,i.transpose([],i.invert([],this.local_matrix)))},u.prototype.localToWorld=function(e){var t;return t=i.transpose(i.create(),this.local_matrix),o.transformMat3([],e,t)},u.prototype.destroy=function(){return this.removeAllEntities(),this.camera.remove("CHANGE",this.cam_change),Hal.remove("EXIT_FRAME",this.exit_frame),Hal.remove("ENTER_FRAME",this.enter_frame),Hal.remove("LEFT_CLICK",this.click_listeners),Hal.remove("LEFT_DBL_CLICK",this.click_listeners),Hal.remove("RESIZE",this.resize_event),Hal.trigger("DESTROY_SCENE",this),this.quadspace=null,this.camera=null,this.renderer=null,this.removeAll()},u.prototype.drawStat=function(){if(this.paused)return;return this.g.ctx.setTransform(1,0,0,1,0,0),this.g.ctx.font="10pt monospace",this.g.ctx.fillStyle="black",this.g.ctx.fillText("FPS: "+Hal.fps,0,10),this.g.ctx.fillText("Num of entities: "+this.entities.length,0,25),this.g.ctx.fillText("Zoom: "+this.camera.zoom,0,40),this.g.ctx.fillText("Mouse: "+this.mpos[0]+", "+this.mpos[1],0,55),this.g.ctx.fillText("Camera pos: "+this.camera.x+", "+this.camera.y,0,70),this.g.ctx.fillText("World pos: "+this.world_pos[0]+", "+this.world_pos[1],0,85),this.g.ctx.fillText("Center relative pos: "+(this.mpos[0]-this.camera.cx-this.bounds[0])+", "+(this.mpos[1]-this.camera.cy-this.bounds[1]),0,100)},u.prototype.removeEntity=function(e){var t;if(!this.ent_cache[e.id]){log.error("No such entity "+e.id+" in cache");return}t=this.entities.indexOf(e);if(t===-1){log.error("No such entity "+e.id+" in entity list");return}return delete this.ent_cache[e.id],this.trigger("ENTITY_DESTROYED",e),this.entities.splice(t,1)},u.prototype.getAllEntities=function(){return this.entities.slice()},u.prototype.removeAllEntities=function(){var e,t,n,r;r=this.getAllEntities();for(t=0,n=r.length;t<n;t++)e=r[t],e.destroy(!1)},u.prototype.removeEntityByID=function(e){var t;return t=this.ent_cache[e],t!=null?t.removeEntity(t):log.error("No such entity "+e+" in entity cache")},u.prototype.update=function(){},u.prototype.draw=function(){if(this.paused)return;return this.g.ctx.fillStyle=this.bg_color,this.g.ctx.fillRect(0,0,this.bounds[2],this.bounds[3])},u.prototype.drawQuadSpace=function(e){if(this.paused)return;e.nw!=null&&(this.drawQuadSpace(e.nw),this.g.ctx.strokeRect(e.nw.bounds[0],e.nw.bounds[1],e.nw.bounds[2],e.nw.bounds[3])),e.ne!=null&&(this.drawQuadSpace(e.ne),this.g.ctx.strokeRect(e.ne.bounds[0],e.ne.bounds[1],e.ne.bounds[2],e.ne.bounds[3])),e.sw!=null&&(this.drawQuadSpace(e.sw),this.g.ctx.strokeRect(e.sw.bounds[0],e.sw.bounds[1],e.sw.bounds[2],e.sw.bounds[3]));if(e.se!=null)return this.drawQuadSpace(e.se),this.g.ctx.strokeRect(e.se.bounds[0],e.se.bounds[1],e.se.bounds[2],e.se.bounds[3])},u.prototype.calcLocalMatrix=function(){return this.local_matrix=i.mul(this.localMatrix(),this.rotationMatrix())},u.prototype.pause=function(){return this.attr("paused",!0)},u.prototype.resume=function(){return this.attr("paused",!1)},u.prototype.init=function(){var e=this;return this.paused=!1,this.addCamera(),this.calcLocalMatrix(),this.on("CHANGE",function(e){e&&e[0]==="draw_quadspace"}),this.cam_change=this.camera.on("CHANGE",function(){if(e.paused)return;return e.calcLocalMatrix(),e.update_clip=!0}),this.resize_event=Hal.on("RESIZE",function(t){return e.g.resize(t.width,t.height),e.bounds[2]=t.width,e.bounds[3]=t.height,e.camera.resize(t.width,t.height)}),this.exit_frame=Hal.on("EXIT_FRAME",function(){if(e.paused)return;e.draw_camera_center&&(e.g.ctx.setTransform(1,0,0,1,0,0),e.g.ctx.translate(e.camera.cx,e.camera.cy),e.g.strokeRect([-3,-3,6,6],"white"),e.g.ctx.lineWidth=5,e.g.strokeRect([-e.camera.w2,-e.camera.h2,e.camera.w,e.camera.h],"white"),e.g.ctx.translate(-e.camera.cx,-e.camera.cy),e.g.ctx.lineWidth=1);if(e.draw_stat)return e.drawStat()}),this.on("ENTITY_MOVING",function(e){return Hal.math.isPointInRect(e.viewportPos(),e.quadspace.bounds)||(log.debug("i'm out of my quadspace "+e.id),e.quadspace.remove(e),this.quadspace.insert(e)),this.camera.trigger("CHANGE"),this.calcLocalMatrix()})},u}(e),u})}.call(this),function(){define("dommanager",[],function(){var e;return e=function(){function e(e){var t=this;this.renderspace=document.getElementById("renderspace"),this.hud=document.getElementById("hud"),this.viewport=document.getElementById("viewport"),this.area=renderspace.getBoundingClientRect(),this.current_zindex=1e3,this.canvases=[],this.in_fullscreen=!1,this.screen_w=window.screen.availWidth,this.screen_h=window.screen.availHeight,this.fullscreen_scale=[1,1],e.on("SUPPORTS_FULLSCREEN",function(){return document.body.mozRequestFullScreen||document.body.webkitRequestFullScreen||document.body.requestFullScreen}),e.on("FULLSCREEN_CHANGE",function(n){var r,i,s,o;if(n){e.r.resize(t.screen_w/t.fullscreen_scale[0],t.screen_h/t.fullscreen_scale[1]),s=t.canvases;for(i in s)r=s[i],r.setAttribute("style",(r.getAttribute("style")||"")+" "+"-webkit-transform: scale3d("+t.fullscreen_scale[0]+","+t.fullscreen_scale[1]+", 1.0); -webkit-transform-origin: 0 0 0;");return t.area=t.renderspace.getBoundingClientRect(),e.scm.enterFullScreen(t.fullscreen_scale)}t.renderspace.style.width=e.r.prev_bounds[2]+"px",t.renderspace.style.height=e.r.prev_bounds[3]+"px",e.r.resize(e.r.prev_bounds[2],e.r.prev_bounds[3]),o=t.canvases;for(i in o)r=o[i],r.setAttribute("style",(r.getAttribute("style")||"")+" "+"-webkit-transform: scale3d(1.0, 1.0, 1.0); -webkit-transform-origin: 0 0 0;");return t.area=t.renderspace.getBoundingClientRect(),e.scm.exitFullScreen([1,1])}),e.on("DOM_ADD",function(e){if(e!=null)return e.call(null,t.hud)}),window.addEventListener("resize",function(){return t.area=t.renderspace.getBoundingClientRect(),t.screen_w=window.screen.availHeight,t.screen_h=window.screen.availHeight,e.trigger("RESIZE",t.area)}),document.addEventListener("fullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,e.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)},!1),document.addEventListener("webkitfullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,e.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)},!1),document.addEventListener("mozfullscreenchange",function(){return this.in_fullscreen=!this.in_fullscreen,e.trigger("FULLSCREEN_CHANGE",this.in_fullscreen)},!1),e.on("REQUEST_FULLSCREEN",function(n){if(!e.supports("FULLSCREEN")){log.warn("Fullscreen not supported");return}if(!t.in_fullscreen)return t.renderspace.style.width=t.screen_w+"px",t.renderspace.style.height=t.screen_h+"px",t.renderspace.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)})}return e}(),e.prototype.createCanvas=function(e,t){var n;return e==null&&(e=this.area.width),t==null&&(t=this.area.height),n=document.createElement("canvas"),n.width=e,n.height=t,n},e.prototype.createCanvasLayer=function(e,t,n){var r,i;return e==null&&(e=this.area.width),t==null&&(t=this.area.height),i=this.current_zindex+n,this.canvases[i]?this.canvases[i]:(r=this.createCanvas(e,t),r.style["z-index"]=i,r)},e.prototype.addCanvas=function(e,t,n,r){var i;t==null&&(t=0),n==null&&(n=0),i=e.style["z-index"];if(this.canvases[i])return;return e.style.left=t+"px",e.style.top=n+"px",r||(e.style["background-color"]="white"),this.viewport.appendChild(e),this.canvases[i]=e},e})}.call(this),function(){define("mathutil",["vec2"],function(e){var t,n;return t={MAT_ARRAY:typeof Float32Array!="undefined"?Float32Array:Array,epsilon:1e-6},t.createRegularon=function(e,t){var n,r,i,s,o,u,a,f;i=[],r=Math.PI*2/e,n=0;for(s=a=0,f=e-1;0<=f?a<=f:a>=f;s=0<=f?++a:--a)o=t*Math.cos(n),u=t*Math.sin(n),i.push([o,u]),n+=r;return i},t.clamp=function(e,t,n){return e<t&&(e=t),e>n&&(e=n),e},t.toDegrees=function(e){return e*180/Math.PI},t.isPointInRect=function(e,t){return e[0]>=t[0]&&e[0]<=t[0]+t[2]&&e[1]>=t[1]&&e[1]<=t[1]+t[3]},t.isRectInRect=function(e,t){return e[0]>=t[0]&&e[1]>=t[1]&&e[0]+e[2]<=t[0]+t[2]&&e[1]+e[3]<=t[1]+t[3]},t.rectIntersectsRect=function(e,t){return e[0]<t[0]+t[2]&&e[0]+e[2]>t[0]&&e[1]<t[1]+t[3]&&e[3]+e[1]>t[1]},t.createRectPolygon=function(e,t,n,r){return[[e,t],[e+n,t],[e+n,t+r],[e,t+r]]},t.doLinesIntersect=function(e,t,n,r){var i,s,o,u,a,f;return u=(e[1]-n[1])*(r[0]-n[0])-(e[0]-n[0])*(r[1]-n[1]),f=(e[1]-n[1])*(t[0]-e[0])-(e[0]-n[0])*(t[1]-e[1]),i=(t[0]-e[0])*(r[1]-n[1])-(t[1]-e[1])*(r[0]-n[0]),i===0?!1:(s=1/i,o=u*s,a=f*s,o>0&&o<1&&a>0&&a<1?!0:!1)},t.isPointInPoly=function(e,t){var n,r,i,s,o,u,a;n=[-1e4,e[1]],r=e,i=0,o=t.length;for(s=u=0,a=o-1;0<=a?u<=a:u>=a;s=0<=a?++u:--u)this.doLinesIntersect(n,r,t[s],t[(s+1)%o])&&i++;return i%2!==0},t.projectPointOnLine=function(t,n,r){var i,s,o,u,a;return o=e.sub([],r,n),u=e.sub([],t,n),e.normalize(o,o),e.normalize(u,u),i=e.dot(u,o),s=e.distance(n,t),a=e.scale([],o,i*s),a=e.fromValues(n[0]+a[0],n[1]+a[1]),a},t.rectIntersectsCircle=function(e,t,n){return this.lineIntersectsCircle([[e[0],e[1]],[e[0]+e[2],e[1]]],t,n)||this.lineIntersectsCircle([[e[0]+e[2],e[1]],[e[0]+e[2],e[1]+e[3]]],t,n)||this.lineIntersectsCircle([[e[0]+e[2],e[1]+e[3]],[e[0],e[1]+e[3]]],t,n)||this.lineIntersectsCircle([[e[0],e[1]+e[3]],[e[0],e[1]]],t,n)},t.rectIntersectsOrHullsCircle=function(e,t,n){return this.rectIntersectsCircle(e,t,n)||this.isPointInRect(t,e)},t.lineIntersectsCircle=function(e,t,n){var r;return r=this.perpDistanceToSegment(t,e[0],e[1]),r<n},t.perpDistance=function(t,n,r){var i;return i=this.projectPointOnLine(t,n,r),e.distance(t,i)},t.perpDistanceToSegment=function(t,n,r){var i,s;return i=this.projectPointOnLine(t,n,r),s=e.distance(n,r),e.distance(n,i)>s||e.distance(r,i)>s?Number.NaN:e.distance(t,i)},t.isPointInCircle=function(e,t,n){var r,i,s;return i=e[0]-t[0],s=e[1]-t[1],r=Math.sqrt(i*i+s*s),r<n},n=function(e,t,n){var r,i,s;return e[0]>=0&&t[0]<0?!0:e[0]===0&&t[0]===0?e[1]>t[1]:(s=(e[0]-n[0])*(t[1]-n[1])-(t[0]-n[0])*(e[1]-n[1]),s<0?!0:s>0?!1:(r=(e[0]-n[0])*(e[0]-n[0])+(e[1]-n[1])*(e[1]-n[1]),i=(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1]),r>i))},t})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;define("deferredcounter",["deferred"],function(e){var r;return r=function(e){function r(e){this.total_trigs=e,this.num_approved=0,this.num_rejected=0,r.__super__.constructor.call(this)}return t(r,e),r.prototype.resolve=function(e,t){if(this.num_approved+this.num_rejected===this.total_trigs)return r.__super__.resolve.call(this,e,{num_approved:this.num_approved,num_rejected:this.num_rejected},t)},r.prototype.reject=function(e,t){r.__super__.reject.call(this,e,{num_approved:this.num_approved,num_rejected:this.num_rejected},t);if(this.num_approved+this.num_rejected===this.total_trigs)return this.resolve(e,t)},r.prototype.acquire=function(){var e,t;return t=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.num_rejected++,this.reject(t,e)},r.prototype.release=function(){var e,t;return t=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],this.num_approved++,this.resolve(t,e)},r}(e),r})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("domeventmanager",[],function(){var t;return t=function(){function t(){this.getMousePos=e(this.getMousePos,this),this.mouseDown=e(this.mouseDown,this),this.mouseUp=e(this.mouseUp,this),this.mouseMove=e(this.mouseMove,this),this.mouseClick=e(this.mouseClick,this),this.mouseDblClick=e(this.mouseDblClick,this),this.keyUp=e(this.keyUp,this),this.keyDown=e(this.keyDown,this),this.wheelMoved=e(this.wheelMoved,this),this.viewport=null,this.mouse_leftbtn_down=!1,this.mouse_rightbtn_down=!1,this.can_drag=!0,this.pos=[0,0],this.viewport=Hal.dom.hud,this.dragging=!1,this.under_dom=!1,this.viewport.addEventListener("mousedown",this.mouseDown),this.viewport.addEventListener("mouseup",this.mouseUp),this.viewport.addEventListener("mousemove",this.mouseMove),this.viewport.addEventListener("onmousewheel",this.wheelMoved),this.viewport.addEventListener("onContextMenu",function(){return!1}),this.viewport.addEventListener("mousewheel",this.wheelMoved),this.viewport.addEventListener("click",this.mouseClick),this.viewport.addEventListener("dblclick",this.mouseDblClick),window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp)}return t.prototype.wheelMoved=function(e){return this.getMousePos(e),Hal.trigger("SCROLL",{down:e.wheelDelta<0,pos:this.pos})},t.prototype.keyDown=function(e){return Hal.trigger("KEY_DOWN",e)},t.prototype.keyUp=function(e){return Hal.trigger("KEY_UP",e)},t.prototype.mouseDblClick=function(e){return this.getMousePos(e),Hal.trigger("LEFT_DBL_CLICK",this.pos)},t.prototype.mouseClick=function(e){if(this.under_dom)return;return this.getMousePos(e),Hal.trigger("MOUSE_CLICK",this.pos)},t.prototype.mouseMove=function(e){this.under_dom=this.viewport.querySelectorAll(":hover").length>0;if(this.under_dom)return;this.getMousePos(e),Hal.trigger("MOUSE_MOVE",this.pos);if(this.mouse_leftbtn_down&&!this.dragging&&this.can_drag)return Hal.trigger("DRAG_STARTED",this.pos),this.dragging=!0,this.can_drag=!1},t.prototype.mouseUp=function(e){if(this.under_dom){this.mouse_leftbtn_down=!1;return}this.getMousePos(e),this.dragging&&(this.dragging=!1,Hal.trigger("DRAG_ENDED",this.pos),this.can_drag=!0);if(this.mouse_rightbtn_down&&!this.dragging)return Hal.trigger("RIGHT_CLICK",this.pos),this.mouse_rightbtn_down=!1;if(this.mouse_leftbtn_down&&!this.dragging)return Hal.trigger("LEFT_CLICK",this.pos),this.mouse_leftbtn_down=!1},t.prototype.mouseDown=function(e){if(this.under_dom){this.mouse_leftbtn_down=!1;return}this.getMousePos(e);if(e.button===0)return this.mouse_leftbtn_down=!0;if(e.button===2)return this.mouse_rightbtn_down=!0},t.prototype.getMousePos=function(e){return this.pos[0]=e.clientX-Hal.dom.area.left,this.pos[1]=e.clientY-Hal.dom.area.top},t}(),t})}.call(this),function(){var e=[].slice;define("ajax",[],function(){var t,n;return n=function(){function e(e){this.url=e,this.success_=this.fail_=this.always_=Function(),this.success=function(e){return this.success_=e,this},this.fail=function(e){return this.fail_=e,this},this.always=function(e){return this.always_=e,this}}return e}(),t=new Object,t.get=function(){var t,r,i,s,o;return o=arguments[0],i=arguments[1],r=3<=arguments.length?e.call(arguments,2):[],s=new n(document.domain+"/"+o),t=new XMLHttpRequest,t.open("GET",""+o+"?"+i),t.send(),t.onreadystatechange=function(){var e;if(t.readyState===4){e=t.getResponseHeader("Content-Type"),t.status===200?(i=t.responseText,e==="application/json"&&o.indexOf("json")===-1&&(i=JSON.parse(i)),s.success_(i),r[0]&&r[0](i)):(s.fail_(t.responseText),r[1]&&r[1](i)),s.always_(o||i);if(r[2])return r[2](i)}},s},t.post=function(){var t,r,i,s,o;return o=arguments[0],i=arguments[1],r=3<=arguments.length?e.call(arguments,2):[],s=new n(document.domain+"/"+o),t=new XMLHttpRequest,t.open("POST",o),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(i),t.onreadystatechange=function(){var e;if(t.readyState===4){e=t.getResponseHeader("Content-Type"),t.status===200?(i=t.responseText,e==="application/json"&&(i=JSON.parse(i)),s.success_(i),r[0]&&r[0](i)):(s.fail_(t.responseText),r[1]&&r[1](i)),s.always_(o||i);if(r[2])return r[2](i)}},s},window.ajx=t})}.call(this),function(){define("sprite",[],function(){var e;return e=function(){function e(e,t,n,r,i,s){var o;this.img=e,this.x=n,this.y=r,this.w=i,this.h=s,o=this.img.src.match(/\/assets\/sprites\/(.*\/)(.*)\.png/),this.name=o&&o[2]?o[2]:"",this.w2=this.w*.5,this.h2=this.h*.5,this.folder=o&&o[1]?o[1]:"",this.onLazyLoad=null}return e.prototype.changeSprite=function(e){this.img=e.img,this.name=e.name,this.x=e.x,this.y=e.y,this.w=e.w,this.h=e.h,this.folder=e.folder,this.w2=e.w2,this.h2=e.h2;if(this.onLazyLoad!=null)return this.onLazyLoad()},e.prototype.getName=function(){return this.folder+this.name},e}(),e})}.call(this),function(){define("imgutils",[],function(){var e;return e=function(){function e(){this.hit_ctx=this.createCanvas(1,1).getContext("2d"),this.tint_ctx=this.createCanvas(800,600).getContext("2d")}return e.prototype.createCanvas=function(e,t){var n;return n=document.createElement("canvas"),n.width=e,n.height=t,n},e.prototype.clipImage=function(e,t){var n,r;return n=this.createCanvas(t.w,t.h),r=n.getContext("2d"),r.drawImage(e,t.x,t.y,t.w,t.h,0,0,t.w,t.h),e=new Image,e.src=n.toDataURL("image/png"),e},e.prototype.isTransparent=function(e,t,n){var r;return this.hit_ctx.drawImage(e,t,n,1,1,0,0,1,1),r=this.hit_ctx.getImageData(0,0,1,1).data,r[3]===255},e.prototype.getPixelAt=function(e,t,n){var r,i,s;return r=this.hit_canvas.getContext("2d"),r.drawImage(e,t,n,1,1,0,0,1,1),i=r.getImageData(0,0,1,1).data,s=(t+n)*4,[i[s],i[s+1],i[s+2],i[s+3]]},e.prototype.tintImage=function(e,t,n){var r,i;return r=this.createCanvas(e.width,e.height),i=r.getContext("2d"),i.globalAlpha=1,i.drawImage(e,0,0),i.globalAlpha=n,i.globalCompositeOperation="source-atop",i.fillStyle=t,i.fillRect(0,0,e.width,e.height),r},e}(),e})}.call(this),function(){define("spritefactory",["sprite","imgutils"],function(e,t){var n;return n={},n.clipFromSpriteSheet=function(n,r,i){return new e(t.clipImage(n,i),r,0,0,i.w,i.h)},n.fromSingleImage=function(t,n){return new e(t,n,0,0,t.width,t.height)},n.dummySprite=function(){var t;return t=new Image,t.src="",new e(t,"n/a",0,0,t.width,t.height)},n})}.call(this),function(){define("spritesheet",[],function(){var e;return e=function(){function e(e,t,n,r){var i;this.path=e,this.img=t,this.meta=n,this.sprites=r!=null?r:{},i=this.path.match(/.*\/(.*)\.json/),i&&i.length>0?this.name=i[1]:this.name=this.path}return e.prototype.addSprite=function(e){return this.sprites[e.name]=e},e}(),e})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define("assetmanager",["deferred","deferredcounter","ajax","spritefactory","sprite","spritesheet","eventdispatcher"],function(e,r,i,s,o,u,a){var f,l,c,h;return c="/assets/",h="http://localhost:8080",l=/^(.*)\.(.*)$/,f=function(e){function n(){n.__super__.constructor.call(this),this.assets={sprites:{},spritesheets:{},audio:{},animation:{}},this.tint_cache={},this.wait_queue=[]}return t(n,e),n}(a),f.prototype.setResourcesRelativeURL=function(e){return c=e},f.prototype.resolvePath=function(e){var t,n,r,i,s,o,u;n=e.split("/");if(this.assets.hasOwnProperty(n[0])){i=this.assets[n[0]],u=n.slice(1,+(n.length-2)+1||9e9);for(s=0,o=u.length;s<o;s++)t=u[s],i.hasOwnProperty(t)||(i[t]={}),i=i[t]}return r=n[n.length-1],r=r.substring(0,r.lastIndexOf(".")),[i,r]},f.prototype.addToStorage=function(e,t){var n,r,i;return i=this.resolvePath(e),r=i[0],n=i[1],r[n]=t,r[n]},f.prototype.deleteFromStorage=function(e){var t,n,r;return r=this.resolvePath(e),n=r[0],t=r[1],n[t]=null,delete n[t]},f.prototype.loadImage=function(t){var n,r,i=this;return n=new e,r=new Image,r.src=t,r.onload=function(){return n.resolve(r,r)},r.onerror=function(){return n.reject(r,t)},n.promise()},f.prototype.loadImages=function(e){var t,n,i,s;t=new r(e.length);for(i=0,s=e.length;i<s;i++)n=e[i],this.loadImage(n).then(function(e){return t.release(this,e)}).fail(function(e){return t.acquire(this,e)});return t.promise()},f.prototype.tint=function(e,t){var n;return n=e.folder+e.name+t,this.tint_cache[n]||(this.tint_cache[n]=Hal.im.tintImage(e.img,t,.5)),this.tint_cache[n]},f.prototype.loadSprite=function(t){var n,r=this;return t=c+t,n=new e,this.loadImage(t).then(function(e){var i,o;return o=s.fromSingleImage(e,t),i=o.getName(),r.wait_queue[i]&&(log.debug(r.wait_queue[i]),r.wait_queue[i].changeSprite(o),delete r.wait_queue[t]),Hal.trigger("SPRITE_LOADED",o),n.resolve(r,o)}).fail(function(e){return n.reject(r,e)}),n.promise()},f.prototype.loadAudio=function(t){var n,r;return r=new e,n=new Audio(t)},f.prototype.loadSound=function(t){var n;return t=c+t,n=new e,this.loadAudio()},f.prototype.addSprite=function(e){var t=this;return this.loadSprite(e).then(function(n){return t.addToStorage(e,n)})},f.prototype.addSound=function(e){var t=this;return this.loadSound(e).then(function(n){return t.addToStorage(e,n)})},f.prototype.resolveFolderPath=function(e){var t,n,r,i,s,o,u;n=e.split("/");if(this.assets.hasOwnProperty(n[0])){i=this.assets[n[0]];if(n.length>3){u=n.slice(1,+(n.length-3)+1||9e9);for(s=0,o=u.length;s<o;s++)t=u[s],i.hasOwnProperty(t)||(i[t]={}),i=i[t]}}return r=n[n.length-2],[i,r]},f.prototype.loadViaSocketIO=function(){var e=this;if(typeof io=="undefined"||io===null){log.error("Couldn't find socket.io library");return}return this.socket=io.connect(h),this.socket.on("connect",function(){return log.debug("connected")}),this.socket.on("LOAD_SPRITES",function(t){var n,r,i,s,o,u,a;s=JSON.parse(t.files),i=s.length,e.trigger("SPRITES_LOADING",i),a=[];for(r=o=0,u=s.length;o<u;r=++o)n=s[r],a.push(function(n,r){return e.addSprite(t.url+n).then(function(){e.trigger("SPRITE_LOADED",n);if(r>=i-1)return e.trigger("SPRITES_LOADED")})}(n,r));return a}),this.socket.on("LOAD_SOUNDS",function(t){var n,r,i,s,o,u,a;s=JSON.parse(t.files),i=s.length,e.trigger("SOUNDS_LOADING",i),a=[];for(r=o=0,u=s.length;o<u;r=++o)n=s[r],a.push(function(n,r){return e.addSound(t.url+n).then(function(){e.trigger("SOUND_LOADED");if(r>=i-1)return e.trigger("SOUNDS_LOADED")})}(n,r));return a}),this.socket.on("SPRITE_ADDED",function(t){return log.debug("sprite added"),log.debug(t),e.addSprite(t.url)}),this.socket.on("SPRITESHEET_ADDED",function(e){return log.debug(e)}),this.socket.on("SPRITE_DELETED",function(t){return log.debug("sprite deleted"),log.debug(t),e.deleteFromStorage(t.url)}),this.socket.on("SPRITE_FOLDER_DELETED",function(t){var n,r,i;return log.debug("sprite folder deleted"),log.debug(t),i=e.resolveFolderPath(t.url),r=i[0],n=i[1],delete r[n],e.trigger("SPRITES_LOADED")}),this.socket.on("SPRITE_FOLDER_ADDED",function(t){var n,r,i,s,o,u,a;log.debug("sprite folder added"),log.debug(t),i=t.files.length,e.trigger("SPRITES_LOADING"),u=t.files,a=[];for(r=s=0,o=u.length;s<o;r=++s)n=u[r],log.debug("file: "+n),a.push(function(n,r){return log.debug(t.url+n),e.addSprite(t.url+n).then(function(){e.trigger("SPRITE_LOADED",n);if(r>=i-1)return e.trigger("SPRITES_LOADED")})}(n,r));return a}),this.socket.on("SPRITESHEET_DELETED",function(e){return log.debug(e)})},f.prototype.loadSpritesFromFileList=function(e){var t=this;return i.get(e,function(e){var n,r,i,s,o,u;e=e.split("\n"),e.splice(-1),r=e.length,t.trigger("SPRITES_LOADING",r),u=[];for(n=s=0,o=e.length;s<o;n=++s)i=e[n],u.push(function(e,n){return t.addSprite(e).then(function(){t.trigger("SPRITE_LOADED",e);if(n>=r-1)return t.trigger("SPRITES_LOADED")})}(i,n));return u})},f.prototype.loadFromArray=function(e,t){var r;r=!e,n.call(this.assets,r)>=0},f.prototype.getSprite=function(e){var t,n,r;return r=this.resolvePath("sprites/"+e+"."),n=r[0],t=r[1],n[t]},f.prototype.getSpritesFromFolder=function(e){var t,n,r,i,s,o,u,a;if(e==="/")return this.getSpriteFolders();t=e.indexOf("/"),t===0&&(e=e.substring(t+1)),t=e.charAt(e.length-1),t!=="/"&&(e=""+e+"/"),i={},u=this.resolveFolderPath("sprites/"+e),s=u[0],r=u[1],a=s[r];for(n in a)o=a[n],o.img!=null&&(i[n]=o);return i},f.prototype.getSpriteFoldersFromFolder=function(e){var t,n,r,i,s,o,u,a;t=e.indexOf("/"),t===0&&(e=e.substring(t+1)),t=e.charAt(e.length-1),t!=="/"&&(e=""+e+"/"),i={},u=this.resolveFolderPath("sprites/"+e),s=u[0],r=u[1],a=s[r];for(n in a)o=a[n],o.img==null&&(i[n]=o);return i},f.prototype.getSpriteFolders=function(){return this.assets.sprites},f.prototype.waitFor=function(e,t){return this.wait_queue[t]=e},f})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("bboxalgos",["vec2"],function(e){var n,r,i,s,o,u,a,f;return n={polyBBoxFromSprite:function(e,t,n){return t==null&&(t=u),n==null&&(n=o),i(e,t,n)},rectBBoxFromSprite:function(e){return[-e.w*.5,-e.h*.5,e.w,e.h]},rectFromPolyShape:function(e){var t,n,r,i,s,o,u;r=Number.MAX_VALUE,i=Number.MAX_VALUE,t=-Number.MIN_VALUE,n=-Number.MIN_VALUE;for(o=0,u=e.length;o<u;o++)s=e[o],r=Math.min(s[0],r),i=Math.min(s[1],i),t=Math.max(s[0],t),n=Math.max(s[1],n);return[r,i,Math.abs(r)+t,Math.abs(i)+n]},circularBBoxFromSprite:function(e){var t;return t=Math.sqrt(e.w*e.w+e.h*e.h)*.5,[t]},rectIntersectsRect:function(e){return Hal.math.rectIntersectsRect(e,[this.pos[0],this.pos[1],this.bounds[2],this.bounds[3]])},rectIntersectsCircle:function(e){return Hal.math.rectIntersectsAndHullsCircle(e,this.pos,this.bounds[0])},rectBoundCheck:function(e){return Hal.math.isPointInRect(e,[this.pos[0],this.pos[1],this.bounds[2],this.bounds[3]])},circularBoundCheck:function(e){return Hal.math.isPointInCircle(e,this.pos,this.bounds[0])}},i=function(t,n,r){var i,s,o,u,a,f,l,c,h;c=[],h=t.w,f=t.h,i=Hal.dom.createCanvas(h,f),u=i.getContext("2d"),o=[],u.drawImage(t.img,0,0),l=u.getImageData(0,0,h,f),a=function(){var t,n,r,i,s,o,u,a,f,l,h,p,d,v,m,g;a=0,n=0,t=1/33;if(c.length<2)return void 0;for(l=m=0,g=c.length;m<g;l=++m){u=c[l],o=c[l+1];if(o==null)break;s=e.fromValues(u.x,u.y),h=e.fromValues(o.x,o.y),d=e.sub([],h,s);if(d!=null){p=c[l+2];if(p==null)break;v=e.sub([],h,e.fromValues(p.x,p.y))}if(d!=null&&v!=null){e.normalize(d,d),e.normalize(v,v),i=e.dot(d,v),a=n,n=e.dot(d,v),r=Math.abs(n-a);if(r>t)return f=[c[l+2].x-Hal.math.epsilon,c[l+2].y-Hal.math.epsilon],c.splice(0,l+2),f}}},c=new n(l.data,h,f);while(s=a())o.push(s);return log.debug("num criticals: "+o.length),new r(o)},s=function(){function e(e,t,n,r){return this.data=e!=null?e:[],this.width=t,this.height=n,this.sample_rate=r!=null?r:1,this.samplingFunc()}return e.prototype.samplingFunc=function(){return[]},e.prototype.getPixelAt=function(e,t){var n;return n=(e+this.width*t)*4,[this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]]},e}(),u=function(e){function n(){return a=n.__super__.constructor.apply(this,arguments),a}return t(n,e),n.prototype.samplingFunc=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;e=130,i=[];for(t=s=0,f=this.width-1,l=this.sample_rate;l>0?s<=f:s>=f;t=s+=l)for(n=o=0,c=this.height;0<=c?o<=c:o>=c;n=0<=c?++o:--o){r=this.getPixelAt(t,n);if(r[3]>e){i.push({x:t,y:n});break}}for(t=u=0,h=this.width-1,p=this.sample_rate;p>0?u<=h:u>=h;t=u+=p)for(n=a=d=this.height;a>=0;n=a+=-1){r=this.getPixelAt(t,n);if(r[3]>e){i.unshift({x:t,y:n});break}}return i},n}(s),r=function(){function e(e){return this.downsamplingFunc(e)}return e.prototype.downsamplingFunc=function(){return[]},e}(),o=function(e){function n(){return f=n.__super__.constructor.apply(this,arguments),f}return t(n,e),n.prototype.downsamplingFunc=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;r=3,l=e[0],n=e[e.length-1],o=0,s=0,u=[];if(e.length<2)return e;for(i=c=1,h=e.length-2;1<=h?c<=h:c>=h;i=1<=h?++c:--c)t=Hal.math.perpDistance(e[i],l,n),t>o&&(s=i,o=t);return o>r?(a=this.downsamplingFunc(e.slice(0,+s+1||9e9)),f=this.downsamplingFunc(e.slice(s,+(e.length-1)+1||9e9)),a=a.slice(0,a.length-1),u=a.concat(f)):(u.push(e[0]),u.push(e[e.length-1])),u},n}(r),n})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("entity",["halalentity","scene","matrix3","bboxalgos","vec2"],function(e,n,r,i,s){var o;return o=function(e){function o(e){e==null&&(e={}),o.__super__.constructor.call(this),this.id=Hal.ID(),this.shape=e.shape!=null?e.shape:[[0,0],[0,1],[1,1],[1,0]],this.x=e.x!=null?e.x:0,this.y=e.y!=null?e.y:0,this.angle=e.angle!=null?e.angle:0,this.scale=e.scale!=null?e.scale:1,this.stroke_color=e.stroke_color!=null?e.stroke_color:"black",this.glow=e.glow!=null?e.glow:!1,this.glow_color=e.glow_color!=null?e.glow_color:"blue",this.glow_amount=e.glow_amount!=null?e.glow_amount:16,this.line_width=e.line_width!=null?e.line_width:1,this.draw_shape=e.draw_shape!=null?e.draw_shape:!0,this.opacity=e.opacity!=null?e.opacity:1,this.parent=null,this.world_pos=[0,0],this.quadspace=null,this.needs_updating=!0,this.draw_origin=!1,this.local_matrix=this.localMatrix(),this.bbox=i.rectFromPolyShape(this.shape),this.children=[],this.shapes=[],this.drawables=[],this.scene=null,this.selected_color="white",this.unselected_color=this.stroke_color,this.on("CHANGE",function(e){var t,n,r,s,o,u;n=e[0];if(n==="angle"||n==="scale"||n==="x"||n==="y"||n==="glow"||n==="parent"||n==="line_width"||n==="h")this.needs_updating=!0;n==="shape"&&this.sprite==null&&(this.bbox=i.rectFromPolyShape(this.shape),this.needs_updating=!0);if(n==="x"||n==="y")if(this.parent!=null&&this.quadspace!=null){this.parent.trigger("ENTITY_MOVING",this),o=this.children,u=[];for(r=0,s=o.length;r<s;r++)t=o[r],u.push(this.parent.trigger("ENTITY_MOVING",t));return u}}),this.on("ENTITY_ADDED",function(){return this.init()})}return t(o,e),o.prototype.localMatrix=function(){return[this.scale,0,this.x,0,this.scale,this.y,0,0,1]},o.prototype.rotationMatrix=function(){return[Math.cos(this.angle),-Math.sin(this.angle),0,Math.sin(this.angle),Math.cos(this.angle),0,0,0,1]},o.prototype.init=function(){var e=this;return this.parent instanceof n&&this.parent.camera.on("CHANGE",function(){return e.needs_updating=!0}),this.on("EXIT_FRAME",function(){return this.scene.g.ctx.setTransform(1,0,0,1,0,0)}),this.on("LEFT_CLICK",function(e){return this.selected=!this.selected,this.selected?this.trigger("SELECTED"):this.trigger("DESELECTED"),log.debug("yay, i've been selected: "+this.id)})},o.prototype.viewportPos=function(){var e;return e=r.transpose([],this.local_matrix),s.transformMat3([],[0,0],e)},o.prototype.worldPos=function(){return this.localToWorld([this.x,this.y])},o.prototype.localToWorld=function(e){var t;return t=r.transpose([],this.local_matrix),s.transformMat3([],e,t)},o.prototype.worldToLocal=function(e){return s.transformMat3([],e,r.transpose([],r.invert([],this.local_matrix)))},o.prototype.addEntity=function(e){return this.children.push(e),this.scene.addEntity(e),this.trigger("CHILD_ENTITY_ADDED",e),e.attr("scene",this.scene),e.attr("parent",this)},o.prototype.addEntityToQuadspace=function(e){return this.children.push(e),this.scene.addEntityToQuadspace(e),this.trigger("CHILD_ENTITY_ADDED",e),e.attr("scene",this.scene),e.attr("parent",this),e},o.prototype.destroy=function(e){return e==null&&(e=!0),this.removeAll(),this.scene.removeEntity(this),e&&this.destroyChildren(),this.children=null,this.drawables=null,this.parent=null,this.quadspace==null?log.warn("this entity had no quadspace"):this.quadspace.remove(this),this.quadspace=null,this.scene=null,this.trigger("ON_DESTROY")},o.prototype.destroyChildren=function(){var e,t,n,r,i;r=this.children,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.destroy());return i},o.prototype.update=function(e){this.scene.g.ctx.setTransform(this.local_matrix[0],this.local_matrix[3],this.local_matrix[1],this.local_matrix[4],this.local_matrix[2],this.local_matrix[5]);if(this.needs_updating){this.local_matrix=r.mul(this.rotationMatrix(),this.localMatrix()),this.local_matrix=r.mul(this.local_matrix,this.parent.local_matrix),this.needs_updating=!1;if(!this.glow)return this.scene.g.ctx.shadowBlur=0}},o.prototype.addDrawable=function(e){return this.drawables.push(e)},o.prototype.addShape=function(e){return this.shapes.push(e)},o.prototype.draw=function(e){var t,n,r,i,s,o,u,a;this.scene.g.ctx.globalAlpha=this.opacity,this.draw_shape&&this.line_width>1&&(this.scene.g.ctx.lineWidth=this.line_width),this.glow&&(this.scene.g.ctx.shadowBlur=this.glow_amount,this.scene.g.ctx.shadowColor=this.glow_color),this.draw_shape&&this.scene.g.strokePolygon(this.shape,this.selected?this.selected_color:this.stroke_color),this.glow&&(this.scene.g.ctx.shadowBlur=0),this.line_width!==1&&this.draw_shape&&(this.scene.g.ctx.lineWidth=1),this.draw_origin&&(this.scene.g.drawLine(0,0,0,-100,"green"),this.scene.g.drawLine(-50,0,50,0,"green")),this.draw_bbox&&this.scene.g.strokeRect(this.bbox,"cyan"),o=this.drawables;for(n=0,i=o.length;n<i;n++)t=o[n],t.call(this,e);u=this.shapes,a=[];for(r=0,s=u.length;r<s;r++)t=u[r],a.push(this.scene.g.strokePolygon(t,"blue"));return a},o}(e),o})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("spriteentity",["entity","bboxalgos","spritefactory"],function(e,n,r){var i;return i=function(e){function i(e){var t=this;i.__super__.constructor.call(this,e),this.sprite=Hal.asm.getSprite(e.sprite),this.visible_sprite=e.visible_sprite!=null?e.visible_sprite:!0,this.h=e.height!=null?e.height:0,this.w=e.width!=null?e.width:0,this.sprite==null?(this.sprite=r.dummySprite(),Hal.asm.waitFor(this.sprite,e.sprite)):this.calcShapeAndBBox(),this.sprite.onLazyLoad=function(){return t.calcShapeAndBBox()}}return t(i,e),i.prototype.init=function(){return i.__super__.init.call(this)},i.prototype.inShapeBounds=function(e){return e=this.worldToLocal(this.scene.localToWorld(e)),Hal.math.isPointInRect(e,this.bbox)&&!Hal.im.isTransparent(this.sprite.img,e[0]+this.bbox[2]*.5,e[1]+this.bbox[3]*.5)?!0:!1},i.prototype.calcShapeAndBBox=function(){return this.attr("bbox",n.rectBBoxFromSprite(this.sprite))},i.prototype.draw=function(){i.__super__.draw.call(this);if(this.visible_sprite)return this.scene.g.drawSprite(this.sprite,this.w,this.h)},i}(e),i})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("tilemanager",["spriteentity"],function(e){var n,r,i;return n=function(e){function n(e){n.__super__.constructor.call(this,e),this.row=e.row,this.col=e.col,this.layers=[null,null,null,null,null]}return t(n,e),n.prototype.addTileLayer=function(e,t){var n,r;t=t||e.layer,r=this.layers[t]!=null;if(r&&this.layers[t].name===e.name){log.debug("You're trying to add the same layer");return}return r&&this.layers[t].destroy(),this.layers[t]=e,n=this.addEntityToQuadspace(e),n.attr("shape",this.shape),n.attr("draw_shape",!1)},n.prototype.update=function(e){var t,r,i,s,o;n.__super__.update.call(this,e),s=this.layers,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],t!=null?o.push(t.update(e)):o.push(void 0);return o},n.prototype.draw=function(e){var t,r,i,s,o;n.__super__.draw.call(this,e),s=this.layers,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],t!=null?o.push(t.draw(e)):o.push(void 0);return o},n}(e),r=function(e){function n(e){n.__super__.constructor.call(this,e),this.name=e.name!=null?e.name:""+this.id,this.layer=e.layer!=null?e.layer:0,this.on("SELECTED",function(){return this.attr("glow",!0),this.attr("glow_color","blue"),this.attr("draw_shape",!0),this.attr("stroke_color","white"),Hal.tween(this,"line_width",200,1,14.5,5)}),this.on("DESELECTED",function(){return this.attr("line_width",1),this.attr("glow",!1),this.attr("draw_shape",!1)})}return t(n,e),n.prototype.destroy=function(e){return e==null&&(e=!0),log.debug("destroying myself"),log.debug(this),this.parent.layers[this.layer]=null,n.__super__.destroy.call(this,e)},n}(e),i=function(){function e(e,t,n){var r=this;this.tilew=e,this.tileh=t,n==null&&(n=""),this.TilesByID={},this.TilesByName={},this._id=0,Hal.on("TILE_MNGR_NEW_TILE",function(e){return r.add(e)}),Hal.on("TILE_MNGR_LOAD_TILES",function(e){return r.load(e)})}return e.prototype.loadFromList=function(e){var t,n,r,i,s=this;e==null&&(e="assets/TilesList.list"),Ajax.get("assets/amjad/TilesList.json",function(e){}),log.debug("TileManager loaded tiles."),r=JSON.parse(r),i=[];for(t in r)n=r[t],i.push(this.add(n));return i},e.prototype.load=function(e){var t,n,r;log.debug("Loading tiles..."),log.debug(e),r=[];for(t in e)n=e[t],r.push(this.add(n));return r},e.prototype.add=function(e){return e.id=++this._id,this.TilesByName[e.name]=e,this.TilesByID[e.id]=e},e.prototype.removeByName=function(e){var t;return t=this.TilesByName[e],delete this.TilesByID[t.id],delete this.TilesByName[t.name],t=null},e.prototype.newTileLayer=function(e){return new r(e)},e.prototype.newTileHolder=function(e){return new n(e)},e.prototype.addTileLayerToHolder=function(e,t,n){if(e==null||t==null){log.debug("holder or tile is null");return}return e.addTileLayer(t,n)},e}()})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("isometricmap",["scene","spriteentity","entity","tilemanager"],function(e,n,r,i){var s;return s=function(e){function n(e){var t,r,s,o,u,a,f=this;this.tilew=e.tilew,this.tileh=e.tileh,this.nrows=e.rows,this.ncols=e.cols,this.tm=new i(this.tilew,this.tileh),this.tilew2prop=2/this.tilew,this.tileh2prop=2/this.tileh,this.tilew2=this.tilew/2,this.tileh2=this.tileh/2,this.map=[],this.total_rendered=0,this.translate_x=0,this.max_rows=this.nrows-1,this.max_cols=this.ncols-1,this.selected_tile=null,this.old_camx=0,this.supported_modes={"mode-default":function(){f.processMouseClick()},"mode-erase":function(){f.processMouseClick();if(f.clicked_layer==null||f.clicked_layer.animating)return;return f.clicked_layer.tween({attr:"h",from:0,to:100,duration:500}).tween({attr:"opacity",from:1,to:0,duration:700}).done(function(){return this.destroy()}),f.clicked_layer=null},"mode-place":function(){f.tm.addTileLayerToHolder(f.tile_under_mouse,f.tm.newTileLayer(f.selected_tile))}},this.camera_moved=!1,this.current_mode=this.supported_modes["mode-default"],e.cam_bounds=[this.tilew2,this.tileh2,this.ncols*this.tilew2,(this.nrows-.5)*this.tileh],n.__super__.constructor.call(this,e),this.iso_shape=[[-this.tilew2,0],[0,this.tileh2],[this.tilew2,0],[0,-this.tileh2]],this.display={startr:0,endr:0,startc:0,endc:0},this.info={row:"row: ",col:"col: ",tilename:"tile: ",start_row:"starting row: ",start_col:"staring col: ",end_row:"end row: ",end_col:"end_col: ",tile_x:"tile_x: ",tile_y:"tile_y: ",num_rendering:"no. rendereded entities: ",cam_mouse:"camera_mouse: "},this.mask=Hal.asm.getSprite("test/tilemask_128x64"),t=Hal.dom.createCanvas(this.tilew,this.tileh).getContext("2d"),t.drawImage(this.mask.img,0,0),this.mask_data=t.getImageData(0,0,this.tilew,this.tileh).data,a=this.mask_data;for(s=o=0,u=a.length;o<u;s=++o)r=a[s],this.mask_data[s]=r<120;this.over={green:Hal.asm.getSprite("test/grid_unit_over_green_128x64"),red:Hal.asm.getSprite("test/grid_unit_over_red_128x64")},this.last_clicked_layer=null,this.tile_under_mouse=null,this.search_range=this.bounds[2]*.5}return t(n,e),n.prototype.showRegion=function(e,t,n){var r,i,s,o,u,a,f,l;s=this.getTileAt(this.worldToLocal(e));if(s==null)return;u=s.row,o=s.col,o%2===0&&(t-=1),f=this.getTile(Hal.math.clamp(u-t,u,this.nrows-1),Hal.math.clamp(o-n,o,this.ncols-1)),i=this.getTile(Hal.math.clamp(u+t,u,this.nrows-1),Hal.math.clamp(o+n,o,this.ncols-1)),l=this.getTile(Hal.math.clamp(u-t,u,this.nrows-1),Hal.math.clamp(o+n,o,this.ncols-1)),r=this.getTile(Hal.math.clamp(u+t,u,this.nrows-1),Hal.math.clamp(o-n,o,this.ncols-1));if(f==null||l==null||r==null||i==null)return;return a=[f.x-(l.x-f.x),f.y-(i.y-f.y),(l.x-f.x)*2,(i.y-f.y)*2],this.g.strokeRect(a,"cyan")},n.prototype.drawStat=function(){return n.__super__.drawStat.call(this),this.tile_under_mouse!=null&&(this.g.ctx.fillText(this.info.row+this.tile_under_mouse.row,0,195),this.g.ctx.fillText(this.info.col+this.tile_under_mouse.col,0,210),this.g.ctx.fillText(this.info.tile_x+this.tile_under_mouse.x,0,225),this.g.ctx.fillText(this.info.tile_y+this.tile_under_mouse.y,0,240)),this.g.ctx.fillText(this.info.start_row+this.display.startr,0,115),this.g.ctx.fillText(this.info.start_col+this.display.startc,0,130),this.g.ctx.fillText(this.info.end_row+this.display.endr,0,145),this.g.ctx.fillText(this.info.end_col+this.display.endc,0,160),this.g.ctx.fillText(this.info.num_rendering+this.total_rendered,0,175),this.g.ctx.fillText(this.info.cam_mouse+(""+(-this.camera.x+this.mpos[0])+", "+(-this.camera.y+this.mpos[1])),0,255)},n.prototype.init=function(){var e=this;return n.__super__.init.call(this),this.camera.on("CHANGE",function(){return e.calcDrawingArea()}),Hal.on("LEFT_CLICK",function(){return e.current_mode()}),Hal.on("EDITOR_MODE_CHANGED",function(t){return e.supported_modes[t]?e.current_mode=e.supported_modes[t]:log.warn("Mode "+t+" not supported"),log.debug(t)}),Hal.on("TILE_LAYER_SELECTED",function(t){return log.debug("Tile layer selected from editor"),log.debug(t),e.selected_tile=t}),Hal.on("RIGHT_CLICK",function(t){if(e.paused)return;return e.camera.lerpTo(e.localToWorld(e.world_pos))}),this.on("ENTITY_DESTROYED",function(t){var n;return n=e.map.indexOf(t),n===-1?log.debug("oh shit, no such entity "+t.id):e.map[n]=null}),Hal.on("MOUSE_MOVE",function(t){var n;n=e.getTileAt(e.worldToLocal(t));if(n!==e.tile_under_mouse){e.tile_under_mouse&&(e.tile_under_mouse.attr("line_width",1),e.tile_under_mouse.attr("glow",!1),e.tile_under_mouse.attr("draw_shape",!1)),e.tile_under_mouse=n;if(n!=null)return n.attr("glow",!0),n.attr("draw_shape",!0),n.attr("stroke_color","white"),Hal.tween(n,"line_width",400,1,3.5,1)}}),this.initMap()},n.prototype.draw=function(e){var t,r,i,s,o,u,a,f,l;if(this.paused)return;n.__super__.draw.call(this),this.total_rendered=0;for(t=s=u=this.display.startr,a=this.display.startr+this.display.endr;u<=a?s<=a:s>=a;t=u<=a?++s:--s)for(r=o=f=this.display.startc,l=this.display.endc+this.display.startc;f<=l?o<=l:o>=l;r=f<=l?++o:--o){i=this.map[r+t*this.ncols];if(i==null)continue;i.update(e),i.draw(e),this.total_rendered++}return this.camera_moved=!1,this.g.ctx.setTransform(this.local_matrix[0],this.local_matrix[3],this.local_matrix[1],this.local_matrix[4],this.local_matrix[2],this.local_matrix[5]),this.showRegion(this.mpos,3,3)},n.prototype.calcDrawingArea=function(){var e,t,n;return this.old_camx=this.camera.x,this.camera.x%this.tilew2===0&&(log.debug("oh jea"),this.camera_moved=!0),n=this.getTileAt(this.worldToLocal([0,0])),n==null?(e=0,t=0):(e=n.col,t=n.row),this.display={startc:e,endr:this.maxRows(),startr:t,endc:this.maxCols()}},n.prototype.maxRows=function(){return Math.min(this.nrows-1,Math.round(this.bounds[3]/(this.tileh*this.camera.zoom)+4))},n.prototype.maxCols=function(){return Math.min(this.ncols-1,Math.round(this.bounds[2]/(this.tilew2*this.camera.zoom)+4))},n.prototype.toOrtho=function(e){var t,n,r,i,s;return t=(e[0]+this.tilew2)*this.tilew2prop,i=(e[1]+this.tileh2)*this.tileh2prop,n=~~(e[0]+this.tilew2-~~(t*.5)*this.tilew),r=~~(e[1]+this.tileh2-~~(i*.5)*this.tileh),s=this.mask_data[(n+this.tilew*r)*4+3],[t-(s^!(t&1)),(i-(s^!(i&1)))/2]},n.prototype.getTile=function(e,t,n){return n==null&&(n=[0,0]),this.map[t+n[1]+(e+n[0])*this.ncols]},n.prototype.getTileAt=function(e){var t;return t=this.toOrtho(e),t[0]<0||t[1]<0||t[1]>=this.nrows||t[0]>=this.ncols?null:this.map[Math.floor(t[0])+Math.floor(t[1])*this.ncols]},n.prototype.initMap=function(){var e,t,n,r,i,s,o,u,a,f,l,c;this.clicked_layer=null,log.debug("max rows: "+this.maxRows()),log.debug("max cols: "+this.maxCols()),log.debug("total at this resolution: "+this.maxRows()*this.maxCols()),this.max_rows=this.maxRows(),this.max_cols=this.maxCols(),this.map=new Array(this.nrows*this.ncols),n=0,i=performance.now();for(e=a=0,l=this.nrows-1;0<=l?a<=l:a>=l;e=0<=l?++a:--a)for(t=f=0,c=this.ncols-1;0<=c?f<=c:f>=c;t=0<=c?++f:--f)o=t/2*this.tilew,u=(e+t%2/2)*this.tileh,r=this.tm.newTileHolder({shape:this.iso_shape,draw_shape:!1,x:o,y:u,row:e,col:t,visible_sprite:!0,sprite:"test/grid_unit_128x64"}),this.map[n]=this.addEntity(r),n++;return s=performance.now()-i,log.debug("it took: "+i),this.calcDrawingArea(),this.camera.trigger("CHANGE")},n.prototype.processMouseClick=function(){var e,t,n,r,i,s;this.clicked_layer!=null&&(this.clicked_layer.trigger("DESELECTED"),this.clicked_layer=null),t=performance.now(),e=this.quadspace.searchInRange(this.world_pos,this.search_range,this),n=performance.now()-t,log.info(n),log.info(e.length);for(i=0,s=e.length;i<s;i++){r=e[i];if(!r.inShapeBounds(this.world_pos))continue;log.debug(r),this.clicked_layer==null?this.clicked_layer=r:r.parent.col===this.clicked_layer.parent.col&&r.parent.row===this.clicked_layer.parent.row?r.layer>this.clicked_layer.layer&&(this.clicked_layer=r):r.parent.row===this.clicked_layer.parent.row?r.h+r.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=r):r.parent.col===this.clicked_layer.parent.col?r.h+r.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=r):r.parent.col!==this.clicked_layer.parent.col&&r.parent.row!==this.clicked_layer.parent.row&&r.h+r.y>this.clicked_layer.h+this.clicked_layer.y&&(this.clicked_layer=r)}if(this.clicked_layer!=null)return log.debug("clicked layer"),log.debug(this.clicked_layer),this.trigger("LAYER_SELECTED",this.clicked_layer),this.clicked_layer.trigger("LEFT_CLICK")},n.prototype.splitMap=function(){var e;return e={nw:null,ns:null,s:null,w:null,e:null,n:null,sw:null,se:null,c:null}},n.prototype.loadRandomMap=function(e,t){var n,r,i,s,o,u;u=[];for(e=s=0,o=this.ncols-1;0<=o?s<=o:s>=o;e=0<=o?++s:--s)u.push(function(){var t,s,o;o=[];for(n=t=0,s=this.nrows-1;0<=s?t<=s:t>=s;n=0<=s?++t:--t)i=this.getTile(e,n),r=5,o.push(function(){var e;e=[];while(r>0&&!i.isFull())this.addRandomLayer(i),e.push(--r);return e}.call(this));return o}.call(this));return u},n.prototype.addRandomLayer=function(e){var t,n,r,i,s,o,u;return u=Object.keys(this.tmngr.Tiles),r=~~(Math.random()*u.length),t=u[r],s=amj.tmngr.Tiles[t],o=Object.keys(s),n=~~(Math.random()*o.length),t=o[n],i=s[t]},n.prototype.genRandomMap=function(){},n}(e),s})}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define("halal",["eventdispatcher","scene","dommanager","renderer","mathutil","vec2","deferred","deferredcounter","domeventmanager","assetmanager","imgutils","entity","spriteentity","isometricmap"],function(e,n,r,i,s,o,u,a,f,l,c){var h,p,d,v,m,g,y,b,w,E,S,x,T;return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1)}}(),window.performance==null&&(window.performance=Date),d=performance.now(),v=0,b=1,p=0,y=0,E=0,x=0,g=30,w=1/g,m=null,S=!0,T=function(){var e,t,n,r;x=d,d=performance.now(),v=(d-x)*.001,p+=v,v=Math.min(v,w),Hal.trigger("ENTER_FRAME",v),r=Hal.scenes;for(t=0,n=r.length;t<n;t++)e=r[t],e.update(v),e.draw(v);return p>=b&&(Hal.fps=y,p=0,y=0,Hal.trigger("FPS_UPDATE",Hal.fps)),Hal.trigger("EXIT_FRAME",v),E=requestAnimFrame(T),y++},h=function(e){function n(){n.__super__.constructor.call(this),this.dom=new r(this),this.math=s,this.id=0,this.debug_mode=!1,this.pressed_keys=[],this.scenes=[],this.fps=0,log.debug("Engine constructed")}return t(n,e),n}(e),h.prototype.addScene=function(e){return e instanceof n?e.bounds?(e.name||(log.warn("Name for scene wasn't provided"),e.name="#scene_"+e.id),e.init(),Hal.trigger("SCENE_ADDED_"+e.name.toUpperCase(),e),this.scenes.unshift(e),log.debug("Added scene: "+e.name),e):(log.error("Bounds not set on scene "+e.name),null):(log.error("Not a Scene instance"),null)},h.prototype.pause=function(){return cancelAnimationFrame(E),S=!0,this.trigger("ENGINE_PAUSED")},h.prototype.resume=function(){return S=!1,T(),this.trigger("ENGINE_RESUMED")},h.prototype.viewportBounds=function(){return[0,0,this.dom.area.width,this.dom.area.height]},h.prototype.supports=function(e){return this.trigger("SUPPORTS_"+e)},h.prototype.init=function(){return this.evm=new f,this.on("MOUSE_MOVE",function(e){var t,n,r,i,s;i=this.scenes,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.mpos=e,s.push(t.world_pos=t.worldToLocal(e));return s}),this.on("DESTROY_SCENE",function(e){var t;return t=this.scenes.indexOf(e),t===-1&&log.error("No such scene: "+e.name),this.scenes[t]=null,this.scenes.splice(t,1)}),log.debug("Engine initialized")},h.prototype.start=function(){return this.init(),S=!1,this.trigger("ENGINE_STARTED"),log.debug("Engine started"),T()},h.prototype.isPaused=function(){return S},h.prototype.debug=function(e){this.debug_mode=e},h.prototype.ID=function(){return++this.id},h.prototype.drawInfo=function(){return this.glass.ctx.setTransform(1,0,0,1,0,0),this.glass.ctx.fillStyle="black",this.glass.ctx.fillText("FPS: "+this.fps,0,10)},h.prototype.tween=function(e,t,n,r,i,s){var o,a,f,l,c;return s==null&&(s=1),f=new u,n*=.001,a=0,l=(i-r)/n,c=r,Hal.on("ENTER_FRAME",o=function(u){a+=u,c+=l*u,e.attr(t,c),a=Math.min(a,n);if(n===a){s--,e.attr(t,i);if(s!==0)return a=0,c=r;f.resolve(e),Hal.remove("ENTER_FRAME",o)}}),f.promise()},h.prototype.tweenF=function(e,t,n,r,i){var s,o,u,a;i==null&&(i=1),e*=.001,o=0,u=(r-n)/e,a=n,Hal.on("ENTER_FRAME",s=function(f){o+=f,a+=u*f,t(a,f),o=Math.min(o,e);if(e===o){i--,t(r,f);if(i!==0)return o=0,a=n;Hal.remove("ENTER_FRAME",s)}})},h.prototype.fadeInViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},0,1)},h.prototype.fadeOutViewport=function(e){return this.tweenF(e,function(e){return Hal.dom.viewport.style.opacity=e},1,0)},h.prototype.IsometricMap=function(e){return new IsometricMap(e)},h.prototype.Keys={SHIFT:16,G:71,D:68,W:87,C:67,I:73,ONE:49,TWO:50,THREE:51,FOUR:52,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,F:70},window.Hal=new h,window.Hal.glass=new i(Hal.viewportBounds(),null,11),window.Hal.asm=new l,window.Hal.im=new c,window.Hal})}.call(this),function(){require.config({urlArgs:Math.random(),baseUrl:"src",paths:{loglevel:"../vendor/loglevel/dist/loglevel"},shim:{loglevel:{exports:"log"}}}),require(["halal"],function(e){return log.setLevel(log.levels.DEBUG),e})}.call(this),define("main",function(){});